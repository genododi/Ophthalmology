<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OphthalmoQA - Advanced Ophthalmology Question Generator</title>
    <!-- Tailwind CSS CDN - For development use only -->
    <!-- Development only: Tailwind CDN for rapid prototyping -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
    <!-- PDF.js for robust PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- JSZip for reading APKG files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- sql.js for SQLite database parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: {
                        primary: '#2c6fa5', // Main blue
                        secondary: '#73b1e6', // Lighter blue
                        accent: '#0d4c80', // Darker blue
                        light: '#f0f8ff', // Very light blue/background
                        dark: '#1a3e5a', // Dark blue for text/elements
                        success: '#10b981', // Green
                        warning: '#f59e0b', // Yellow/Orange
                        error: '#ef4444', // Red
                    }
                }
            }
        }
        
        // Initialize PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        }
        
        // Simple log function to replace debug console
        window.log = function(message, type = 'info') {
            switch (type) {
                case 'error': console.error(message); break;
                case 'warning': console.warn(message); break;
                case 'success': console.info('%c' + message, 'color: green'); break;
                default: console.log(message);
            }
        };
    </script>
    <style>
        /* Feedback UI Elements */
        .feedback-btn {
            transition: transform 0.2s ease, color 0.3s ease;
        }
        
        .feedback-btn:hover {
            transform: scale(1.2);
        }
        
        .feedback-btn.active {
            transform: scale(1.1);
        }
        
        .feedback-thank-you {
            animation: fadeInOut 3s ease forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* Enhanced feedback button animations */
        @keyframes feedbackPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1.15); }
        }
        
        /* Enhanced feedback button states */
        .feedback-btn {
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid transparent;
        }
        
        .feedback-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .feedback-btn.thumbs-up-active:hover {
            transform: scale(1.2) !important;
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.4) !important;
        }
        
        .feedback-btn.thumbs-down-active:hover {
            transform: scale(1.2) !important;
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.4) !important;
        }
        
        /* Improvement badge */
        .improvement-badge {
            animation: pulseGreen 2s infinite;
            box-shadow: 0 0 0 rgba(72, 187, 120, 0.4);
        }
        
        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }
        
        /* Improved question styling */
        .question-item.improved {
            border-left: 3px solid #48bb78;
            transition: all 0.3s ease;
        }
        
        .question-item.improving {
            opacity: 0.7;
            background-color: rgba(247, 250, 252, 0.8);
        }
        
        /* Feedback improvement status styling */
        .question-item.improved-question {
            border-left: 4px solid #10b981;
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), rgba(255, 255, 255, 0));
            position: relative;
        }

        .feedback-improvement-badge {
            animation: improvementGlow 3s ease-in-out;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }

        @keyframes improvementGlow {
            0% { box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15); }
            50% { box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3); }
            100% { box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15); }
        }

        .feedback-improvement-status {
            display: inline-flex;
            align-items: center;
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .improvement-details-btn {
            transition: all 0.2s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .improvement-details-btn:hover {
            background-color: rgba(16, 185, 129, 0.1);
            transform: scale(1.1);
        }

        .qa-improvement-badge {
            animation: slideInFromLeft 0.5s ease-out;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.1);
        }

        @keyframes slideInFromLeft {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Feedback status badges */
        .feedback-status-badge {
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        .improvement-status-badge {
            font-weight: 600;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Optimize parameters button */
        #optimize-parameters-btn {
            margin-top: 0.75rem;
            background: linear-gradient(to right, #3182ce, #4299e1);
            border: none;
            transition: all 0.3s ease;
        }
        
        #optimize-parameters-btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(to right, #2b6cb0, #3182ce);
            box-shadow: 0 4px 6px rgba(49, 130, 206, 0.1);
        }
        
        /* Recommendation notification */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .feedback-recommendation {
            animation: slideIn 0.3s ease-out forwards;
        }
        
        /* Enhanced feedback UI */
        .feedback-container {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
            border-top: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .improve-question-btn {
            transition: all 0.2s ease-in-out;
        }
        
        .improve-question-btn:hover {
            background-color: #bfdbfe;
            color: #1e40af;
        }
        
        .improve-question-btn.bg-green-600 {
            background-color: #059669;
            color: white;
        }
        
        .feedback-btn[data-feedback-group="quality"].active {
            background-color: #3b82f6;
            color: white;
        }
        
        .feedback-btn[data-feedback="relevance"].active:nth-child(1) {
            background-color: #10b981;
            color: white;
        }
        
        .feedback-btn[data-feedback="relevance"].active:nth-child(2) {
            background-color: #ef4444;
            color: white;
        }
        
        /* Repeated question indicator */
        .fa-exclamation-circle {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* Offline Storage Styles */
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            box-orient: vertical;
            overflow: hidden;
        }
        
        #offline-sets-list {
            min-height: 200px;
        }
        
        #offline-questions-section {
            display: flex;
            flex-direction: column;
        }
        
        #view-question-set-content .question-item {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1.5rem;
        }
        
        #view-question-set-content .question-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* Deep Search Styles */
        .deep-search-btn {
            transition: all 0.2s ease-in-out;
        }
        
        .deep-search-btn:hover {
            background-color: #e0e7ff;
        }
        
        .deep-search-result {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        .deep-search-result:not(.hidden) {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .deep-analysis-content {
            line-height: 1.6;
        }
        
        .deep-analysis-content h2,
        .deep-analysis-content h3,
        .deep-analysis-content h4 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4338ca;
        }
        
        .deep-analysis-content ul,
        .deep-analysis-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .deep-analysis-content ul li {
            list-style-type: disc;
        }
        
        .deep-analysis-content ol li {
            list-style-type: decimal;
        }
        
        .deep-analysis-content p {
            margin-bottom: 0.75rem;
        }
        
        .deep-analysis-content strong {
            font-weight: 600;
            color: #1e40af;
        }
        
        /* Offline indicator */
        .offline-indicator {
            display: inline-flex;
            align-items: center;
            background-color: #f3f4f6;
            color: #4b5563;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .offline-indicator i {
            margin-right: 0.25rem;
        }
        
        /* Question Selection Styles */
        #question-selection-header {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: slideDown 0.3s ease;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .question-select-checkbox {
            z-index: 10;
            animation: fadeIn 0.3s ease;
        }
        
        .question-select-checkbox-container {
            position: absolute;
            right: 15px;
            top: 15px;
            z-index: 10;
            opacity: 0.9;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 3px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .question-item.selected {
            border-left: 3px solid #8b5cf6;
        }
        
        /* Style for when in selection mode */
        #qa-container.selection-mode .question-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }
        
        #qa-container.selection-mode .question-item:hover {
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        #qa-container.selection-mode .question-item.selected {
            border-left: 3px solid #4f46e5;
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        #selected-questions-counter {
            font-weight: 500;
            color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.1);
            padding: 4px 12px;
            border-radius: 9999px;
        }
        
        /* Selection mode button */
        #selection-mode-btn {
            transition: all 0.3s ease;
        }
        
        /* Nerdy studying ophthalmologist animations */
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes glowing {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        @keyframes typing {
            0% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }
        
        @keyframes pageFlip {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(180deg); }
        }
        
        .nerdy-icon {
            animation: floating 4s ease-in-out infinite;
        }
        
        .book-icon {
            animation: glowing 3s ease-in-out infinite;
        }
        
        .glasses-icon {
            transform-origin: center;
            animation: typing 1.5s ease-in-out infinite;
        }
        
        .page-flip {
            perspective: 1000px;
            transform-style: preserve-3d;
            animation: pageFlip 1.5s ease-in-out infinite alternate;
            display: inline-block;
        }
        
        /* Updated header background for nerdy ophthalmologist theme */
        .nerdy-pattern {
            background-image: linear-gradient(to right, rgba(44, 111, 165, 0.9), rgba(13, 76, 128, 0.9));
            position: relative;
            overflow: hidden;
        }
        
        .nerdy-pattern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 255, 255, 0.03) 10px, rgba(255, 255, 255, 0.03) 20px),
                repeating-linear-gradient(-45deg, transparent, transparent 10px, rgba(255, 255, 255, 0.03) 10px, rgba(255, 255, 255, 0.03) 20px);
            z-index: 1;
        }
        
        /* Ophthalmologist animation styles */
        .ophthalmologist-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            width: 120px;
            height: 120px;
            opacity: 0.8;
        }
        
        @keyframes studyFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-8px) rotate(-1deg); }
            75% { transform: translateY(8px) rotate(1deg); }
        }
        
        .eye-doctor-figure {
            animation: studyFloat 8s ease-in-out infinite;
            transform-origin: center center;
        }
        
        @keyframes readingMotion {
            0%, 100% { transform: rotate(-2deg); }
            25% { transform: rotate(2deg); }
            75% { transform: rotate(-1deg); }
        }
        
        .study-book {
            animation: readingMotion 4s ease-in-out infinite;
            transform-origin: center center;
        }
        
        @keyframes ophthalmoscopeGlow {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; filter: brightness(1.2); }
        }
        
        .ophthalmoscope {
            animation: ophthalmoscopeGlow 3s ease-in-out infinite;
        }
        
        @keyframes knowledgeSparkle {
            0% { opacity: 0.2; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.2; transform: scale(0.5); }
        }
        
        .sparkle {
            opacity: 0.5;
            transform-origin: center;
        }
        
        .sparkle-1 {
            animation: knowledgeSparkle 3s ease-in-out infinite;
            animation-delay: 0.2s;
        }
        
        .sparkle-2 {
            animation: knowledgeSparkle 3s ease-in-out infinite;
            animation-delay: 1.2s;
        }
        
        .sparkle-3 {
            animation: knowledgeSparkle 3s ease-in-out infinite;
            animation-delay: 2.2s;
        }
        
        .sparkle-4 {
            animation: knowledgeSparkle 3s ease-in-out infinite;
            animation-delay: 0.8s;
        }
        
        .sparkle-5 {
            animation: knowledgeSparkle 3s ease-in-out infinite;
            animation-delay: 1.8s;
        }
        
        @keyframes studyFocus {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        
        .focus-line {
            animation: studyFocus 2s ease-in-out infinite;
        }
        
        .focus-1 {
            animation-delay: 0.5s;
        }
        
        .focus-2 {
            animation-delay: 1s;
        }
        
        /* Add some spacing for the checkbox */
        .question-item {
            position: relative;
            padding-right: 40px;
            margin-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 16px;
        }
        
        /* Ophthalmic Images Styles */
        .ophthalmic-image {
            transition: transform 0.3s ease-in-out;
            cursor: pointer;
        }
        
        .ophthalmic-image:hover {
            transform: scale(1.02);
        }
        
        .ophthalmic-image-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        
        .ophthalmic-image-container:not(.hidden) {
            max-height: 400px;
        }
        
        /* Image preview modal animations */
        #ophthalmic-image-modal:not(.hidden) {
            animation: fadeIn 0.3s ease forwards;
        }
        
        #ophthalmic-image-modal .bg-white {
            animation: scaleIn 0.3s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Show clickable cursor for images */
        .ophthalmic-image {
            cursor: zoom-in;
        }
        
        /* Add enhanced image modal styles */
        #ophthalmic-image-modal .modal-image {
            transition: transform 0.3s ease, max-height 0.3s ease;
            transform-origin: center;
            max-height: 60vh;
        }
        
        #ophthalmic-image-modal .modal-image.zoomed {
            max-height: 80vh;
            cursor: zoom-out;
        }
        
        #ophthalmic-image-preview {
            transition: transform 0.3s ease;
            transform-origin: center;
        }
        
        /* Responsive image container */
        .deep-analysis-image {
            transition: all 0.3s ease;
        }
        
        .deep-analysis-image:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Image controls styling */
        .image-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.5rem;
        }
        
        .image-control-btn {
            padding: 0.25rem;
            border-radius: 9999px;
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s ease;
        }
        
        .image-control-btn:hover {
            background-color: #d1d5db;
            color: #1f2937;
        }
        
        /* Enhanced related conditions buttons */
        #ophthalmic-image-related .condition-chip {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        #ophthalmic-image-related .condition-chip:hover {
            background-color: #dbeafe;
            transform: translateY(-1px);
        }
        
        /* Clinical info styling */
        #ophthalmic-image-info strong {
            color: #1e40af;
        }
        
        #ophthalmic-image-info ul li {
            margin-bottom: 0.25rem;
        }
        
        /* Button optimization styles */
        .action-btn {
            font-size: 0.65rem; /* Even smaller font for better fit */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%; /* Ensure buttons don't overflow */
            padding-left: 0.4rem;
            padding-right: 0.4rem;
            flex: 2; /* Give action buttons more space */
            letter-spacing: -0.03em; /* Tighter letter spacing */
        }
        
        /* Enhanced button layout with better spacing */
        .action-btn {
            font-size: 0.75rem; /* Increased readability */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0.875rem 0.75rem; /* Better padding */
            min-height: 48px; /* Consistent height */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            letter-spacing: -0.01em;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        
        /* Improved button container with grid layout */
        .button-container {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 0.75rem;
            width: 100%;
            max-width: 100%;
            align-items: stretch;
            margin-top: 1.25rem;
        }
        
        /* Export format dropdown positioning */
        .export-format-container {
            grid-column: 1;
            grid-row: 1 / 3;
            display: flex;
            align-items: center;
            max-width: 120px;
        }
        
        /* Primary action buttons - top row */
        .primary-actions {
            grid-column: 2 / 4;
            grid-row: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }
        
        /* Secondary action buttons - bottom row */
        .secondary-actions {
            grid-column: 2 / 4;
            grid-row: 2;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }
        
        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .button-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 0.5rem;
            }
            
            .export-format-container {
                grid-column: 1;
                grid-row: 1;
                max-width: 100%;
                justify-self: stretch;
            }
            
            .primary-actions {
                grid-column: 1;
                grid-row: 2;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            .secondary-actions {
                grid-column: 1;
                grid-row: 3;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            .action-btn {
                font-size: 0.7rem;
                padding: 0.75rem 0.5rem;
                min-height: 44px;
            }
        }
        
        @media (max-width: 480px) {
            .primary-actions,
            .secondary-actions {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .action-btn {
                font-size: 0.75rem;
                padding: 0.875rem 0.75rem;
                min-height: 48px;
            }
        }
        
        /* Button hover and focus improvements */
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn:active {
            transform: translateY(0);
        }
        
        .action-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        
        /* Export format dropdown takes less space */
        #export-format {
            max-width: 100%;
            font-size: 0.75rem;
        }
        
        /* Management question styling */
        .question-item[data-type="management"] {
            border-left: 4px solid #805ad5;
            background-color: rgba(237, 233, 254, 0.2);
        }
        
        .question-item[data-type="management"] .answer-text {
            padding: 12px;
            background-color: #f9f7ff;
            border-radius: 8px;
        }
        
        .question-item[data-type="management"] .answer-text div {
            margin-top: 12px;
        }
        
        .question-item[data-type="management"] .question-text {
            font-weight: 500;
            color: #4c1d95;
        }
        
        .question-item[data-type="management"] .answer-container {
            border-top: 2px dashed rgba(128, 90, 213, 0.3);
        }
        
        /* Repeated question styling */
        .question-item.repeated-question {
            border-left: 3px solid #f59e0b;
            background-color: rgba(254, 252, 232, 0.2);
        }
        
        .repeated-badge {
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 rgba(245, 158, 11, 0.4);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        
        /* Extracted question styling */
        .question-item.extracted-question {
            border-left: 4px solid #10b981;
            background-color: rgba(236, 253, 245, 0.3);
        }
        
        .question-item.extracted-question .question-text {
            color: #065f46;
        }
        
        .extracted-badge {
            animation: pulseGreen 2s infinite;
            box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
        }
        
        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        /* Generated question styling (for distinction) */
        .question-item.generated-question {
            border-left: 4px solid #3b82f6;
            background-color: rgba(239, 246, 255, 0.3);
        }
        
        .generated-badge {
            animation: pulseBlue 2s infinite;
            box-shadow: 0 0 0 rgba(59, 130, 246, 0.4);
        }
        
        @keyframes pulseBlue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* File processing options styling */
        #file-processing-options {
            transition: all 0.3s ease-in-out;
        }
        
        #extraction-settings {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        
        #extraction-settings:not(.hidden) {
            max-height: 200px;
        }
        
        /* Processing mode indicators */
        .processing-mode-indicator {
            display: inline-flex;
            align-items: center;
            background-color: #f3f4f6;
            color: #4b5563;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .processing-mode-indicator.extract {
            background-color: #dcfce7;
            color: #16a34a;
        }
        
        .processing-mode-indicator.generate {
            background-color: #dbeafe;
            color: #2563eb;
        }
        
        .processing-mode-indicator.both {
            background-color: #fef3c7;
            color: #d97706;
        }
    </style>
    <!-- Load JavaScript modules -->
    <script src="js/config.js" defer></script>
    <script src="js/UI.js" defer></script>
    <script src="js/FileHandler.js" defer></script>
    <script src="js/MedicalNLP.js" defer></script>
    <script src="js/QuestionDatabase.js" defer></script>
    <script src="js/MedicalMLProcessor.js" defer></script>
    <script src="js/QuestionGenerator.js" defer></script>
    <script src="js/QAExtractor.js" defer></script>
            <script src="js/EnhancedFeedbackSystem.js" defer></script>
        <script src="js/ContinuousImprovementSystem.js" defer></script>
    <script src="js/ValidationSystem.js" defer></script>
    <script src="js/ValidationUI.js" defer></script>
    <script src="js/ValidationMonitor.js" defer></script>
    <script src="js/ExportHandler.js" defer></script>
    <script src="js/AuthManager.js" defer></script>
    <script src="js/QuotaManager.js" defer></script>
    <script src="js/DonationHandler.js" defer></script>
    <script src="js/UserApiInjector.js" defer></script>
    <script src="js/BioMistralAPI.js" defer></script>

    <script src="js/HuggingFaceAPI.js" defer></script>
    <script src="js/HuggingFaceUI.js" defer></script>
    <script src="js/NotebookLmHandler.js" defer></script>
    <script src="js/OfflineStorageManager.js" defer></script>
    <script src="js/DeepSearchHandler.js" defer></script>
    <script src="js/OphthalmoImageGenerator.js" defer></script>
    <script src="js/feedback-loop.js" defer></script>
    <script src="js/enhanced-feedback.js" defer></script>
    <script src="js/advanced-file-processor.js" defer></script>
    <script src="js/enhanced-qa-extractor.js" defer></script>
    <script src="js/question-generation-history.js" defer></script>
    <script src="js/feedback-parameter-optimizer.js" defer></script>
    <script src="js/test-improvement-system.js" defer></script>
    <script src="js/test-enhanced-extraction.js" defer></script>
    <script src="js/storage-manager.js" defer></script>
    <script src="js/improvement-functions.js" defer></script>
    <script src="js/improvement-recommendations.js" defer></script>
    <script src="js/feedback.js" defer></script>
    <script src="js/feedback-metrics.js" defer></script>
    <script src="js/reset-questions-counter.js" defer></script>
    <script src="js/main.js" defer></script>
    
    <!-- Script to ensure "All Listed Subspecialties" is always selectable -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Make sure the "All Listed Subspecialties" option is always enabled
            const inputTypeSelect = document.getElementById('input-type');
            const knowledgeArea = document.getElementById('knowledge-area');
            
            // Force enable the "All Listed Subspecialties" option and update its style
            function enableAllSubspecialties() {
                // Find the "All Listed Subspecialties" option specifically
                const allOption = Array.from(knowledgeArea.options).find(opt => opt.value === 'all');
                if (allOption) {
                    // Ensure it's not disabled
                    allOption.disabled = false;
                    // Remove any visual styling that might indicate it's disabled
                    allOption.style.color = '';
                    allOption.style.backgroundColor = '';
                    allOption.style.opacity = '';
                }
            }
            
            // Run when the page loads
            enableAllSubspecialties();
            
            // Run whenever input type changes
            inputTypeSelect.addEventListener('change', enableAllSubspecialties);
            
            // Override any attempts to disable the option after the page has loaded
            // Use MutationObserver to detect if something else tries to disable it
            const observer = new MutationObserver(() => {
                enableAllSubspecialties();
            });
            
            // Start observing the select element for attribute changes
            observer.observe(knowledgeArea, { 
                attributes: true, 
                attributeFilter: ['disabled'], 
                subtree: true 
            });
            
            // Override any click handlers on the input type selector
            inputTypeSelect.addEventListener('change', function() {
                // Small delay to ensure this runs after any other change handlers
                setTimeout(enableAllSubspecialties, 0);
            });
        });
    </script>

    <!-- Script for Q&A Extraction and File Processing Options -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize QA Extractor
            let qaExtractor = null;
            let currentFileContent = null;
            let extractedQuestions = [];
            
            // Get UI elements
            const fileDropArea = document.getElementById('file-drop-area');
            const fileInfo = document.getElementById('file-info');
            const fileProcessingOptions = document.getElementById('file-processing-options');
            const extractionSettings = document.getElementById('extraction-settings');
            const generateBtn = document.getElementById('generate-btn');
            const qaContainer = document.getElementById('qa-container');
            
            // Processing mode radio buttons
            const processGenerate = document.getElementById('process-generate');
            const processExtract = document.getElementById('process-extract');
            const processBoth = document.getElementById('process-both');
            
            // Initialize QA Extractor when available
            function initializeQAExtractor() {
                if (window.enhancedQAExtractor) {
                    qaExtractor = window.enhancedQAExtractor;
                    log('Enhanced QA Extractor initialized successfully', 'success');
                } else if (window.QAExtractor) {
                    qaExtractor = new window.QAExtractor();
                    log('Standard QA Extractor initialized successfully', 'success');
                } else {
                    log('QA Extractor not available yet, retrying...', 'warning');
                    setTimeout(initializeQAExtractor, 200);
                }
            }
            
                        // Enhanced initialization with multiple retry attempts
            function initializeEnhancedExtractor() {
                let attempts = 0;
                const maxAttempts = 25; // Try for 5 seconds
                
                const tryInit = () => {
                    attempts++;
                    
                    // Check if all required systems are loaded
                    const systemsReady = {
                        enhancedQA: window.enhancedQAExtractor && typeof window.enhancedQAExtractor.extractFromText === 'function',
                        enhancedFeedback: window.enhancedFeedbackSystem && typeof window.enhancedFeedbackSystem.getImprovementStats === 'function',
                        advancedProcessor: window.advancedFileProcessor && typeof window.advancedFileProcessor.processFile === 'function',
                        globalFunctions: typeof window.getImprovementStats === 'function'
                    };
                    
                    const readySystems = Object.values(systemsReady).filter(Boolean).length;
                    const totalSystems = Object.keys(systemsReady).length;
                    
                    log(`Loading enhanced systems... (${readySystems}/${totalSystems} ready, attempt ${attempts}/${maxAttempts})`, 'info');
                    
                    if (systemsReady.enhancedQA) {
                        qaExtractor = window.enhancedQAExtractor;
                        log(`✅ Enhanced QA Extractor ready! (${readySystems}/${totalSystems} systems loaded)`, 'success');
                        return true;
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(tryInit, 200);
                        return false;
                    } else {
                        log('Enhanced extractor not available, falling back to standard', 'warning');
                        initializeQAExtractor();
                        return false;
                    }
                };
                
                tryInit();
            }
            
            // Debug function to check extractor availability
            function checkExtractorAvailability() {
                console.log('🔍 Checking extractor availability...');
                console.log('window.enhancedQAExtractor:', !!window.enhancedQAExtractor);
                console.log('window.extractQuestionsEnhanced:', !!window.extractQuestionsEnhanced);
                console.log('window.extractQuestionsWithFeedback:', !!window.extractQuestionsWithFeedback);
                console.log('window.QAExtractor:', !!window.QAExtractor);
                
                if (window.enhancedQAExtractor) {
                    console.log('Enhanced extractor methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.enhancedQAExtractor)));
                }
            }
            
            // Start initialization with enhanced extractor
            initializeEnhancedExtractor();
            
            // Check availability after a short delay to ensure scripts are loaded
            setTimeout(checkExtractorAvailability, 1000);
            
            // Test function for debugging extraction with error handling
            window.testExtraction = async function() {
                console.log('🧪 Testing extraction system...');
                console.log('Available systems:', {
                    enhancedQAExtractor: !!window.enhancedQAExtractor,
                    enhancedFeedbackSystem: !!window.enhancedFeedbackSystem,
                    advancedFileProcessor: !!window.advancedFileProcessor,
                    extractQuestionsEnhanced: !!window.extractQuestionsEnhanced,
                    extractQuestionsWithFeedback: !!window.extractQuestionsWithFeedback,
                    getImprovementStats: !!window.getImprovementStats
                });
                const testContent = `1. What is the normal IOP range?
                A) 10-21 mmHg
                B) 5-15 mmHg
                C) 20-30 mmHg
                Answer: A
                
                2. Which imaging technique is used for retinal evaluation?
                A) CT scan
                B) MRI  
                C) OCT
                Answer: C`;
                
                console.log('🧪 Testing extraction with sample content...');
                
                try {
                    let result;
                    if (window.enhancedQAExtractor) {
                        result = await window.enhancedQAExtractor.extractFromText(testContent, { confidenceThreshold: 0.3 });
                        console.log('✅ Enhanced extractor test successful:', result);
                    } else if (window.extractQuestionsEnhanced) {
                        result = await window.extractQuestionsEnhanced(testContent, { confidenceThreshold: 0.3 });
                        console.log('✅ Function-based extractor test successful:', result);
                    } else {
                        console.log('❌ No enhanced extractor available for testing');
                    }
                } catch (error) {
                    console.error('❌ Extraction test failed:', error);
                }
            };
            
            // Show/hide extraction settings based on processing mode
            function updateExtractionSettings() {
                const showExtractionSettings = processExtract.checked || processBoth.checked;
                if (showExtractionSettings) {
                    extractionSettings.classList.remove('hidden');
                } else {
                    extractionSettings.classList.add('hidden');
                }
            }
            
            // Add event listeners to processing mode radio buttons
            [processGenerate, processExtract, processBoth].forEach(radio => {
                radio.addEventListener('change', updateExtractionSettings);
            });
            
                         // Show file processing options when a file is uploaded
             function showFileProcessingOptions() {
                 fileProcessingOptions.classList.remove('hidden');
                 updateExtractionSettings();
                 
                 // Show Extract Q&A button
                 const extractQABtn = document.getElementById('extract-qa-btn');
                 if (extractQABtn) {
                     extractQABtn.classList.remove('hidden');
                 }
             }
             
             // Hide file processing options
             function hideFileProcessingOptions() {
                 fileProcessingOptions.classList.add('hidden');
                 extractionSettings.classList.add('hidden');
                 
                 // Hide Extract Q&A button
                 const extractQABtn = document.getElementById('extract-qa-btn');
                 if (extractQABtn) {
                     extractQABtn.classList.add('hidden');
                 }
             }
            
                         // Improved file upload integration
             function integrateWithFileHandlers() {
                 // Enhanced file upload handler
                 const originalFileHandler = window.handleFileUpload;
                 window.handleFileUpload = function(file, content) {
                     log(`File uploaded: ${file.name}`, 'info');
                     showFileProcessingOptions();
                     
                     // Store file content for extraction
                     if (content) {
                         currentFileContent = content;
                         log('File content received from file handler', 'info');
                     }
                     
                     // Call original handler if it exists
                     if (originalFileHandler) {
                         originalFileHandler(file, content);
                     }
                 };

                 // Hook into existing file processing systems
                 window.setFileContent = function(content, filename) {
                     currentFileContent = content;
                     log(`File content set: ${filename || 'unknown'}`, 'info');
                     
                     // Show processing options if we have content and upload mode is selected
                     const inputType = document.getElementById('input-type');
                     if (inputType && inputType.value === 'upload') {
                         showFileProcessingOptions();
                     }
                 };

                 // Monitor file input changes directly
                 const fileInput = document.getElementById('pdf-upload');
                 if (fileInput) {
                                      fileInput.addEventListener('change', async function(e) {
                         if (e.target.files && e.target.files.length > 0) {
                             const file = e.target.files[0];
                             log(`File selected: ${file.name}`, 'info');
                             showFileProcessingOptions();
                             
                             // Read file content for extraction if not handled by main system
                             if (!currentFileContent) {
                             await readFileForExtraction(file);
                             }
                         }
                     });
                 }
                 
                 // Monitor drag and drop
                 if (fileDropArea) {
                     fileDropArea.addEventListener('drop', async function(e) {
                         e.preventDefault();
                         if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                             const file = e.dataTransfer.files[0];
                             log(`File dropped: ${file.name}`, 'info');
                             showFileProcessingOptions();
                             
                             // Read file content if not handled by main system
                             if (!currentFileContent) {
                                 await readFileForExtraction(file);
                             }
                         }
                     });
                 }
             }

             // Enhanced file reading with advanced file processor
             async function readFileForExtraction(file) {
                 try {
                     log(`📄 Reading file with advanced processor: ${file.name}`, 'info');
                     
                     // Use advanced file processor if available
                     if (window.processFileAdvanced) {
                         const result = await window.processFileAdvanced(file);
                         currentFileContent = result.content;
                         
                         // Log processing statistics
                         if (result.metadata && result.metadata.stats) {
                             const stats = result.metadata.stats;
                             log(`✅ Advanced processing complete: ${stats.originalSize} → ${stats.processedSize} bytes in ${stats.processingTime}ms`, 'success');
                             
                             if (stats.warnings.length > 0) {
                                 log(`⚠️ Processing warnings: ${stats.warnings.join(', ')}`, 'warning');
                             }
                         }
                         
                         // Show processing options if we have content
                         if (currentFileContent && currentFileContent.length > 0) {
                             const inputType = document.getElementById('input-type');
                             if (inputType && inputType.value === 'upload') {
                                 showFileProcessingOptions();
                             }
                         }
                         
                     } else {
                         // Fallback to basic file reading
                         log('Advanced file processor not available, using basic reading...', 'warning');
                         
                 if (file.name.toLowerCase().endsWith('.pdf')) {
                     // For PDFs, we'll need to wait for the PDF.js processing
                     log('PDF file detected, waiting for PDF.js processing...', 'info');
                     setupPDFContentListener();
                             return;
                         }
                         
                         const reader = new FileReader();
                         await new Promise((resolve, reject) => {
                             reader.onload = (event) => {
                                 currentFileContent = event.target.result;
                                 log('File content loaded for extraction', 'info');
                                 resolve();
                             };
                             reader.onerror = (error) => {
                                 log(`Error reading file: ${error.message}`, 'error');
                                 reject(error);
                             };
                     reader.readAsText(file);
                         });
                     }
                     
                     log(`File content ready for extraction: ${file.name} (${currentFileContent?.length || 0} characters)`, 'info');
                     
                 } catch (error) {
                     log(`❌ Error reading file: ${error.message}`, 'error');
                     console.error('File reading error:', error);
                 }
             }

             // Setup PDF content listener
             function setupPDFContentListener() {
                 // Check periodically if PDF content has been processed
                 const checkPDFContent = setInterval(() => {
                     // Look for processed PDF content in the global scope or text area
                     const textArea = document.getElementById('input-text');
                     if (textArea && textArea.value && textArea.value.length > 100) {
                         currentFileContent = textArea.value;
                         log('PDF content extracted from text area', 'info');
                         clearInterval(checkPDFContent);
                         
                         // Auto-show processing options if in upload mode
                         const inputType = document.getElementById('input-type');
                         if (inputType && inputType.value === 'upload') {
                             showFileProcessingOptions();
                         }
                     }
                 }, 1000);
                 
                 // Clear interval after 30 seconds to prevent indefinite checking
                 setTimeout(() => clearInterval(checkPDFContent), 30000);
             }

             // Initialize file handler integration
             integrateWithFileHandlers();
            
            // Enhanced file processing
            function processUploadedFile(content, processingMode = 'generate') {
                currentFileContent = content;
                extractedQuestions = [];
                
                log(`Processing file with mode: ${processingMode}`, 'info');
                
                if (processingMode === 'extract' || processingMode === 'both') {
                    extractQuestionsFromContent(content);
                }
                
                if (processingMode === 'generate' || processingMode === 'both') {
                    // Let the original question generation handle this
                    log('Content ready for question generation', 'info');
                }
            }
            
            // Extract questions from file content with enhanced feedback integration
            async function extractQuestionsFromContent(content) {
                try {
                    // Get extraction settings
                    const extractionOptions = {
                        minQuestionLength: parseInt(document.getElementById('min-question-length').value) || 20,
                        extractMCQ: document.getElementById('extract-mcq').checked,
                        extractNumbered: document.getElementById('extract-numbered').checked,
                        extractQandA: document.getElementById('extract-qanda').checked,
                        extractBold: document.getElementById('extract-bold').checked,
                        confidenceThreshold: 0.4,
                        includeMetadata: true,
                        preserveFormatting: true
                    };
                    
                    log('🔍 Starting enhanced Q&A extraction with feedback integration...', 'info');
                    console.log('Extraction options:', extractionOptions);
                    
                    // Use enhanced extractor with feedback integration
                    let extractionResult;
                    
                    console.log('🔍 Attempting extraction with available extractors...');
                    console.log('Available extractors:', {
                        withFeedback: !!window.extractQuestionsWithFeedback,
                        enhanced: !!window.extractQuestionsEnhanced,
                        enhancedInstance: !!window.enhancedQAExtractor,
                        qaExtractor: !!qaExtractor,
                        hasEnhancedMethod: !!(window.enhancedQAExtractor && window.enhancedQAExtractor.extractFromText)
                    });
                    
                    if (window.extractQuestionsWithFeedback) {
                        console.log('Using extractQuestionsWithFeedback...');
                        extractionResult = await window.extractQuestionsWithFeedback(content, extractionOptions);
                    } else if (window.extractQuestionsEnhanced) {
                        console.log('Using extractQuestionsEnhanced...');
                        extractionResult = await window.extractQuestionsEnhanced(content, extractionOptions);
                    } else if (window.enhancedQAExtractor && typeof window.enhancedQAExtractor.extractFromText === 'function') {
                        console.log('Using enhancedQAExtractor.extractFromText...');
                        extractionResult = await window.enhancedQAExtractor.extractFromText(content, extractionOptions);
                    } else if (qaExtractor && typeof qaExtractor.extractFromText === 'function') {
                        console.log('Using qaExtractor.extractFromText...');
                        extractionResult = await qaExtractor.extractFromText(content, extractionOptions);
                    } else if (qaExtractor && typeof qaExtractor.extractQuestionsAndAnswers === 'function') {
                        console.log('Using legacy qaExtractor.extractQuestionsAndAnswers...');
                    const extracted = qaExtractor.extractQuestionsAndAnswers(content, extractionOptions);
                        extractionResult = {
                            questions: qaExtractor.formatForDisplay ? qaExtractor.formatForDisplay(extracted) : extracted,
                            stats: qaExtractor.getExtractionStats ? qaExtractor.getExtractionStats(extracted) : { total: extracted.length },
                            metadata: { extractionOptions }
                        };
                    } else {
                        throw new Error('No compatible Q&A extractor available. Please refresh the page and try again.');
                    }
                    
                    extractedQuestions = extractionResult.questions;
                    
                    log(`✅ Enhanced extraction complete: ${extractionResult.questions.length} questions found`, 'success');
                    
                    // Log improvement statistics if available
                    if (extractionResult.metadata && extractionResult.metadata.improvementStats) {
                        const improvementStats = extractionResult.metadata.improvementStats;
                        log(`📈 Improvement Analysis: ${improvementStats.totalImproved} questions improved (${Math.round(improvementStats.improvementRate)}% improvement rate)`, 'info');
                    }
                    
                    // Display extracted questions with feedback status
                    displayExtractedQuestions(extractedQuestions, extractionResult.metadata);
                    
                    // Show enhanced extraction summary
                    showEnhancedExtractionSummary(extractionResult.stats, extractionResult.metadata);
                    
                } catch (error) {
                    log(`❌ Error extracting questions: ${error.message}`, 'error');
                    console.error('Extraction error:', error);
                    
                    // Show user-friendly error message
                    const qaContainer = document.getElementById('qa-container');
                    if (qaContainer) {
                        qaContainer.innerHTML = `
                            <div class="text-center text-red-500 py-8">
                                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                                <p class="text-lg font-medium mb-2">Extraction Failed</p>
                                <p class="text-sm text-gray-600">${error.message}</p>
                                <button onclick="location.reload()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                    Retry
                                </button>
                            </div>
                        `;
                    }
                }
            }
            
            // Display extracted questions in the QA container with enhanced feedback integration
            function displayExtractedQuestions(questions, metadata = null) {
                if (questions.length === 0) {
                    qaContainer.innerHTML = '<p class="text-center text-gray-500 py-8">No questions found in the uploaded document. Try adjusting the extraction settings or use the "Generate New Questions" mode.</p>';
                    return;
                }
                
                log(`📊 Displaying ${questions.length} extracted questions with feedback status`, 'info');
                
                // Clear existing content
                qaContainer.innerHTML = '';
                
                // Add enhanced extraction summary header
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'mb-4 p-3 bg-green-50 border border-green-200 rounded-lg';
                
                let improvementInfo = '';
                if (metadata && metadata.improvementStats) {
                    const improvementStats = metadata.improvementStats;
                    if (improvementStats.totalImproved > 0) {
                        improvementInfo = `
                            <div class="mt-2 flex items-center text-sm">
                                <i class="fas fa-arrow-up text-green-600 mr-2"></i>
                                <span class="text-green-700">
                                    ${improvementStats.totalImproved} question${improvementStats.totalImproved > 1 ? 's' : ''} 
                                    improved via feedback loop (${Math.round(improvementStats.improvementRate)}% improvement rate)
                                </span>
                            </div>
                        `;
                    }
                }
                
                summaryDiv.innerHTML = `
                    <div class="flex items-center mb-2">
                        <i class="fas fa-search text-green-600 mr-2"></i>
                        <span class="font-medium text-green-800">Enhanced Extraction Results</span>
                        <span class="processing-mode-indicator extract ml-auto">
                            <i class="fas fa-file-alt mr-1"></i>
                            ${questions.length} Questions Found
                        </span>
                    </div>
                    ${improvementInfo}
                `;
                qaContainer.appendChild(summaryDiv);
                
                // Display each question with improvement badges
                questions.forEach((qa, index) => {
                    const questionDiv = createQuestionElement(qa, index, 'extracted');
                    
                    // Add improvement badge if question was improved via feedback
                    if (qa.improvementBadge) {
                        const badgeContainer = document.createElement('div');
                        badgeContainer.innerHTML = qa.improvementBadge;
                        questionDiv.insertBefore(badgeContainer.firstElementChild, questionDiv.firstElementChild);
                    }
                    
                    qaContainer.appendChild(questionDiv);
                });
                
                // Update button states
                updateButtonStates();
                
                // Show improvement summary if available
                if (metadata && metadata.improvementStats && metadata.improvementStats.totalImproved > 0) {
                    setTimeout(() => {
                        showImprovementNotification(metadata.improvementStats);
                    }, 1000);
                }
            }

            // Show enhanced extraction summary with improvement statistics
            function showEnhancedExtractionSummary(stats, metadata) {
                if (!stats) return;
                
                const summaryHtml = `
                    <div class="extraction-summary-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-chart-bar text-green-600 mr-2"></i>
                                    Enhanced Extraction Summary
                                </h3>
                                <button class="close-summary text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h4 class="font-medium text-blue-800 mb-2">Extraction Results</h4>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between">
                                            <span>Total Questions:</span>
                                            <span class="font-semibold">${stats.total || 0}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>With Answers:</span>
                                            <span class="font-semibold">${stats.withAnswers || 0}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Average Confidence:</span>
                                            <span class="font-semibold">${stats.averageConfidence ? Math.round(stats.averageConfidence * 100) : 0}%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${metadata && metadata.improvementStats ? `
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <h4 class="font-medium text-green-800 mb-2">Feedback Improvements</h4>
                                        <div class="space-y-1 text-sm">
                                            <div class="flex justify-between">
                                                <span>Improved Questions:</span>
                                                <span class="font-semibold">${metadata.improvementStats.totalImproved}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Improvement Rate:</span>
                                                <span class="font-semibold">${Math.round(metadata.improvementStats.improvementRate)}%</span>
                                            </div>
                                            <div class="text-xs text-green-600 mt-2">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                Questions enhanced through user feedback
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="font-medium text-gray-700 mb-2">Question Types Distribution</h4>
                                <div class="space-y-2">
                                    ${stats.byType && typeof stats.byType === 'object' ? Object.entries(stats.byType).map(([type, count]) => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm capitalize">${type.replace('_', ' ')}</span>
                                            <div class="flex items-center">
                                                <div class="bg-gray-200 rounded-full w-20 h-2 mr-2">
                                                    <div class="bg-blue-500 h-2 rounded-full" 
                                                         style="width: ${stats.total && stats.total > 0 ? (count / stats.total) * 100 : 0}%"></div>
                                                </div>
                                                <span class="text-sm font-medium">${count}</span>
                                            </div>
                                        </div>
                                    `).join('') : '<div class="text-sm text-gray-500">No type distribution data available</div>'}
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <h4 class="font-medium text-gray-700 mb-2">Confidence Distribution</h4>
                                <div class="grid grid-cols-3 gap-2 text-sm">
                                    <div class="text-center p-2 bg-green-100 rounded">
                                        <div class="text-lg font-bold text-green-800">${stats.byConfidence && stats.byConfidence.high !== undefined ? stats.byConfidence.high : 0}</div>
                                        <div class="text-green-600">High</div>
                                    </div>
                                    <div class="text-center p-2 bg-yellow-100 rounded">
                                        <div class="text-lg font-bold text-yellow-800">${stats.byConfidence && stats.byConfidence.medium !== undefined ? stats.byConfidence.medium : 0}</div>
                                        <div class="text-yellow-600">Medium</div>
                                    </div>
                                    <div class="text-center p-2 bg-red-100 rounded">
                                        <div class="text-lg font-bold text-red-800">${stats.byConfidence && stats.byConfidence.low !== undefined ? stats.byConfidence.low : 0}</div>
                                        <div class="text-red-600">Low</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end">
                                <button class="close-summary bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                    <i class="fas fa-check mr-1"></i>
                                    Got it
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', summaryHtml);
                
                // Add event listeners
                document.querySelectorAll('.close-summary').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelector('.extraction-summary-modal').remove();
                    });
                });
            }

            // Show improvement notification
            function showImprovementNotification(improvementStats) {
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-green-100 border-l-4 border-green-500 p-4 rounded shadow-lg z-50 max-w-sm improvement-notification';
                notification.innerHTML = `
                    <div class="flex">
                        <i class="fas fa-arrow-up text-green-500 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-medium text-green-800">Questions Improved</h4>
                            <p class="text-sm text-green-700 mt-1">
                                ${improvementStats.totalImproved} question${improvementStats.totalImproved > 1 ? 's have' : ' has'} 
                                been enhanced through feedback loop analysis.
                            </p>
                            <button class="mt-2 text-xs bg-green-200 hover:bg-green-300 px-2 py-1 rounded text-green-800"
                                    onclick="this.parentElement.parentElement.parentElement.remove()">
                                Excellent!
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 6000);
            }
            
                         // Create question element with full integration
             function createQuestionElement(qa, index, source = 'extracted') {
                 const questionDiv = document.createElement('div');
                 questionDiv.className = `question-item ${source}-question mb-4 p-4 border border-gray-200 rounded-lg relative`;
                 questionDiv.setAttribute('data-type', qa.type);
                 questionDiv.setAttribute('data-source', source);
                 questionDiv.setAttribute('data-question-id', qa.id || `${source}_${index + 1}`);
                 
                 let badgeColor = source === 'extracted' ? 'green' : 'blue';
                 let badgeText = source === 'extracted' ? 'Extracted' : 'Generated';
                 let badgeIcon = source === 'extracted' ? 'search' : 'magic';
                 
                 // Get enhanced feedback status
                 const questionId = qa.id || `${source}_${index + 1}`;
                 const feedbackStatus = window.getImprovementStatusDisplay ? 
                     window.getImprovementStatusDisplay(questionId) : null;
                 
                 let html = `
                     <div class="flex justify-between items-start mb-3">
                         <h3 class="text-lg font-semibold text-gray-800">Question ${index + 1}</h3>
                         <div class="flex items-center gap-2">
                             <span class="${source}-badge bg-${badgeColor}-100 text-${badgeColor}-800 text-xs px-2 py-1 rounded-full flex items-center">
                                 <i class="fas fa-${badgeIcon} mr-1"></i>
                                 ${badgeText}
                             </span>
                             <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">
                                 ${qa.type.replace('-', ' ').toUpperCase()}
                             </span>
                             ${feedbackStatus && feedbackStatus.status !== 'unknown' ? `
                                 <span class="feedback-status-badge bg-${feedbackStatus.color}-100 text-${feedbackStatus.color}-800 text-xs px-2 py-1 rounded-full flex items-center" 
                                       title="${feedbackStatus.details}">
                                     <i class="fas fa-${feedbackStatus.icon} mr-1"></i>
                                     ${feedbackStatus.display}
                                 </span>
                             ` : ''}
                         </div>
                     </div>
                     
                     <div class="question-text mb-3 text-gray-800 font-medium">
                         ${qa.question}
                     </div>
                 `;
                 
                 // Add options if it's a multiple choice question
                 if (qa.options && qa.options.length > 0) {
                     html += '<div class="options-container mb-3">';
                     qa.options.forEach((option, index) => {
                         // Clean option label to avoid duplication
                         let cleanLabel = option.label || '';
                         let cleanText = option.text || '';
                         
                         // If label is empty or doesn't contain alphabet, generate it
                         if (!cleanLabel || !cleanLabel.match(/^[A-Z]\)?$/i)) {
                             cleanLabel = String.fromCharCode(65 + index); // A, B, C, D...
                         } else {
                             // Remove any existing punctuation from label
                             cleanLabel = cleanLabel.replace(/[.)]/g, '');
                         }
                         
                         // Remove any duplicate alphabet at the start of text
                         cleanText = cleanText.replace(/^[A-Z][.)]\s*/i, '');
                         
                         html += `<div class="question-option p-2 mb-1 bg-gray-50 border border-gray-200 rounded hover:bg-gray-100 transition-colors duration-200">
                             <span class="font-semibold text-primary mr-2">${cleanLabel})</span>
                             <span>${cleanText}</span>
                         </div>`;
                     });
                     html += '</div>';
                 }
                 
                 // Add answer section
                 if (qa.answer && qa.answer !== 'No answer found in document') {
                     html += `
                         <div class="answer-container mt-4 pt-3 border-t border-gray-200">
                             <button class="answer-toggle flex items-center text-primary hover:text-accent font-medium mb-2" onclick="toggleAnswer(this)">
                                 <i class="fas fa-eye mr-2"></i>
                                 <span>Show Answer</span>
                             </button>
                             <div class="answer-text hidden p-3 bg-gray-50 border border-gray-200 rounded-md">
                                 ${qa.answer}
                             </div>
                         </div>
                     `;
                 } else {
                     html += `
                         <div class="answer-container mt-4 pt-3 border-t border-gray-200">
                             <p class="text-gray-500 italic">No answer found in the document</p>
                         </div>
                     `;
                 }
                 
                 // Add metadata section
                 let metadataHtml = '<div class="mt-3 flex flex-wrap gap-2 text-xs text-gray-500">';
                 
                 // Confidence indicator
                 if (qa.confidence) {
                     const confidencePercent = Math.round(qa.confidence * 100);
                     metadataHtml += `
                         <span class="flex items-center">
                             <i class="fas fa-chart-line mr-1"></i>
                             Confidence: ${confidencePercent}%
                         </span>
                     `;
                 }
                 
                 // Enhanced improvement status
                 const improvementStatus = window.getImprovementStatus ? 
                     window.getImprovementStatus(questionId) : null;
                 
                 if (improvementStatus && improvementStatus.status !== 'unknown') {
                     metadataHtml += `
                         <span class="improvement-status-badge flex items-center" style="color: ${improvementStatus.color};">
                             <i class="${improvementStatus.icon} mr-1"></i>
                             ${improvementStatus.display}
                         </span>
                     `;
                     
                     if (improvementStatus.lastImprovement) {
                         metadataHtml += `
                             <span class="flex items-center text-xs text-green-600">
                                 <i class="fas fa-history mr-1"></i>
                                 Last improved: ${new Date(improvementStatus.lastImprovement).toLocaleDateString()}
                             </span>
                         `;
                     }
                     
                     if (improvementStatus.activeCycle) {
                         metadataHtml += `
                             <span class="flex items-center text-xs text-blue-600">
                                 <i class="fas fa-cog fa-spin mr-1"></i>
                                 Improvement in progress
                             </span>
                         `;
                     }
                     
                     if (improvementStatus.queuePosition >= 0) {
                         metadataHtml += `
                             <span class="flex items-center text-xs text-orange-600">
                                 <i class="fas fa-hourglass-half mr-1"></i>
                                 Queue position: ${improvementStatus.queuePosition + 1}
                             </span>
                         `;
                     }
                 }
                 
                 metadataHtml += '</div>';
                 html += metadataHtml;
                 
                 // Add feedback and action buttons
                 html += `
                     <div class="feedback-container bg-gray-50 p-3 rounded-lg mt-4">
                         <div class="flex flex-wrap items-center justify-between gap-2">
                             <div class="feedback-buttons flex items-center gap-2">
                                 <span class="text-sm font-medium text-gray-700">Quality:</span>
                                 <button class="feedback-btn" data-feedback="quality" data-value="good" title="Good question">
                                     <i class="fas fa-thumbs-up text-green-600"></i>
                                 </button>
                                 <button class="feedback-btn" data-feedback="quality" data-value="poor" title="Poor question">
                                     <i class="fas fa-thumbs-down text-red-600"></i>
                                 </button>
                                 <span class="text-sm font-medium text-gray-700 ml-3">Relevant:</span>
                                 <button class="feedback-btn" data-feedback="relevance" data-value="yes" title="Relevant">
                                     <i class="fas fa-check text-green-600"></i>
                                 </button>
                                 <button class="feedback-btn" data-feedback="relevance" data-value="no" title="Not relevant">
                                     <i class="fas fa-times text-red-600"></i>
                                 </button>
                             </div>
                             <div class="action-buttons flex items-center gap-2">
                                 ${source === 'extracted' ? `
                                     <button class="improve-question-btn text-blue-600 hover:text-blue-800 text-sm" 
                                             onclick="improveExtractedQuestion('${qa.id || `${source}_${index + 1}`}')">
                                         <i class="fas fa-magic mr-1"></i>
                                         Enhance
                                     </button>
                                 ` : `
                                     <button class="improve-question-btn text-blue-600 hover:text-blue-800 text-sm" 
                                             onclick="improveQuestion('${qa.id || `${source}_${index + 1}`}')">
                                         <i class="fas fa-magic mr-1"></i>
                                         Improve
                                     </button>
                                 `}
                                 <button class="deep-search-btn text-purple-600 hover:text-purple-800 text-sm" 
                                         onclick="performDeepSearch('${qa.question}', this)">
                                     <i class="fas fa-search-plus mr-1"></i>
                                     Deep Search
                                 </button>
                                 <button class="show-image-btn text-orange-600 hover:text-orange-800 text-sm" 
                                         onclick="showImageForQuestion('${qa.id || `${source}_${index + 1}`}', '${qa.question}', this)">
                                     <i class="fas fa-image mr-1"></i>
                                     Show Image
                                 </button>
                             </div>
                         </div>
                     </div>
                 `;
                 
                 questionDiv.innerHTML = html;
                 
                 // Add enhanced feedback listeners
                 addEnhancedFeedbackListeners(questionDiv, questionId, qa);
                 
                 // Add validation to the question
                 if (window.addValidationToQuestion && qa.question && qa.answer) {
                     const questionId = qa.id || `${source}_${index + 1}`;
                     setTimeout(() => {
                         window.addValidationToQuestion(questionDiv, qa.question, qa.answer, questionId)
                             .catch(err => log(`Validation error for question ${questionId}: ${err.message}`, 'warning'));
                     }, 100);
                 }
                 
                 return questionDiv;
             }
             
             // Add enhanced feedback listeners to question element
             function addEnhancedFeedbackListeners(questionDiv, questionId, questionData) {
                 const feedbackBtns = questionDiv.querySelectorAll('.feedback-btn');
                 feedbackBtns.forEach(btn => {
                     btn.addEventListener('click', function() {
                         const feedbackType = this.getAttribute('data-feedback');
                         const feedbackValue = this.getAttribute('data-value');
                         
                         // Record enhanced feedback with metadata
                         const metadata = {
                             questionType: questionData.type,
                             source: questionDiv.getAttribute('data-source'),
                             difficulty: questionData.difficulty,
                             subspecialty: questionData.subspecialty,
                             confidence: questionData.confidence
                         };
                         
                         // Original feedback recording
                         if (window.recordFeedback) {
                             const insights = window.recordFeedback(questionId, feedbackType, feedbackValue, metadata);
        
        // Dispatch feedback event for parameter optimization
        const feedbackEvent = new CustomEvent('questionFeedback', {
            detail: {
                questionId: questionId,
                type: feedbackType,
                value: feedbackValue,
                metadata: metadata,
                timestamp: new Date().toISOString()
            }
        });
        document.dispatchEvent(feedbackEvent);
                             
                             // Show feedback insights if available
                             if (insights) {
                                 showFeedbackInsights(questionDiv, insights);
                             }
                         }
                         
                         // Enhanced feedback system integration
                         if (window.enhancedFeedbackSystem) {
                             // The enhanced system will handle this through its event listeners
                             // Set question ID for tracking
                             if (!questionDiv.dataset.questionId) {
                                 questionDiv.dataset.questionId = questionId;
                             }
                         }
                         
                         // Update button states
                         updateFeedbackButtonStates(questionDiv, feedbackType, feedbackValue);
                         
                         // Show thank you message
                         showFeedbackThankYou(questionDiv);
                         
                         // Update feedback status display
                         updateFeedbackStatusDisplay(questionDiv, questionId);
                     });
                 });
             }
             
             // Show feedback insights
             function showFeedbackInsights(questionDiv, insights) {
                 if (insights.actionRecommendations && insights.actionRecommendations.length > 0) {
                     const insightDiv = document.createElement('div');
                     insightDiv.className = 'feedback-insights bg-blue-50 border border-blue-200 rounded p-2 mt-2 text-sm';
                     insightDiv.innerHTML = `
                         <div class="font-medium text-blue-800 mb-1">
                             <i class="fas fa-lightbulb mr-1"></i>
                             Feedback Insight: ${insights.currentStatus} (${insights.score}%)
                         </div>
                         <div class="text-blue-600">
                             Based on ${insights.feedbackCount} feedback entries
                         </div>
                     `;
                     
                     // Remove existing insight
                     const existingInsight = questionDiv.querySelector('.feedback-insights');
                     if (existingInsight) {
                         existingInsight.remove();
                     }
                     
                     questionDiv.appendChild(insightDiv);
                     
                     // Auto-remove after 10 seconds
                     setTimeout(() => {
                         if (insightDiv.parentElement) {
                             insightDiv.remove();
                         }
                     }, 10000);
                 }
             }
             
             // Update feedback status display
             function updateFeedbackStatusDisplay(questionDiv, questionId) {
                 if (window.getImprovementStatusDisplay) {
                     const feedbackStatus = window.getImprovementStatusDisplay(questionId);
                     const statusBadge = questionDiv.querySelector('.feedback-status-badge');
                     
                     if (statusBadge && feedbackStatus && feedbackStatus.status !== 'unknown') {
                         statusBadge.className = `feedback-status-badge bg-${feedbackStatus.color}-100 text-${feedbackStatus.color}-800 text-xs px-2 py-1 rounded-full flex items-center`;
                         statusBadge.title = feedbackStatus.details;
                         statusBadge.innerHTML = `
                             <i class="fas fa-${feedbackStatus.icon} mr-1"></i>
                             ${feedbackStatus.display}
                         `;
                     }
                 }
             }
            
            // Show extraction summary
            function showExtractionSummary(stats) {
                // Provide default stats object to prevent undefined errors
                const safeStats = stats || {
                    total: 0,
                    withAnswers: 0,
                    averageConfidence: 0,
                    byType: {},
                    byConfidence: {
                        high: 0,
                        medium: 0,
                        low: 0
                    },
                    types: {}
                };
                
                const statusMessage = document.getElementById('status-message');
                if (statusMessage) {
                    statusMessage.innerHTML = `
                        <div class="text-center">
                            <h4 class="font-medium text-green-800 mb-2">Q&A Extraction Complete</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="bg-white p-2 rounded border border-green-200">
                                    <div class="font-semibold text-green-700">${safeStats.total}</div>
                                    <div class="text-gray-600">Total Questions</div>
                                </div>
                                <div class="bg-white p-2 rounded border border-green-200">
                                    <div class="font-semibold text-green-700">${safeStats.withAnswers}</div>
                                    <div class="text-gray-600">With Answers</div>
                                </div>
                                <div class="bg-white p-2 rounded border border-green-200">
                                    <div class="font-semibold text-green-700">${Math.round(safeStats.averageConfidence * 100)}%</div>
                                    <div class="text-gray-600">Avg. Confidence</div>
                                </div>
                                <div class="bg-white p-2 rounded border border-green-200">
                                    <div class="font-semibold text-green-700">${Object.keys(safeStats.types).length}</div>
                                    <div class="text-gray-600">Question Types</div>
                                </div>
                            </div>
                        </div>
                    `;
                    statusMessage.className = 'text-center my-4 p-4 rounded-md font-medium bg-green-100 text-green-800 border border-green-200';
                    statusMessage.style.display = 'block';
                }
            }
            
            // Update button states
            function updateButtonStates() {
                const exportBtn = document.getElementById('export-btn');
                const regenerateBtn = document.getElementById('regenerate-btn');
                const saveOfflineBtn = document.getElementById('save-offline-btn');
                
                // Enable export and save buttons
                if (exportBtn) exportBtn.disabled = false;
                if (saveOfflineBtn) saveOfflineBtn.disabled = false;
                
                // Update regenerate button text based on mode
                if (regenerateBtn) {
                    if (processExtract.checked) {
                        regenerateBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Re-extract';
                        regenerateBtn.disabled = false;
                    } else {
                        regenerateBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Regenerate';
                    }
                }
            }
            
                         // Enhance the generate button functionality
             const originalGenerateHandler = generateBtn.onclick;
             generateBtn.onclick = function(e) {
                 const processingMode = document.querySelector('input[name="file-process-mode"]:checked')?.value || 'generate';
                 
                 log(`Generate button clicked with processing mode: ${processingMode}`, 'info');
                 
                 if (currentFileContent && (processingMode === 'extract' || processingMode === 'both')) {
                     // Extract questions first
                     extractQuestionsFromContent(currentFileContent);
                 }
                 
                 if (processingMode === 'generate' || processingMode === 'both') {
                     // Call original handler for question generation
                     if (originalGenerateHandler) {
                         originalGenerateHandler.call(this, e);
                     }
                 }
                 
                 // If it's 'both', we'll handle the merge in the original handler
                 if (processingMode === 'both' && extractedQuestions.length > 0) {
                     // Store extracted questions for merging
                     window.currentExtractedQuestions = extractedQuestions;
                 }
             };
             
             // Add Extract Q&A button functionality
             const extractQABtn = document.getElementById('extract-qa-btn');
             if (extractQABtn) {
                 extractQABtn.onclick = function(e) {
                     log('Extract Q&A button clicked', 'info');
                     
                     if (!currentFileContent) {
                         alert('Please upload a document first to extract questions and answers from.');
                         return;
                     }
                     
                     // Set extraction mode temporarily
                     processExtract.checked = true;
                     updateExtractionSettings();
                     
                     // Extract questions from current file content
                     extractQuestionsFromContent(currentFileContent);
                 };
             }
            
            // Monitor input type changes to show/hide file processing options
            const inputTypeSelect = document.getElementById('input-type');
            inputTypeSelect.addEventListener('change', function() {
                if (this.value === 'upload') {
                    // Only show options if file is already uploaded
                    const fileName = document.getElementById('file-name');
                    if (fileName && fileName.textContent.trim()) {
                        showFileProcessingOptions();
                    }
                } else {
                    hideFileProcessingOptions();
                }
            });
            
                         // Global helper functions
             window.toggleAnswer = function(button) {
                 const answerDiv = button.parentElement.querySelector('.answer-text');
                 const icon = button.querySelector('i');
                 const text = button.querySelector('span');
                 
                 if (answerDiv.classList.contains('hidden')) {
                     answerDiv.classList.remove('hidden');
                     icon.className = 'fas fa-eye-slash mr-2';
                     text.textContent = 'Hide Answer';
                 } else {
                     answerDiv.classList.add('hidden');
                     icon.className = 'fas fa-eye mr-2';
                     text.textContent = 'Show Answer';
                 }
             };

             // Improve extracted question function
             window.improveExtractedQuestion = function(questionId) {
                 log(`Improving extracted question: ${questionId}`, 'info');
                 
                 const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
                 if (!questionElement) {
                     log('Question element not found', 'error');
                     return;
                 }
                 
                 const questionText = questionElement.querySelector('.question-text')?.textContent;
                 if (!questionText) {
                     log('Question text not found', 'error');
                     return;
                 }
                 
                 // Show improvement in progress
                 const improveBtn = questionElement.querySelector('.improve-question-btn');
                 if (improveBtn) {
                     improveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Enhancing...';
                     improveBtn.disabled = true;
                 }
                 
                 // Use AI to improve the question
                 improveQuestionWithAI(questionText, questionId, 'extracted')
                     .then(improvedQuestion => {
                         if (improvedQuestion) {
                             // Update question display
                             updateQuestionDisplay(questionElement, improvedQuestion);
                             
                             // Record improvement
                             window.recordImprovement(questionId, improvedQuestion);
                             
                             // Show success feedback
                             showImprovementSuccess(questionElement);
                         }
                     })
                     .catch(error => {
                         log(`Error improving question: ${error.message}`, 'error');
                         alert('Error improving question. Please try again.');
                     })
                     .finally(() => {
                         if (improveBtn) {
                             improveBtn.innerHTML = '<i class="fas fa-magic mr-1"></i>Enhance';
                             improveBtn.disabled = false;
                         }
                     });
             };

             // Improve question with AI
             async function improveQuestionWithAI(questionText, questionId, source) {
                 try {
                     // Get current generation parameters and feedback recommendations
                     const recommendations = window.getImprovementRecommendations();
                     
                     // Create improvement prompt
                     const improvementPrompt = `
                         Please improve this ophthalmology question based on the following criteria:
                         
                         Original Question: "${questionText}"
                         
                         Improvement Guidelines:
                         - Make it more clinically relevant and FRCS-appropriate
                         - Ensure medical accuracy and current best practices
                         - Improve clarity and remove ambiguity
                         - Add appropriate difficulty level for specialist training
                         - Include specific ophthalmological terminology where appropriate
                         
                         ${recommendations.length > 0 ? `
                         Current Feedback Recommendations:
                         ${recommendations.map(r => `- ${r.message}`).join('\n')}
                         ` : ''}
                         
                         Please provide the improved question text only, maintaining the same format but with enhanced quality.
                     `;
                     
                     // Use the existing AI service (adapt based on selected model)
                     const aiModel = document.getElementById('ai-model')?.value || 'gemini';
                     
                     // Call appropriate AI service
                     let improvedText;
                     switch (aiModel) {
                         case 'openai':
                             improvedText = await callOpenAIForImprovement(improvementPrompt);
                             break;
                         case 'claude':
                             improvedText = await callClaudeForImprovement(improvementPrompt);
                             break;
                         default:
                             improvedText = await callGeminiForImprovement(improvementPrompt);
                     }
                     
                     return {
                         originalText: questionText,
                         improvedText: improvedText,
                         improvementType: 'ai_enhanced',
                         timestamp: new Date().toISOString(),
                         source: source
                     };
                     
                 } catch (error) {
                     log(`AI improvement failed: ${error.message}`, 'error');
                     throw error;
                 }
             }

             // Placeholder AI improvement functions (to be integrated with existing services)
             async function callGeminiForImprovement(prompt) {
                 // This would integrate with the existing Gemini service
                 log('Calling Gemini for question improvement...', 'info');
                 return `Enhanced: ${prompt.split('Original Question: "')[1]?.split('"')[0] || 'Improved question'}`;
             }

             async function callOpenAIForImprovement(prompt) {
                 // This would integrate with the existing OpenAI service
                 log('Calling OpenAI for question improvement...', 'info');
                 return `Enhanced: ${prompt.split('Original Question: "')[1]?.split('"')[0] || 'Improved question'}`;
             }

             async function callClaudeForImprovement(prompt) {
                 // This would integrate with the existing Claude service
                 log('Calling Claude for question improvement...', 'info');
                 return `Enhanced: ${prompt.split('Original Question: "')[1]?.split('"')[0] || 'Improved question'}`;
             }

             // Update question display with improved content
             function updateQuestionDisplay(questionElement, improvedQuestion) {
                 const questionTextEl = questionElement.querySelector('.question-text');
                 if (questionTextEl && improvedQuestion.improvedText) {
                     questionTextEl.innerHTML = improvedQuestion.improvedText;
                     
                     // Add improvement indicator
                     questionElement.classList.add('improved');
                     
                     // Add improvement badge if not already present
                     const badgeContainer = questionElement.querySelector('.flex.items-center.gap-2');
                     if (badgeContainer && !badgeContainer.querySelector('.improvement-badge')) {
                         const improvementBadge = document.createElement('span');
                         improvementBadge.className = 'improvement-badge bg-green-600 text-white text-xs px-2 py-1 rounded-full flex items-center';
                         improvementBadge.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Improved';
                         badgeContainer.appendChild(improvementBadge);
                     }
                 }
             }

             // Show improvement success feedback
             function showImprovementSuccess(questionElement) {
                 const feedbackContainer = questionElement.querySelector('.feedback-container');
                 if (feedbackContainer) {
                     const successMessage = document.createElement('div');
                     successMessage.className = 'improvement-success bg-green-100 text-green-800 p-2 rounded-md mt-2 text-sm';
                     successMessage.innerHTML = '<i class="fas fa-check mr-1"></i>Question successfully improved!';
                     feedbackContainer.appendChild(successMessage);
                     
                     // Remove success message after 3 seconds
                     setTimeout(() => {
                         if (successMessage.parentNode) {
                             successMessage.parentNode.removeChild(successMessage);
                         }
                     }, 3000);
                 }
             }

             // Enhanced feedback button states with improved visual feedback
             window.updateFeedbackButtonStates = function(questionDiv, feedbackType, feedbackValue) {
                 const feedbackBtns = questionDiv.querySelectorAll(`[data-feedback="${feedbackType}"]`);
                 feedbackBtns.forEach(btn => {
                     btn.classList.remove('active', 'thumbs-up-active', 'thumbs-down-active');
                     btn.style.transform = '';
                     btn.style.backgroundColor = '';
                     btn.style.boxShadow = '';
                     
                     if (btn.getAttribute('data-value') === feedbackValue) {
                         btn.classList.add('active');
                         
                         // Special enhanced styling for thumbs up/down
                         if (feedbackType === 'quality') {
                             if (feedbackValue === 'good') {
                                 btn.classList.add('thumbs-up-active');
                                 btn.style.backgroundColor = 'rgba(34, 197, 94, 0.15)';
                                 btn.style.transform = 'scale(1.15)';
                                 btn.style.boxShadow = '0 4px 8px rgba(34, 197, 94, 0.3)';
                             } else if (feedbackValue === 'poor') {
                                 btn.classList.add('thumbs-down-active');
                                 btn.style.backgroundColor = 'rgba(239, 68, 68, 0.15)';
                                 btn.style.transform = 'scale(1.15)';
                                 btn.style.boxShadow = '0 4px 8px rgba(239, 68, 68, 0.3)';
                             }
                         } else if (feedbackType === 'relevance') {
                             if (feedbackValue === 'yes') {
                                 btn.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
                                 btn.style.transform = 'scale(1.1)';
                                 btn.style.boxShadow = '0 2px 6px rgba(59, 130, 246, 0.3)';
                             } else if (feedbackValue === 'no') {
                                 btn.style.backgroundColor = 'rgba(245, 158, 11, 0.15)';
                                 btn.style.transform = 'scale(1.1)';
                                 btn.style.boxShadow = '0 2px 6px rgba(245, 158, 11, 0.3)';
                             }
                         }
                         
                         // Add success animation
                         btn.style.animation = 'feedbackPulse 0.6s ease';
                         setTimeout(() => {
                             btn.style.animation = '';
                         }, 600);
                     }
                 });
                 
                 // Update feedback summary and analytics
                 updateQuestionFeedbackSummary(questionDiv, feedbackType, feedbackValue);
             };
             
             // Enhanced feedback summary display
             function updateQuestionFeedbackSummary(questionDiv, feedbackType, feedbackValue) {
                 let summaryDiv = questionDiv.querySelector('.feedback-summary');
                 if (!summaryDiv) {
                     summaryDiv = document.createElement('div');
                     summaryDiv.className = 'feedback-summary mt-2 p-2 bg-gray-50 rounded text-xs border border-gray-200';
                     questionDiv.querySelector('.feedback-container').appendChild(summaryDiv);
                 }
                 
                 const questionId = questionDiv.getAttribute('data-question-id') || questionDiv.id;
                 const feedbackCount = getQuestionFeedbackCount(questionId);
                 
                 const positiveScore = Math.round(
                     ((feedbackCount.quality.good + feedbackCount.relevance.yes) / 
                     Math.max(1, feedbackCount.total)) * 100
                 );
                 
                 summaryDiv.innerHTML = `
                     <div class="flex items-center justify-between">
                         <div class="flex items-center gap-3">
                             <span class="flex items-center font-medium">
                                 <i class="fas fa-chart-bar mr-1 text-gray-500"></i>
                                 ${feedbackCount.total} feedback
                             </span>
                             <div class="flex items-center gap-2">
                                 ${feedbackCount.quality.good > 0 ? `<span class="bg-green-100 text-green-800 px-1.5 py-0.5 rounded-full text-xs">👍 ${feedbackCount.quality.good}</span>` : ''}
                                 ${feedbackCount.quality.poor > 0 ? `<span class="bg-red-100 text-red-800 px-1.5 py-0.5 rounded-full text-xs">👎 ${feedbackCount.quality.poor}</span>` : ''}
                                 ${feedbackCount.relevance.yes > 0 ? `<span class="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded-full text-xs">✓ ${feedbackCount.relevance.yes}</span>` : ''}
                                 ${feedbackCount.relevance.no > 0 ? `<span class="bg-orange-100 text-orange-800 px-1.5 py-0.5 rounded-full text-xs">✗ ${feedbackCount.relevance.no}</span>` : ''}
                             </div>
                         </div>
                         <div class="flex items-center">
                             <span class="text-xs font-medium ${positiveScore >= 70 ? 'text-green-600' : positiveScore >= 40 ? 'text-yellow-600' : 'text-red-600'}">
                                 ${positiveScore}% positive
                             </span>
                         </div>
                     </div>
                 `;
             }
             
             // Get feedback count for a specific question
             function getQuestionFeedbackCount(questionId) {
                 if (!window.continuousImprovementSystem) {
                     return { total: 0, quality: { good: 0, poor: 0 }, relevance: { yes: 0, no: 0 } };
                 }
                 
                 const feedbackLog = window.continuousImprovementSystem.getFeedbackLog();
                 const questionFeedback = feedbackLog.filter(f => f.questionId === questionId);
                 
                 const count = {
                     total: questionFeedback.length,
                     quality: { good: 0, poor: 0 },
                     relevance: { yes: 0, no: 0 }
                 };
                 
                 questionFeedback.forEach(feedback => {
                     if (feedback.type === 'quality') {
                         count.quality[feedback.value] = (count.quality[feedback.value] || 0) + 1;
                     } else if (feedback.type === 'relevance') {
                         count.relevance[feedback.value] = (count.relevance[feedback.value] || 0) + 1;
                     }
                 });
                 
                 return count;
             }

             // Show feedback thank you message
             window.showFeedbackThankYou = function(questionDiv) {
                 const feedbackContainer = questionDiv.querySelector('.feedback-container');
                 if (feedbackContainer) {
                     let thankYouMsg = feedbackContainer.querySelector('.feedback-thank-you');
                     if (!thankYouMsg) {
                         thankYouMsg = document.createElement('div');
                         thankYouMsg.className = 'feedback-thank-you text-green-600 text-xs mt-1';
                         thankYouMsg.textContent = 'Thank you for your feedback!';
                         feedbackContainer.appendChild(thankYouMsg);
                     }
                     
                     // Remove after animation
                     setTimeout(() => {
                         if (thankYouMsg.parentNode) {
                             thankYouMsg.parentNode.removeChild(thankYouMsg);
                         }
                     }, 3000);
                 }
             };

             // Record question generation session
             function recordQuestionSession(questions, parameters, source) {
                 if (window.enhancedFeedbackSystem) {
                     // Fix the structure to match what recordGenerationSession expects
                     window.enhancedFeedbackSystem.recordGenerationSession(
                         parameters, 
                         {
                             questions: questions,
                             averageConfidence: 0.7,
                             generationTime: Date.now(),
                             errors: []
                         },
                         {
                             source: source,
                             success: questions.length > 0,
                             sessionLength: 0
                         }
                     );
                 }
             }

                         // Enhanced hook into existing question generation with content analysis
            function hookIntoQuestionGeneration() {
                const originalGenerateHandler = generateBtn.onclick;
                generateBtn.onclick = function(e) {
                    // Record generation parameters
                    const parameters = {
                        inputType: document.getElementById('input-type')?.value,
                        knowledgeArea: document.getElementById('knowledge-area')?.value,
                        difficulty: document.getElementById('difficulty')?.value,
                        numQuestions: document.getElementById('num-questions')?.value,
                        processingMode: document.querySelector('input[name="file-process-mode"]:checked')?.value,
                        usmleMode: document.getElementById('usmle-mode')?.checked || false,
                        loadKanski: document.getElementById('load-kanski')?.checked || false
                    };
                    
                    // Get source content for analysis
                    let sourceContent = '';
                    const inputType = parameters.inputType;
                    
                    if (inputType === 'text') {
                        sourceContent = document.getElementById('input-text')?.value || '';
                    } else if (inputType === 'upload' && window.currentFileContent) {
                        sourceContent = window.currentFileContent;
                    }
                    
                    // Perform content analysis and show insights BEFORE generation
                    if (sourceContent && sourceContent.trim().length > 50) {
                        log('🧠 Analyzing source content for creative question generation...', 'info');
                        const diversityGuidance = window.showContentAnalysisForGeneration(sourceContent);
                        
                        // Store guidance for AI systems to use
                        window.currentDiversityGuidance = diversityGuidance;
                        
                        // Add creative diversity prompts to global parameters
                        window.creativeDiversityPrompts = diversityGuidance.diversityPrompts;
                        window.sourceAnalysis = diversityGuidance.contentAnalysis;
                        window.creativeAngles = diversityGuidance.creativeAngles;
                        
                        log(`🎯 Identified ${diversityGuidance.creativeAngles.length} creative angles and ${diversityGuidance.diversityPrompts.length} diversity suggestions`, 'success');
                    }
                    
                    // Update global generation parameters for use by the generation system
                    if (window.generationModes) {
                        window.generationModes.usmleMode = parameters.usmleMode;
                        window.generationModes.kanskiMode = parameters.loadKanski;
                        window.generationModes.creativeDiversity = true; // Enable enhanced creativity
                    } else {
                        window.generationModes = {
                            usmleMode: parameters.usmleMode,
                            kanskiMode: parameters.loadKanski,
                            creativeDiversity: true
                        };
                    }

                    // Set enhanced global parameters that the generation system can access
                    window.currentGenerationParams = {
                        ...parameters,
                        sourceContent: sourceContent,
                        hasContentAnalysis: sourceContent.trim().length > 50,
                        diversityEnabled: true
                    };
                    
                    // Log the current generation configuration
                    if (parameters.usmleMode || parameters.loadKanski) {
                        const modes = [];
                        if (parameters.usmleMode) modes.push('USMLE Mode (All medical/surgical)');
                        if (parameters.loadKanski) modes.push('Kanski 1st Edition');
                        log(`Special generation modes enabled: ${modes.join(', ')}`, 'info');
                    }
                    
                    if (sourceContent.trim().length > 50) {
                        log('📚 Enhanced creative generation mode activated with source analysis', 'info');
                    }
                    
                    // Call original handler
                    if (originalGenerateHandler) {
                        const result = originalGenerateHandler.call(this, e);
                        
                        // Record session after generation
                        setTimeout(() => {
                            const questions = Array.from(qaContainer.querySelectorAll('.question-item')).map(q => ({
                                id: q.getAttribute('data-question-id'),
                                type: q.getAttribute('data-type'),
                                source: q.getAttribute('data-source')
                            }));
                            
                            recordQuestionSession(questions, parameters, parameters.inputType);
                            
                            // Show diversity summary after generation
                            if (window.currentDiversityGuidance && questions.length > 0) {
                                showPostGenerationDiversityInsights(questions.length);
                            }
                        }, 1000);
                        
                        return result;
                    }
                };
            }
            
            // Show diversity insights after generation
            function showPostGenerationDiversityInsights(questionCount) {
                const container = document.getElementById('qa-container');
                if (!container) return;
                
                const innovationScore = calculateInnovationScore();
                
                // Create post-generation insights
                const insightDiv = document.createElement('div');
                insightDiv.className = 'post-generation-insights bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4';
                insightDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                            <div>
                                <span class="text-sm font-medium text-purple-800">Generated ${questionCount} questions</span>
                                <span class="text-xs text-purple-600 ml-2">Innovation Score: ${innovationScore.overall}%</span>
                            </div>
                        </div>
                        <button class="text-xs text-purple-500 hover:text-purple-700" onclick="this.closest('.post-generation-insights').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-purple-600">
                        Format diversity: ${innovationScore.format}% | Topic diversity: ${innovationScore.topic}% | Approach diversity: ${innovationScore.approach}%
                    </div>
                `;
                
                container.insertBefore(insightDiv, container.firstChild);
                
                // Auto-dismiss after 10 seconds
                setTimeout(() => {
                    if (insightDiv.parentElement) {
                        insightDiv.remove();
                    }
                }, 10000);
            }

                         // Initialize hooks
            hookIntoQuestionGeneration();
            
            // Enhanced global function for AI generation system with context-aware creativity
            window.getQuestionDiversityGuidance = function(sourceContent = '') {
                const suggestions = getInnovationSuggestions();
                const recentPatterns = {
                    formats: questionPatternHistory.formats.slice(-10),
                    topics: questionPatternHistory.topics.slice(-10),
                    approaches: questionPatternHistory.approaches.slice(-10),
                    structures: questionPatternHistory.structures.slice(-10)
                };
                
                // Analyze source content for creative angles
                const contentAnalysis = analyzeSourceContent(sourceContent);
                
                // Generate context-aware diversity prompts for AI
                const diversityPrompts = [];
                const creativeAngles = generateCreativeAngles(contentAnalysis);
                
                // Add creative angle prompts
                if (creativeAngles.length > 0) {
                    diversityPrompts.push(`Explore these creative angles from the source material: ${creativeAngles.join('; ')}. Each question should offer a unique perspective while staying true to the content.`);
                }
                
                // Format diversity prompts
                const overusedFormats = recentPatterns.formats.filter((format, index, arr) => 
                    arr.filter(f => f === format).length > 3
                );
                
                if (overusedFormats.length > 0) {
                    diversityPrompts.push(`Avoid these overused question formats: ${[...new Set(overusedFormats)].join(', ')}. Instead, use creative formats like case scenarios, image interpretation, differential diagnosis challenges, or pathophysiology explanations.`);
                }
                
                // Topic diversity prompts with source-specific suggestions
                const overusedTopics = recentPatterns.topics.filter((topic, index, arr) => 
                    arr.filter(t => t === topic).length > 4
                );
                
                if (overusedTopics.length > 0 && contentAnalysis.topics.length > 0) {
                    const availableTopics = contentAnalysis.topics.filter(topic => !overusedTopics.includes(topic));
                    if (availableTopics.length > 0) {
                        diversityPrompts.push(`Branch out from recently covered topics (${[...new Set(overusedTopics)].join(', ')}) to these available topics from the source: ${availableTopics.join(', ')}.`);
                    }
                }
                
                // Approach diversity prompts
                const approachFreq = {};
                recentPatterns.approaches.forEach(approach => {
                    approachFreq[approach] = (approachFreq[approach] || 0) + 1;
                });
                
                if (approachFreq.clinical > 6) {
                    diversityPrompts.push('Mix clinical questions with basic science concepts, surgical techniques, pathophysiology mechanisms, pharmacological principles, and imaging interpretation challenges.');
                }
                
                // Structure diversity prompts
                const simpleQuestions = recentPatterns.structures.filter(s => s === 'simple').length;
                if (simpleQuestions > 7) {
                    diversityPrompts.push('Create more complex, multi-step questions that require integrated thinking and clinical reasoning rather than simple recall.');
                }
                
                // Add source-specific creative prompts
                diversityPrompts.push(...generateSourceSpecificPrompts(contentAnalysis));
                
                return {
                    suggestions: suggestions,
                    diversityPrompts: diversityPrompts,
                    recentPatterns: recentPatterns,
                    innovationScore: calculateInnovationScore(),
                    recommendedFormats: getRecommendedFormats(),
                    recommendedTopics: getRecommendedTopics(),
                    contentAnalysis: contentAnalysis,
                    creativeAngles: creativeAngles,
                    sourceSpecificSuggestions: generateSourceSpecificSuggestions(contentAnalysis)
                };
            };
            
            function calculateInnovationScore() {
                const recent = 10;
                const recentFormats = questionPatternHistory.formats.slice(-recent);
                const recentTopics = questionPatternHistory.topics.slice(-recent);
                const recentApproaches = questionPatternHistory.approaches.slice(-recent);
                
                // Calculate diversity scores (higher = more diverse)
                const formatDiversity = new Set(recentFormats).size / Math.min(recent, recentFormats.length);
                const topicDiversity = new Set(recentTopics).size / Math.min(recent, recentTopics.length);
                const approachDiversity = new Set(recentApproaches).size / Math.min(recent, recentApproaches.length);
                
                // Overall innovation score (0-100)
                const score = Math.round((formatDiversity + topicDiversity + approachDiversity) / 3 * 100);
                
                return {
                    overall: score,
                    format: Math.round(formatDiversity * 100),
                    topic: Math.round(topicDiversity * 100),
                    approach: Math.round(approachDiversity * 100)
                };
            }
            
            function getRecommendedFormats() {
                const recentFormats = questionPatternHistory.formats.slice(-10);
                const allFormats = ['multiple_choice_which', 'most_likely', 'case_presentation', 'treatment_choice', 'differential', 'complication', 'management', 'pathophysiology', 'imaging_interpretation', 'surgical_technique'];
                
                // Recommend formats not used recently
                return allFormats.filter(format => 
                    recentFormats.filter(f => f === format).length < 2
                ).slice(0, 5);
            }
            
            function getRecommendedTopics() {
                const recentTopics = questionPatternHistory.topics.slice(-10);
                const allTopics = ['retina', 'cornea', 'lens', 'glaucoma', 'cataract', 'macula', 'vitreous', 'optic', 'uvea', 'conjunctiva', 'sclera', 'choroid', 'pediatric', 'oculoplastics', 'neuro_ophthalmology'];
                
                // Recommend topics not covered recently
                return allTopics.filter(topic => 
                    recentTopics.filter(t => t === topic).length < 2
                ).slice(0, 5);
            }
            
            // Advanced content analysis for creative question generation
            function analyzeSourceContent(content) {
                if (!content || content.trim().length === 0) {
                    return {
                        topics: [],
                        concepts: [],
                        procedures: [],
                        conditions: [],
                        medications: [],
                        anatomy: [],
                        symptoms: [],
                        diagnostics: [],
                        relationships: [],
                        complexConcepts: []
                    };
                }
                
                const text = content.toLowerCase();
                
                // Extract ophthalmology-specific elements
                const analysis = {
                    // Primary topics/subspecialties
                    topics: extractMatches(text, [
                        'retina', 'retinal', 'macula', 'macular', 'cornea', 'corneal', 'lens', 'lenticular',
                        'glaucoma', 'cataract', 'vitreous', 'vitreal', 'optic nerve', 'optic disc',
                        'uvea', 'uveitis', 'conjunctiva', 'conjunctival', 'sclera', 'scleral',
                        'choroid', 'choroidal', 'iris', 'pupil', 'anterior chamber', 'posterior chamber',
                        'pediatric', 'oculoplastic', 'neuro-ophthalmology', 'strabismus', 'amblyopia'
                    ]),
                    
                    // Medical concepts and processes
                    concepts: extractMatches(text, [
                        'pathophysiology', 'etiology', 'pathogenesis', 'inflammation', 'infection',
                        'autoimmune', 'hereditary', 'genetic', 'congenital', 'acquired',
                        'acute', 'chronic', 'progressive', 'degenerative', 'proliferative',
                        'ischemia', 'hypoxia', 'oxidative stress', 'angiogenesis', 'fibrosis'
                    ]),
                    
                    // Procedures and treatments
                    procedures: extractMatches(text, [
                        'surgery', 'surgical', 'vitrectomy', 'cataract extraction', 'phacoemulsification',
                        'trabeculectomy', 'iridotomy', 'laser', 'photocoagulation', 'injection',
                        'intravitreal', 'topical', 'systemic', 'oral', 'drops', 'ointment',
                        'implant', 'lens replacement', 'corneal transplant', 'keratoplasty'
                    ]),
                    
                    // Specific conditions
                    conditions: extractMatches(text, [
                        'diabetic retinopathy', 'age-related macular degeneration', 'amd',
                        'glaucoma', 'primary open-angle', 'angle-closure', 'keratitis',
                        'endophthalmitis', 'retinal detachment', 'macular hole', 'epiretinal membrane',
                        'central serous', 'branch retinal vein occlusion', 'central retinal artery occlusion',
                        'anterior ischemic optic neuropathy', 'papilledema', 'optic neuritis'
                    ]),
                    
                    // Medications and drugs
                    medications: extractMatches(text, [
                        'anti-vegf', 'bevacizumab', 'ranibizumab', 'aflibercept', 'steroid', 'prednisolone',
                        'dexamethasone', 'triamcinolone', 'antibiotic', 'antifungal', 'antiviral',
                        'immunosuppressive', 'methotrexate', 'cyclosporine', 'tacrolimus',
                        'timolol', 'latanoprost', 'brimonidine', 'dorzolamide', 'acetazolamide'
                    ]),
                    
                    // Anatomical structures
                    anatomy: extractMatches(text, [
                        'fovea', 'macula', 'optic disc', 'optic nerve', 'retinal pigment epithelium',
                        'photoreceptors', 'rods', 'cones', 'ganglion cells', 'nerve fiber layer',
                        'choroidal neovascularization', 'bruch membrane', 'internal limiting membrane',
                        'trabecular meshwork', 'schlemm canal', 'ciliary body', 'zonules'
                    ]),
                    
                    // Symptoms and signs
                    symptoms: extractMatches(text, [
                        'visual field defect', 'scotoma', 'metamorphopsia', 'photophobia', 'diplopia',
                        'blurred vision', 'decreased vision', 'night blindness', 'color vision',
                        'flashing lights', 'floaters', 'pain', 'redness', 'discharge', 'tearing',
                        'dry eye', 'foreign body sensation', 'itching', 'burning'
                    ]),
                    
                    // Diagnostic methods
                    diagnostics: extractMatches(text, [
                        'oct', 'optical coherence tomography', 'fluorescein angiography', 'fundus photography',
                        'visual field testing', 'perimetry', 'electroretinography', 'erg',
                        'ultrasound', 'mri', 'ct scan', 'gonioscopy', 'pachymetry',
                        'tonometry', 'biomicroscopy', 'ophthalmoscopy', 'slit lamp'
                    ]),
                    
                    // Find relationships and complex concepts
                    relationships: findConceptRelationships(text),
                    complexConcepts: findComplexConcepts(text)
                };
                
                // Remove duplicates and empty results
                Object.keys(analysis).forEach(key => {
                    if (Array.isArray(analysis[key])) {
                        analysis[key] = [...new Set(analysis[key])].filter(item => item && item.length > 0);
                    }
                });
                
                return analysis;
            }
            
            function extractMatches(text, keywords) {
                const matches = [];
                keywords.forEach(keyword => {
                    if (text.includes(keyword.toLowerCase())) {
                        matches.push(keyword);
                    }
                });
                return matches;
            }
            
            function findConceptRelationships(text) {
                const relationships = [];
                
                // Common medical relationships
                const relationshipPatterns = [
                    { pattern: /(\w+)\s+causes?\s+(\w+)/, type: 'causation' },
                    { pattern: /(\w+)\s+leads?\s+to\s+(\w+)/, type: 'progression' },
                    { pattern: /(\w+)\s+associated\s+with\s+(\w+)/, type: 'association' },
                    { pattern: /(\w+)\s+treatment\s+for\s+(\w+)/, type: 'treatment' },
                    { pattern: /(\w+)\s+complication\s+of\s+(\w+)/, type: 'complication' },
                    { pattern: /(\w+)\s+contraindicated\s+in\s+(\w+)/, type: 'contraindication' }
                ];
                
                relationshipPatterns.forEach(({ pattern, type }) => {
                    const matches = text.match(pattern);
                    if (matches) {
                        relationships.push({
                            type: type,
                            from: matches[1],
                            to: matches[2],
                            relationship: `${matches[1]} ${type} ${matches[2]}`
                        });
                    }
                });
                
                return relationships;
            }
            
            function findComplexConcepts(text) {
                const complexConcepts = [];
                
                // Look for multi-word medical concepts
                const complexPatterns = [
                    /\b\w+\s+retinopathy\b/g,
                    /\b\w+\s+degeneration\b/g,
                    /\b\w+\s+syndrome\b/g,
                    /\b\w+\s+disease\b/g,
                    /\b\w+\s+dystrophy\b/g,
                    /\b\w+\s+neuropathy\b/g,
                    /\b\w+\s+keratitis\b/g,
                    /\b\w+\s+uveitis\b/g
                ];
                
                complexPatterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        complexConcepts.push(...matches);
                    }
                });
                
                return [...new Set(complexConcepts)];
            }
            
            // Generate creative angles based on content analysis
            function generateCreativeAngles(contentAnalysis) {
                const angles = [];
                
                // Pathophysiology angle
                if (contentAnalysis.concepts.length > 0 && contentAnalysis.conditions.length > 0) {
                    angles.push('Explore the underlying pathophysiology mechanisms');
                }
                
                // Differential diagnosis angle
                if (contentAnalysis.conditions.length > 1) {
                    angles.push('Create differential diagnosis scenarios with overlapping presentations');
                }
                
                // Treatment decision angle
                if (contentAnalysis.procedures.length > 0 && contentAnalysis.medications.length > 0) {
                    angles.push('Design treatment decision-making scenarios');
                }
                
                // Complication prevention angle
                if (contentAnalysis.procedures.length > 0) {
                    angles.push('Focus on complication recognition and prevention');
                }
                
                // Multi-system integration angle
                if (contentAnalysis.anatomy.length > 2) {
                    angles.push('Integrate multiple anatomical systems and their interactions');
                }
                
                // Diagnostic interpretation angle
                if (contentAnalysis.diagnostics.length > 0) {
                    angles.push('Create diagnostic interpretation and correlation challenges');
                }
                
                // Case progression angle
                if (contentAnalysis.symptoms.length > 0 && contentAnalysis.conditions.length > 0) {
                    angles.push('Design progressive case scenarios showing disease evolution');
                }
                
                // Relationship exploration angle
                if (contentAnalysis.relationships.length > 0) {
                    angles.push('Explore cause-effect relationships and medical correlations');
                }
                
                // Evidence-based medicine angle
                if (contentAnalysis.procedures.length > 0 || contentAnalysis.medications.length > 0) {
                    angles.push('Incorporate evidence-based treatment selection and guidelines');
                }
                
                // Patient management angle
                if (contentAnalysis.conditions.length > 0) {
                    angles.push('Create comprehensive patient management scenarios');
                }
                
                return angles.slice(0, 5); // Return top 5 most relevant angles
            }
            
            // Generate source-specific prompts
            function generateSourceSpecificPrompts(contentAnalysis) {
                const prompts = [];
                
                // Topic-specific prompts
                if (contentAnalysis.topics.length > 0) {
                    prompts.push(`Create questions that interconnect these topics from the source: ${contentAnalysis.topics.slice(0, 3).join(', ')}. Show how they relate to each other in clinical practice.`);
                }
                
                // Condition-specific prompts
                if (contentAnalysis.conditions.length > 1) {
                    prompts.push(`Develop comparative questions between these conditions: ${contentAnalysis.conditions.slice(0, 3).join(', ')}. Focus on distinguishing features and management differences.`);
                }
                
                // Procedure-specific prompts
                if (contentAnalysis.procedures.length > 0) {
                    prompts.push(`Create questions about indications, contraindications, and outcomes for: ${contentAnalysis.procedures.slice(0, 2).join(', ')}.`);
                }
                
                // Diagnostic-specific prompts
                if (contentAnalysis.diagnostics.length > 0) {
                    prompts.push(`Design interpretation questions using these diagnostic methods: ${contentAnalysis.diagnostics.slice(0, 2).join(', ')}. Include normal vs abnormal findings.`);
                }
                
                // Complex concept prompts
                if (contentAnalysis.complexConcepts.length > 0) {
                    prompts.push(`Explore these complex medical concepts in depth: ${contentAnalysis.complexConcepts.slice(0, 2).join(', ')}. Create multi-layered questions that test understanding.`);
                }
                
                return prompts;
            }
            
            // Generate source-specific suggestions
            function generateSourceSpecificSuggestions(contentAnalysis) {
                const suggestions = [];
                
                // Suggest question types based on content
                if (contentAnalysis.procedures.length > 0) {
                    suggestions.push({
                        type: 'procedure_focus',
                        message: 'Source contains procedural information - create step-by-step, indication, and complication questions',
                        formats: ['surgical_steps', 'indication_selection', 'complication_management']
                    });
                }
                
                if (contentAnalysis.conditions.length > 2) {
                    suggestions.push({
                        type: 'differential_potential',
                        message: 'Multiple conditions detected - excellent for differential diagnosis questions',
                        formats: ['differential_diagnosis', 'comparative_analysis', 'case_progression']
                    });
                }
                
                if (contentAnalysis.diagnostics.length > 1) {
                    suggestions.push({
                        type: 'diagnostic_interpretation',
                        message: 'Rich diagnostic content - create interpretation and correlation questions',
                        formats: ['image_interpretation', 'test_correlation', 'diagnostic_workup']
                    });
                }
                
                if (contentAnalysis.medications.length > 0) {
                    suggestions.push({
                        type: 'pharmacological_focus',
                        message: 'Medication information available - create dosing, indication, and interaction questions',
                        formats: ['drug_selection', 'dosing_scenarios', 'adverse_effects']
                    });
                }
                
                if (contentAnalysis.relationships.length > 0) {
                    suggestions.push({
                        type: 'relationship_based',
                        message: 'Causal relationships identified - create mechanistic and reasoning questions',
                        formats: ['cause_effect', 'mechanism_based', 'logical_reasoning']
                    });
                }
                
                return suggestions;
            }
             
             log('Q&A Extraction system and Enhanced Feedback System initialized', 'success');
        });
    </script>

    <!-- Script to check for repeated questions during generation -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Store generated questions to check for duplicates
            let questionHistory = [];
            let isDeepSearchActive = false;
            let isSelectionModeActive = false;
            
            // Enhanced question innovation tracking
            let questionPatternHistory = {
                formats: [],        // Track question formats used
                topics: [],         // Track topics covered
                approaches: [],     // Track different approaches to same topic
                structures: []      // Track question structures
            };
            
            // Innovation enhancement functions
            function analyzeQuestionPattern(questionText) {
                const patterns = {
                    format: '',
                    topic: '',
                    approach: '',
                    structure: ''
                };
                
                const text = questionText.toLowerCase();
                
                // Identify question format
                if (text.includes('which of the following')) patterns.format = 'multiple_choice_which';
                else if (text.includes('what is the most')) patterns.format = 'most_likely';
                else if (text.includes('patient presents with')) patterns.format = 'case_presentation';
                else if (text.includes('best treatment')) patterns.format = 'treatment_choice';
                else if (text.includes('differential diagnosis')) patterns.format = 'differential';
                else if (text.includes('complication')) patterns.format = 'complication';
                else if (text.includes('management')) patterns.format = 'management';
                else patterns.format = 'general';
                
                // Extract medical topics
                const medicalTopics = text.match(/\b(retina|cornea|lens|glaucoma|cataract|macula|vitreous|optic|uvea|conjunctiva|sclera|choroid|diabetes|hypertension|infection|inflammation|trauma|surgery|medication|imaging)\b/g);
                patterns.topic = medicalTopics ? medicalTopics[0] : 'general';
                
                // Identify approach
                if (text.includes('pathophysiology')) patterns.approach = 'pathophysiology';
                else if (text.includes('clinical')) patterns.approach = 'clinical';
                else if (text.includes('anatomical')) patterns.approach = 'anatomical';
                else if (text.includes('surgical')) patterns.approach = 'surgical';
                else if (text.includes('pharmacological')) patterns.approach = 'pharmacological';
                else patterns.approach = 'general';
                
                // Analyze structure
                const sentences = questionText.split('.').length;
                if (sentences <= 2) patterns.structure = 'simple';
                else if (sentences <= 4) patterns.structure = 'moderate';
                else patterns.structure = 'complex';
                
                return patterns;
            }
            
            function updatePatternHistory(pattern) {
                questionPatternHistory.formats.push(pattern.format);
                questionPatternHistory.topics.push(pattern.topic);
                questionPatternHistory.approaches.push(pattern.approach);
                questionPatternHistory.structures.push(pattern.structure);
                
                // Keep only recent patterns (last 50 questions)
                Object.keys(questionPatternHistory).forEach(key => {
                    if (questionPatternHistory[key].length > 50) {
                        questionPatternHistory[key] = questionPatternHistory[key].slice(-50);
                    }
                });
            }
            
            function getInnovationSuggestions() {
                const suggestions = [];
                
                // Analyze pattern frequency
                const formatCounts = {};
                questionPatternHistory.formats.forEach(format => {
                    formatCounts[format] = (formatCounts[format] || 0) + 1;
                });
                
                // Find overused patterns
                const recentFormats = questionPatternHistory.formats.slice(-10);
                const overusedFormats = Object.keys(formatCounts).filter(format => 
                    formatCounts[format] > 15 && recentFormats.filter(f => f === format).length > 3
                );
                
                if (overusedFormats.length > 0) {
                    suggestions.push({
                        type: 'format_diversity',
                        message: `Try varying question formats. Recently overused: ${overusedFormats.join(', ')}`,
                        alternatives: ['case_presentation', 'differential', 'management', 'pathophysiology', 'imaging_interpretation']
                    });
                }
                
                // Check topic diversity
                const topicCounts = {};
                questionPatternHistory.topics.forEach(topic => {
                    topicCounts[topic] = (topicCounts[topic] || 0) + 1;
                });
                
                const recentTopics = questionPatternHistory.topics.slice(-10);
                const overusedTopics = Object.keys(topicCounts).filter(topic => 
                    recentTopics.filter(t => t === topic).length > 4
                );
                
                if (overusedTopics.length > 0) {
                    suggestions.push({
                        type: 'topic_diversity',
                        message: `Consider exploring different subspecialties. Recently focused on: ${overusedTopics.join(', ')}`,
                        alternatives: ['pediatric_ophthalmology', 'oculoplastics', 'neuro_ophthalmology', 'retinal_disorders', 'anterior_segment']
                    });
                }
                
                // Check approach diversity
                const approachCounts = {};
                questionPatternHistory.approaches.forEach(approach => {
                    approachCounts[approach] = (approachCounts[approach] || 0) + 1;
                });
                
                const recentApproaches = questionPatternHistory.approaches.slice(-10);
                if (recentApproaches.filter(a => a === 'clinical').length > 6) {
                    suggestions.push({
                        type: 'approach_diversity',
                        message: 'Try mixing clinical questions with basic science, pathophysiology, or surgical approaches',
                        alternatives: ['pathophysiology', 'anatomical', 'surgical', 'pharmacological', 'imaging']
                    });
                }
                
                return suggestions;
            }
            
            // Enhanced question tracking for innovation
            function trackQuestionForInnovation(questionText) {
                const pattern = analyzeQuestionPattern(questionText);
                updatePatternHistory(pattern);
                
                // Add to history
                questionHistory.push(questionText.toLowerCase().trim().replace(/\s+/g, ' '));
                
                // Keep history manageable
                if (questionHistory.length > 100) {
                    questionHistory = questionHistory.slice(-100);
                }
                
                // Check for innovation opportunities
                const suggestions = getInnovationSuggestions();
                if (suggestions.length > 0) {
                    displayInnovationSuggestions(suggestions);
                }
            }
            
            function displayInnovationSuggestions(suggestions) {
                const container = document.getElementById('qa-container');
                if (!container) return;
                
                // Remove existing suggestion
                const existing = container.querySelector('.innovation-suggestions');
                if (existing) existing.remove();
                
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'innovation-suggestions bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4';
                suggestionDiv.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas fa-lightbulb text-blue-600 mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800 mb-2">Innovation Suggestions</h4>
                            ${suggestions.map(suggestion => `
                                <div class="mb-2">
                                    <p class="text-sm text-blue-700">${suggestion.message}</p>
                                    ${suggestion.alternatives ? `
                                        <div class="mt-1">
                                            <span class="text-xs text-blue-600">Try: </span>
                                            ${suggestion.alternatives.map(alt => 
                                                `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1">${alt.replace(/_/g, ' ')}</span>`
                                            ).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                            <button class="text-xs text-blue-500 hover:text-blue-700 mt-2" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <i class="fas fa-times mr-1"></i>Dismiss
                            </button>
                        </div>
                    </div>
                `;
                
                container.insertBefore(suggestionDiv, container.firstChild);
                
                // Auto-dismiss after 15 seconds
                setTimeout(() => {
                    if (suggestionDiv.parentElement) {
                        suggestionDiv.remove();
                    }
                }, 15000);
            }
            
            // Display content analysis insights for user feedback
            function displayContentAnalysisInsights(contentAnalysis, creativeAngles) {
                const container = document.getElementById('qa-container');
                if (!container || !contentAnalysis || Object.keys(contentAnalysis).every(key => contentAnalysis[key].length === 0)) return;
                
                // Remove existing insights
                const existing = container.querySelector('.content-analysis-insights');
                if (existing) existing.remove();
                
                const insightDiv = document.createElement('div');
                insightDiv.className = 'content-analysis-insights bg-green-50 border border-green-200 rounded-lg p-4 mb-4';
                
                // Generate insights HTML
                let insightsHTML = `
                    <div class="flex items-start">
                        <i class="fas fa-brain text-green-600 mt-1 mr-3"></i>
                        <div class="flex-1">
                            <h4 class="font-semibold text-green-800 mb-2">🎯 Content Analysis & Creative Angles</h4>
                            <p class="text-sm text-green-700 mb-3">AI analyzed your source material and identified these creative opportunities:</p>
                `;
                
                // Show creative angles
                if (creativeAngles.length > 0) {
                    insightsHTML += `
                        <div class="mb-3">
                            <h5 class="text-sm font-medium text-green-800 mb-1">💡 Creative Angles Discovered:</h5>
                            <div class="flex flex-wrap gap-1">
                                ${creativeAngles.map(angle => 
                                    `<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded">${angle}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Show content breakdown
                const contentSummary = [];
                if (contentAnalysis.topics.length > 0) contentSummary.push(`${contentAnalysis.topics.length} topics`);
                if (contentAnalysis.conditions.length > 0) contentSummary.push(`${contentAnalysis.conditions.length} conditions`);
                if (contentAnalysis.procedures.length > 0) contentSummary.push(`${contentAnalysis.procedures.length} procedures`);
                if (contentAnalysis.medications.length > 0) contentSummary.push(`${contentAnalysis.medications.length} medications`);
                if (contentAnalysis.diagnostics.length > 0) contentSummary.push(`${contentAnalysis.diagnostics.length} diagnostic methods`);
                
                if (contentSummary.length > 0) {
                    insightsHTML += `
                        <div class="mb-3">
                            <h5 class="text-sm font-medium text-green-800 mb-1">📊 Content Richness:</h5>
                            <p class="text-xs text-green-600">Detected: ${contentSummary.join(', ')}</p>
                        </div>
                    `;
                }
                
                // Show specific elements found
                const elementsToShow = ['conditions', 'procedures', 'medications', 'diagnostics'];
                elementsToShow.forEach(element => {
                    if (contentAnalysis[element] && contentAnalysis[element].length > 0) {
                        const displayItems = contentAnalysis[element].slice(0, 3);
                        insightsHTML += `
                            <div class="mb-2">
                                <span class="text-xs font-medium text-green-700 capitalize">${element.replace(/([A-Z])/g, ' $1')}:</span>
                                <span class="text-xs text-green-600 ml-1">${displayItems.join(', ')}${contentAnalysis[element].length > 3 ? '...' : ''}</span>
                            </div>
                        `;
                    }
                });
                
                insightsHTML += `
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-xs text-green-600">💡 AI will use these insights to create diverse, context-relevant questions</span>
                                <button class="text-xs text-green-500 hover:text-green-700" onclick="this.closest('.content-analysis-insights').remove()">
                                    <i class="fas fa-times mr-1"></i>Dismiss
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                insightDiv.innerHTML = insightsHTML;
                container.insertBefore(insightDiv, container.firstChild);
                
                // Auto-dismiss after 20 seconds
                setTimeout(() => {
                    if (insightDiv.parentElement) {
                        insightDiv.remove();
                    }
                }, 20000);
            }
            
            // Hook into generation process to show content analysis
            window.showContentAnalysisForGeneration = function(sourceContent) {
                if (!sourceContent || sourceContent.trim().length === 0) return;
                
                const contentAnalysis = analyzeSourceContent(sourceContent);
                const creativeAngles = generateCreativeAngles(contentAnalysis);
                
                displayContentAnalysisInsights(contentAnalysis, creativeAngles);
                
                // Return guidance for AI systems
                return window.getQuestionDiversityGuidance(sourceContent);
            };
            
            // Get references to important elements
            const generateBtn = document.getElementById('generate-btn');
            const regenerateBtn = document.getElementById('regenerate-btn');
            const qaContainer = document.getElementById('qa-container');
            const selectionModeBtn = document.getElementById('selection-mode-btn');
            
            // Enhanced function to calculate similarity score between two strings
            function calculateSimilarity(str1, str2) {
                // Convert to lowercase and normalize whitespace
                const a = str1.toLowerCase().trim().replace(/\s+/g, ' ');
                const b = str2.toLowerCase().trim().replace(/\s+/g, ' ');
                
                // If either string is very short, require exact match
                if (a.length < 15 || b.length < 15) {
                    return a === b ? 1 : 0;
                }
                
                // Check for exact match
                if (a === b) return 1;
                
                // Check for containment (one string fully contains the other)
                if (a.includes(b)) return 0.9;
                if (b.includes(a)) return 0.9;
                
                // Enhanced similarity checks for medical content
                
                // 1. Check for similar question patterns
                const questionPatterns = [
                    /what\s+is\s+the\s+(most\s+)?(common|likely|appropriate)/,
                    /which\s+of\s+the\s+following/,
                    /a\s+\d+(-|\s+to\s+)\d+\s+year\s+old/,
                    /patient\s+presents\s+with/,
                    /diagnosis\s+is\s+(most\s+)?(likely|appropriate)/,
                    /treatment\s+of\s+choice/,
                    /first\s+line\s+treatment/
                ];
                
                let patternMatches = 0;
                questionPatterns.forEach(pattern => {
                    if (pattern.test(a) && pattern.test(b)) {
                        patternMatches++;
                    }
                });
                
                // If multiple patterns match, increase similarity
                if (patternMatches >= 2) return 0.8;
                
                // 2. Check for medical term overlap
                const medicalTerms = /\b(retina|cornea|lens|glaucoma|cataract|macula|vitreous|optic|uvea|conjunctiva|sclera|choroid|retinal|corneal|lenticular|macular|vitreal|choroidal|conjunctival|scleral|uveitis|keratitis|iridocyclitis|endophthalmitis)\b/g;
                
                const termsA = (a.match(medicalTerms) || []).map(term => term.toLowerCase());
                const termsB = (b.match(medicalTerms) || []).map(term => term.toLowerCase());
                
                if (termsA.length > 0 && termsB.length > 0) {
                    const termOverlap = termsA.filter(term => termsB.includes(term)).length;
                    const maxTerms = Math.max(termsA.length, termsB.length);
                    if (termOverlap / maxTerms > 0.7) return 0.75;
                }
                
                // 3. Calculate word overlap with medical context weights
                const wordsA = a.split(' ').filter(word => word.length > 2);
                const wordsB = b.split(' ').filter(word => word.length > 2);
                
                // Weight important medical words higher
                const importantWords = ['diagnosis', 'treatment', 'management', 'complication', 'symptom', 'sign', 'patient', 'condition', 'disease', 'syndrome'];
                
                let weightedOverlap = 0;
                let totalWeight = 0;
                
                for (const wordA of wordsA) {
                    const weight = importantWords.includes(wordA.toLowerCase()) ? 3 : 1;
                    totalWeight += weight;
                    
                    if (wordsB.includes(wordA)) {
                        weightedOverlap += weight;
                    }
                }
                
                return totalWeight > 0 ? weightedOverlap / totalWeight : 0;
            }
            
            // Function to check if a question is a duplicate
            function isDuplicateQuestion(questionText) {
                // Convert to lowercase and remove extra spaces for comparison
                const normalizedQuestion = questionText.toLowerCase().trim().replace(/\s+/g, ' ');
                
                // Ignore very short questions as they're prone to false positives
                if (normalizedQuestion.length < 15) return false;
                
                // Check against each question in history
                for (const historyQuestion of questionHistory) {
                    const normalizedHistoryQuestion = historyQuestion.toLowerCase().trim().replace(/\s+/g, ' ');
                    
                    // Calculate similarity score
                    const similarityScore = calculateSimilarity(normalizedQuestion, normalizedHistoryQuestion);
                    
                    // Consider similar if score is above threshold
                    if (similarityScore >= 0.70) {  // 70% similarity threshold
                        log(`Duplicate found with similarity score: ${similarityScore.toFixed(2)}`, 'info');
                        return true;
                    }
                }
                
                return false;
            }
            
            // Enhanced function to mark duplicate questions and track innovation
            function markDuplicateQuestions() {
                // If deep search is active or selection mode is active, don't mark any duplicates
                if (isDeepSearchActive || isSelectionModeActive) {
                    log('Skipping duplicate marking: ' + 
                        (isDeepSearchActive ? 'Deep search active' : 'Selection mode active'), 'info');
                    return;
                }
                
                // Find all question elements that are not in deep search results
                const questionElements = Array.from(qaContainer.querySelectorAll('.question-item')).filter(el => {
                    // Exclude questions in deep search results
                    return !el.closest('.deep-search-result') && 
                           !el.hasAttribute('data-deep-search-result') &&
                           !el.classList.contains('deep-search-item');
                });
                
                log(`Checking ${questionElements.length} questions for duplicates and tracking innovation`, 'info');
                
                // Current questions in this batch
                const currentBatchQuestions = [];
                
                questionElements.forEach(questionEl => {
                    // Get the question text from the element
                    const questionTextEl = questionEl.querySelector('.question-text');
                    if (!questionTextEl) return;
                    
                    const questionText = questionTextEl.textContent.trim();
                    
                    // Track this question for innovation analysis
                    trackQuestionForInnovation(questionText);
                    
                    // Check if it's a duplicate
                    const isDuplicate = isDuplicateQuestion(questionText) || 
                                        currentBatchQuestions.includes(questionText.toLowerCase().trim());
                    
                    // If not already in current batch, add it
                    if (!currentBatchQuestions.includes(questionText.toLowerCase().trim())) {
                        currentBatchQuestions.push(questionText.toLowerCase().trim());
                    }
                    
                    // Analyze question pattern for additional insights
                    const pattern = analyzeQuestionPattern(questionText);
                    
                    // Add pattern insights as data attributes
                    questionEl.setAttribute('data-question-format', pattern.format);
                    questionEl.setAttribute('data-question-topic', pattern.topic);
                    questionEl.setAttribute('data-question-approach', pattern.approach);
                    questionEl.setAttribute('data-question-structure', pattern.structure);
                    
                    // If it's a duplicate and doesn't already have a warning
                    if (isDuplicate && !questionEl.querySelector('.duplicate-warning')) {
                        // Create the warning element
                        const warningEl = document.createElement('div');
                        warningEl.className = 'duplicate-warning absolute top-3 right-3 text-warning';
                        warningEl.innerHTML = '<i class="fas fa-exclamation-circle" title="This appears to be a repeated question"></i>';
                        
                        // Add badge that says "Repeated"
                        const repeatedBadge = document.createElement('div');
                        repeatedBadge.className = 'repeated-badge absolute top-3 right-12 bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full';
                        repeatedBadge.textContent = 'Repeated';
                        
                        // Add it to the question element
                        questionEl.style.position = 'relative';
                        questionEl.appendChild(warningEl);
                        questionEl.appendChild(repeatedBadge);
                        
                        // Add the repeated-question class for additional styling
                        questionEl.classList.add('repeated-question');
                        
                        log(`Marked duplicate question: "${questionText.substring(0, 30)}..."`, 'warning');
                    }
                });
                
                // Add current batch to history
                questionHistory = [...questionHistory, ...currentBatchQuestions];
                log(`Added ${currentBatchQuestions.length} questions to history (total: ${questionHistory.length})`, 'info');
            }
            
            // Observe changes to the question container to detect new questions
            const questionObserver = new MutationObserver((mutations) => {
                // Check if a deep search button was clicked or selection mode was toggled
                const specialModeActivated = mutations.some(mutation => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Check if any of the added nodes or their children contain deep search elements
                        for (let i = 0; i < mutation.addedNodes.length; i++) {
                            const node = mutation.addedNodes[i];
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Check if this is a deep search result container
                                if (node.classList && 
                                    (node.classList.contains('deep-search-result') || 
                                     node.querySelector('.deep-search-result'))) {
                                    log('Deep search results detected', 'info');
                                    return true;
                                }
                                // Check if this is an image container (ignore image-related changes)
                                if (node.classList && 
                                    (node.classList.contains('kanski-image-container') ||
                                     node.closest('.kanski-image-container'))) {
                                    log('Image container detected, ignoring for duplicate detection', 'info');
                                    return true;
                                }
                            }
                        }
                    } else if (mutation.type === 'attributes' && 
                              mutation.attributeName === 'class' && 
                              mutation.target === qaContainer) {
                        // Check if selection mode was toggled
                        if (qaContainer.classList.contains('selection-mode')) {
                            isSelectionModeActive = true;
                            log('Selection mode activated', 'info');
                            return true;
                        } else if (isSelectionModeActive) {
                            isSelectionModeActive = false;
                            log('Selection mode deactivated', 'info');
                        }
                    }
                    return false;
                });
                
                // If deep search or image changes were detected, set appropriate flags
                if (specialModeActivated) {
                    // This could be deep search, selection mode, or image display - all should skip duplicate detection
                    if (!isSelectionModeActive) {
                        isDeepSearchActive = true;
                        // Clear any existing timeout
                        if (window.deepSearchTimeout) clearTimeout(window.deepSearchTimeout);
                        // Set a timeout to reset the flag (giving time for operations to complete)
                        window.deepSearchTimeout = setTimeout(() => {
                            isDeepSearchActive = false;
                            log('Deep search/image flag reset after timeout', 'info');
                        }, 2000); // Reduced timeout for better responsiveness
                    }
                    return; // Skip duplicate marking during special modes
                }
                
                // Check if actual new questions were added (excluding image containers)
                const questionAdded = !isDeepSearchActive && !isSelectionModeActive && mutations.some(mutation => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Only consider it a question addition if new question-item elements were added
                        for (let i = 0; i < mutation.addedNodes.length; i++) {
                            const node = mutation.addedNodes[i];
                            if (node.nodeType === Node.ELEMENT_NODE && 
                                node.classList && 
                                node.classList.contains('question-item') &&
                                !node.classList.contains('kanski-image-container')) {
                                return true;
                            }
                        }
                    }
                    return false;
                });
                
                if (questionAdded) {
                    // Add a small delay to ensure DOM is fully updated
                    setTimeout(() => {
                        markDuplicateQuestions();
                    }, 100);
                }
            });
            
            // Start observing the question container
            questionObserver.observe(qaContainer, { 
                childList: true, 
                subtree: true,
                attributes: true,
                attributeFilter: ['class']
            });
            
            // Add event listeners to monitor for deep search button clicks
            document.addEventListener('click', function(e) {
                // Check if the clicked element is a deep search button or has one as ancestor
                const deepSearchButton = e.target.closest('.deep-search-btn, [data-action="deep-search"]');
                if (deepSearchButton) {
                    isDeepSearchActive = true;
                    log('Deep search button clicked', 'info');
                    // Clear any existing timeout
                    if (window.deepSearchTimeout) clearTimeout(window.deepSearchTimeout);
                    // Set a timeout to reset the flag
                    window.deepSearchTimeout = setTimeout(() => {
                        isDeepSearchActive = false;
                        log('Deep search flag reset after timeout', 'info');
                    }, 3000);
                }
                
                // Check if the clicked element is the selection mode button
                const selectionModeButton = e.target.closest('#selection-mode-btn, [data-action="selection-mode"]');
                if (selectionModeButton) {
                    isSelectionModeActive = !isSelectionModeActive;
                    log('Selection mode toggled: ' + (isSelectionModeActive ? 'ON' : 'OFF'), 'info');
                }
                
                // Check if the "Clear History" button was clicked
                const clearHistoryButton = e.target.closest('#clear-history-btn');
                if (clearHistoryButton) {
                    log('Clear History button clicked - resetting question history', 'info');
                    
                    // Reset the question history
                    questionHistory = [];
                    
                    // Remove duplicate warnings and repeated-question class from all existing questions
                    const questionElements = document.querySelectorAll('.question-item');
                    questionElements.forEach(question => {
                        // Remove the warning icon
                        const warningElement = question.querySelector('.duplicate-warning');
                        if (warningElement) {
                            question.removeChild(warningElement);
                        }
                        
                        // Remove the repeated badge
                        const repeatedBadge = question.querySelector('.repeated-badge');
                        if (repeatedBadge) {
                            question.removeChild(repeatedBadge);
                        }
                        
                        // Remove the repeated-question class
                        question.classList.remove('repeated-question');
                    });
                    
                    // Show a confirmation message to the user
                    const statusMessage = document.getElementById('status-message');
                    if (statusMessage) {
                        statusMessage.textContent = 'Question history cleared. Future duplicates will be detected based on new questions.';
                        statusMessage.className = 'text-center my-4 p-3 rounded-md font-medium bg-green-100 text-green-800';
                        statusMessage.style.display = 'block';
                        
                        // Hide the message after a few seconds
                        setTimeout(() => {
                            statusMessage.style.display = 'none';
                        }, 4000);
                    }
                }
                
                // Check if a "Select All Questions" button/checkbox was clicked
                const selectAllButton = e.target.closest('#select-all-questions, [data-action="select-all-questions"]');
                if (selectAllButton) {
                    // Get all checkboxes for questions
                    const allCheckboxes = qaContainer.querySelectorAll('.question-select-checkbox');
                    // Get the state from the button if available, otherwise toggle based on current selection
                    const shouldSelectAll = selectAllButton.hasAttribute('data-select-state') ? 
                                            selectAllButton.getAttribute('data-select-state') === 'select' : 
                                            !Array.from(allCheckboxes).every(cb => cb.checked);
                    
                    // Update all checkboxes
                    allCheckboxes.forEach(checkbox => {
                        checkbox.checked = shouldSelectAll;
                        
                        // Also update the visual selection state of the question
                        const questionItem = checkbox.closest('.question-item');
                        if (questionItem) {
                            if (shouldSelectAll) {
                                questionItem.classList.add('selected');
                            } else {
                                questionItem.classList.remove('selected');
                            }
                        }
                    });
                    
                    // Update counter if it exists
                    const counter = document.getElementById('selected-questions-counter');
                    if (counter) {
                        counter.textContent = shouldSelectAll ? allCheckboxes.length : 0;
                    }
                    
                    log(`Selected ${shouldSelectAll ? 'all' : 'no'} questions (${shouldSelectAll ? allCheckboxes.length : 0} total)`, 'info');
                }
            }, true); // Use capture phase to get the event first
            
            // Add listeners to the generation buttons
            if (generateBtn) {
                const originalGenerateClick = generateBtn.onclick;
                generateBtn.onclick = function(e) {
                    // Reset special mode flags
                    isDeepSearchActive = false;
                    isSelectionModeActive = false;
                    
                    log('Generate button clicked - resetting flags and history', 'info');
                    
                    // Call the original click handler if it exists
                    if (originalGenerateClick) originalGenerateClick.call(this, e);
                    
                    // Clear history when generating new questions from scratch
                    questionHistory = [];
                };
            }
            
            // For the regenerate button, we keep the history to check against previous questions
            if (regenerateBtn) {
                const originalRegenerateClick = regenerateBtn.onclick;
                regenerateBtn.onclick = function(e) {
                    // Reset special mode flags
                    isDeepSearchActive = false;
                    isSelectionModeActive = false;
                    
                    log('Regenerate button clicked - preserving history', 'info');
                    
                    // Check if we should warn about potential duplicates
                    const duplicateThreshold = 10; // Adjust this threshold as needed
                    if (questionHistory.length > duplicateThreshold) {
                        const warningMessage = `You have generated ${questionHistory.length} questions in this session. Regenerating may produce duplicate questions that will be marked as 'Repeated'. Continue?`;
                        
                        if (!confirm(warningMessage)) {
                            log('Regeneration cancelled by user due to duplicate warning', 'info');
                            return;
                        }
                        
                        log('User confirmed regeneration despite potential duplicates', 'info');
                    }
                    
                    // Mark existing questions before regenerating
                    const currentQuestions = Array.from(qaContainer.querySelectorAll('.question-text'))
                        .filter(el => !el.closest('.deep-search-result') && 
                                    !el.closest('[data-deep-search-result]') &&
                                    !el.closest('.deep-search-item'))
                        .map(el => el.textContent.trim());
                    
                    // Add to history before regenerating
                    questionHistory = [...new Set([...questionHistory, ...currentQuestions])];
                    log(`Added ${currentQuestions.length} questions to history before regenerating`, 'info');
                    
                    // Call the original click handler if it exists
                    if (originalRegenerateClick) originalRegenerateClick.call(this, e);
                };
            }
            
            // Monitor for selection mode changes directly
            if (selectionModeBtn) {
                selectionModeBtn.addEventListener('click', function() {
                    // Toggle the selection mode state
                    isSelectionModeActive = !isSelectionModeActive;
                    log('Selection mode button clicked directly - mode: ' + (isSelectionModeActive ? 'ON' : 'OFF'), 'info');
                    
                    // If selection mode is now active, find and hide any existing warning markers
                    if (isSelectionModeActive) {
                        const warningMarkers = qaContainer.querySelectorAll('.duplicate-warning');
                        warningMarkers.forEach(marker => {
                            marker.style.display = 'none';
                            log('Hiding duplicate warning during selection mode', 'info');
                        });
                    } else {
                        // If selection mode is now inactive, restore any hidden warning markers
                        const warningMarkers = qaContainer.querySelectorAll('.duplicate-warning');
                        warningMarkers.forEach(marker => {
                            marker.style.display = '';
                            log('Restoring duplicate warning after selection mode', 'info');
                        });
                    }
                });
            }
            
            // Setup "Select All" functionality for question types
            const typeAllCheckbox = document.getElementById('type-all');
            const questionTypeCheckboxes = [
                'type-mcq', 'type-tf', 'type-matching', 'type-short-answer',
                'type-clinical-case', 'type-differential', 'type-management',
                'type-viva', 'type-osce'
            ].map(id => document.getElementById(id));
            
            // Update "Select All" checkbox state based on other checkboxes
            function updateSelectAllCheckbox() {
                const allChecked = questionTypeCheckboxes.every(cb => cb.checked);
                const someChecked = questionTypeCheckboxes.some(cb => cb.checked);
                
                typeAllCheckbox.checked = allChecked;
                // Add indeterminate state if some but not all are checked
                typeAllCheckbox.indeterminate = someChecked && !allChecked;
            }
            
            // Check initial state
            updateSelectAllCheckbox();
            
            // Add event listener to "Select All" checkbox
            typeAllCheckbox.addEventListener('change', function() {
                // Update all checkboxes to match the "Select All" state
                questionTypeCheckboxes.forEach(cb => {
                    cb.checked = typeAllCheckbox.checked;
                });
            });
            
            // Add event listeners to individual checkboxes
            questionTypeCheckboxes.forEach(cb => {
                cb.addEventListener('change', updateSelectAllCheckbox);
            });
        });
    </script>

    <!-- Required library for better PDF and DOCX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    
    <!-- Script for enhanced export functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('export-btn');
            const exportFormat = document.getElementById('export-format');
            const qaContainer = document.getElementById('qa-container');
            
            if (exportBtn) {
                // Store the original click handler if it exists
                const originalExportClick = exportBtn.onclick;
                
                exportBtn.onclick = function(e) {
                    // Get selected export format
                    const format = exportFormat.value;
                    
                    log(`Export requested in ${format.toUpperCase()} format`, 'info');
                    
                    // Handle the export based on format
                    if (format === 'pdf') {
                        exportToPdf();
                        return; // Don't call original handler
                    } else if (format === 'docx') {
                        exportToDocx();
                        return; // Don't call original handler
                    }
                    
                    // For other formats, call the original handler if it exists
                    if (originalExportClick) originalExportClick.call(this, e);
                };
            }
            
            // Function to export questions as PDF
            function exportToPdf() {
                log('Starting PDF export process...', 'info');
                
                // Check if questions exist
                const questions = qaContainer.querySelectorAll('.question-item');
                if (questions.length === 0) {
                    log('No questions to export!', 'error');
                    alert('No questions to export! Please generate questions first.');
                    return;
                }
                
                // Create temporary container with cleaner styling for PDF
                const tempContainer = document.createElement('div');
                tempContainer.className = 'pdf-export-container';
                tempContainer.style.width = '100%';
                tempContainer.style.maxWidth = '800px';
                tempContainer.style.margin = '0 auto';
                tempContainer.style.padding = '20px';
                tempContainer.style.backgroundColor = 'white';
                tempContainer.style.fontFamily = 'Arial, sans-serif';
                
                // Add title
                const title = document.createElement('h1');
                title.textContent = 'OphthalmoQA Generated Questions';
                title.style.textAlign = 'center';
                title.style.color = '#2c6fa5';
                title.style.marginBottom = '20px';
                tempContainer.appendChild(title);
                
                // Add subtitle with date
                const subtitle = document.createElement('p');
                subtitle.textContent = `Generated on ${new Date().toLocaleDateString()}`;
                subtitle.style.textAlign = 'center';
                subtitle.style.color = '#666';
                subtitle.style.marginBottom = '30px';
                tempContainer.appendChild(subtitle);
                
                // Clone each question with cleaner styling
                questions.forEach((question, index) => {
                    const questionClone = document.createElement('div');
                    questionClone.style.marginBottom = '30px';
                    questionClone.style.pageBreakInside = 'avoid';
                    
                    // Question number
                    const questionNumber = document.createElement('h3');
                    questionNumber.textContent = `Question ${index + 1}`;
                    questionNumber.style.color = '#2c6fa5';
                    questionNumber.style.marginBottom = '10px';
                    questionClone.appendChild(questionNumber);
                    
                    // Question text
                    const questionText = question.querySelector('.question-text');
                    if (questionText) {
                        const questionTextClone = document.createElement('div');
                        questionTextClone.innerHTML = questionText.innerHTML;
                        questionTextClone.style.fontWeight = 'bold';
                        questionTextClone.style.marginBottom = '15px';
                        questionClone.appendChild(questionTextClone);
                    }
                    
                    // Options if it's a multiple choice question
                    const options = question.querySelectorAll('.question-option');
                    if (options.length > 0) {
                        const optionsList = document.createElement('div');
                        optionsList.style.marginLeft = '20px';
                        optionsList.style.marginBottom = '15px';
                        
                        options.forEach(option => {
                            const optionClone = document.createElement('div');
                            optionClone.innerHTML = option.innerHTML;
                            optionClone.style.marginBottom = '5px';
                            optionsList.appendChild(optionClone);
                        });
                        
                        questionClone.appendChild(optionsList);
                    }
                    
                    // Answer
                    const answer = question.querySelector('.answer-text');
                    if (answer) {
                        const answerTitle = document.createElement('div');
                        answerTitle.textContent = 'Answer:';
                        answerTitle.style.fontWeight = 'bold';
                        answerTitle.style.marginTop = '10px';
                        answerTitle.style.marginBottom = '5px';
                        questionClone.appendChild(answerTitle);
                        
                        const answerClone = document.createElement('div');
                        answerClone.innerHTML = answer.innerHTML;
                        answerClone.style.backgroundColor = '#f5f9fc';
                        answerClone.style.padding = '10px';
                        answerClone.style.borderLeft = '3px solid #2c6fa5';
                        questionClone.appendChild(answerClone);
                    }
                    
                    tempContainer.appendChild(questionClone);
                    
                    // Add a separator except after the last question
                    if (index < questions.length - 1) {
                        const separator = document.createElement('hr');
                        separator.style.margin = '30px 0';
                        separator.style.border = 'none';
                        separator.style.borderTop = '1px solid #eee';
                        tempContainer.appendChild(separator);
                    }
                });
                
                // Add watermark/footer
                const footer = document.createElement('div');
                footer.textContent = 'Generated by OphthalmoQA - FRCS Guru';
                footer.style.textAlign = 'center';
                footer.style.marginTop = '40px';
                footer.style.color = '#999';
                footer.style.fontSize = '12px';
                tempContainer.appendChild(footer);
                
                // Add to body but hide it
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                document.body.appendChild(tempContainer);
                
                log('Temporary container created, generating PDF...', 'info');
                
                // Use html2canvas and jsPDF to create the PDF
                html2canvas(tempContainer, {
                    scale: 1.5, // Higher scale for better quality
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    log('Canvas rendering complete, creating PDF document...', 'info');
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    
                    // Calculate dimensions
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    
                    // Calculate the number of pages
                    const pdfRatio = pdfHeight / pdfWidth;
                    const canvasRatio = canvasHeight / canvasWidth;
                    let totalPages;
                    
                    if (canvasRatio > pdfRatio) {
                        // Canvas is taller relative to width than PDF
                        totalPages = Math.ceil(canvasHeight * (pdfWidth / canvasWidth) / pdfHeight);
                    } else {
                        totalPages = 1;
                    }
                    
                    // Add each page
                    let position = 0;
                    for (let i = 0; i < totalPages; i++) {
                        if (i > 0) {
                            pdf.addPage();
                        }
                        
                        // Each page
                        pdf.addImage(
                            imgData, 
                            'JPEG', 
                            0, 
                            position, 
                            pdfWidth, 
                            canvasHeight * (pdfWidth / canvasWidth)
                        );
                        
                        position -= pdfHeight;
                    }
                    
                    log('PDF created successfully, initiating download...', 'success');
                    
                    // Download the PDF
                    pdf.save('ophthalmoqa-questions.pdf');
                    
                    // Remove the temporary container
                    document.body.removeChild(tempContainer);
                }).catch(error => {
                    log('Error generating PDF: ' + error.message, 'error');
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try a different format or check console for details.');
                    
                    // Remove the temporary container
                    document.body.removeChild(tempContainer);
                });
            }
            
            // Function to export questions as DOCX
            function exportToDocx() {
                log('Starting DOCX export process...', 'info');
                
                // Check if questions exist
                const questions = qaContainer.querySelectorAll('.question-item');
                if (questions.length === 0) {
                    log('No questions to export!', 'error');
                    alert('No questions to export! Please generate questions first.');
                    return;
                }
                
                // Use simpler approach - create text content and use a third-party conversion service
                let textContent = "# OphthalmoQA Generated Questions\n\n";
                textContent += `Generated on ${new Date().toLocaleDateString()}\n\n`;
                
                // Process each question
                questions.forEach((question, index) => {
                    textContent += `## Question ${index + 1}\n\n`;
                    
                    // Question text
                    const questionText = question.querySelector('.question-text');
                    if (questionText) {
                        textContent += `${questionText.textContent.trim()}\n\n`;
                    }
                    
                    // Options if it's a multiple choice question
                    const options = question.querySelectorAll('.question-option');
                    if (options.length > 0) {
                        options.forEach((option, optIndex) => {
                            textContent += `- ${option.textContent.trim()}\n`;
                        });
                        textContent += "\n";
                    }
                    
                    // Answer
                    const answer = question.querySelector('.answer-text');
                    if (answer) {
                        textContent += `**Answer:**\n\n${answer.textContent.trim()}\n\n`;
                    }
                    
                    // Add separator between questions
                    if (index < questions.length - 1) {
                        textContent += "---\n\n";
                    }
                });
                
                // Add footer
                textContent += "\n\n*Generated by OphthalmoQA - FRCS Guru*";
                
                // Create a blob from the text content
                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                // Create download link
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ophthalmoqa-questions.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log('Text document download initiated - please convert to DOCX in Word or Google Docs', 'success');
                alert('Due to browser limitations, we\'ve exported your questions as a text file. To convert to DOCX:\n\n1. Open the downloaded file in Microsoft Word or Google Docs\n2. The file contains markdown formatting that will be preserved\n3. Save or export as DOCX from your word processor');
            }
        });
    </script>

    <!-- Script to fix the question selection issue -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fix for "No questions selected" error when saving selected questions
            const saveOfflineBtn = document.getElementById('save-offline-btn');
            const confirmSaveQuestionSet = document.getElementById('confirm-save-question-set');
            
            // Function to ensure all questions are properly selected
            function ensureQuestionsSelected() {
                const qaContainer = document.getElementById('qa-container');
                const isSelectionMode = qaContainer && qaContainer.classList.contains('selection-mode');
                
                if (isSelectionMode) {
                    // Check if "Select All Questions" is checked
                    const selectAllButton = document.getElementById('select-all-questions');
                    const isSelectAllChecked = selectAllButton && selectAllButton.classList.contains('active');
                    
                    if (isSelectAllChecked) {
                        log('Select All Questions is active, ensuring all questions are selected', 'info');
                        
                        // Get all questions and make sure they're selected
                        const questions = qaContainer.querySelectorAll('.question-item');
                        const checkboxes = qaContainer.querySelectorAll('.question-select-checkbox');
                        
                        // Update all questions
                        questions.forEach(question => {
                            question.classList.add('selected');
                        });
                        
                        // Update all checkboxes
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = true;
                        });
                        
                        // Update counter
                        const counter = document.getElementById('selected-questions-counter');
                        if (counter) {
                            counter.textContent = questions.length;
                        }
                        
                        log(`Ensured all ${questions.length} questions are selected for saving`, 'info');
                        return true;
                    }
                    
                    // Get selected questions
                    const selectedQuestions = document.querySelectorAll('.question-item.selected');
                    log(`Found ${selectedQuestions.length} selected questions`, 'info');
                    
                    if (selectedQuestions.length === 0) {
                        log('No questions selected when in selection mode', 'warning');
                        alert('No questions selected. Please select at least one question to save.');
                        return false;
                    }
                }
                
                return true;
            }
            
            if (saveOfflineBtn) {
                // Store original click handler if it exists
                const originalSaveClick = saveOfflineBtn.onclick;
                
                saveOfflineBtn.onclick = function(e) {
                    log('Save offline button clicked', 'info');
                    
                    // Ensure questions are selected
                    if (!ensureQuestionsSelected()) {
                        return;
                    }
                    
                    // Call original handler if it exists
                    if (originalSaveClick) originalSaveClick.call(this, e);
                };
            }
            
            if (confirmSaveQuestionSet) {
                // Store original click handler if it exists
                const originalConfirmClick = confirmSaveQuestionSet.onclick;
                
                confirmSaveQuestionSet.onclick = function(e) {
                    log('Confirm save question set button clicked', 'info');
                    
                    // Ensure questions are selected
                    if (!ensureQuestionsSelected()) {
                        e.preventDefault();
                        return false;
                    }
                    
                    // Call original handler if it exists
                    if (originalConfirmClick) return originalConfirmClick.call(this, e);
                };
            }
            
            // Add a "Select All Questions" button/function if it doesn't exist
            document.addEventListener('click', function(e) {
                // Handle clicks on question selection toggle buttons
                if (e.target.matches('#selection-mode-btn, [data-action="selection-mode"]')) {
                    log('Selection mode button clicked', 'info');
                    setTimeout(function() {
                        const qaContainer = document.getElementById('qa-container');
                        const isSelectionMode = qaContainer && qaContainer.classList.contains('selection-mode');
                        
                        if (isSelectionMode) {
                            // Check if the selection header already exists
                            let selectionHeader = document.getElementById('question-selection-header');
                            
                            if (!selectionHeader) {
                                // Create selection header
                                selectionHeader = document.createElement('div');
                                selectionHeader.id = 'question-selection-header';
                                selectionHeader.className = 'bg-white shadow p-3 mb-4 rounded-md flex justify-between items-center';
                                
                                // Create counter
                                const counter = document.createElement('div');
                                counter.innerHTML = '<span id="selected-questions-counter">0</span> questions selected';
                                
                                // Create select all button
                                const selectAllBtn = document.createElement('button');
                                selectAllBtn.id = 'select-all-questions';
                                selectAllBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm';
                                selectAllBtn.innerHTML = 'Select All Questions';
                                selectAllBtn.addEventListener('click', function() {
                                    const questions = qaContainer.querySelectorAll('.question-item');
                                    const checkboxes = qaContainer.querySelectorAll('.question-select-checkbox');
                                    
                                    // Check if all questions are already selected
                                    const allSelected = Array.from(questions).every(q => q.classList.contains('selected'));
                                    
                                    // Toggle active state on the button
                                    this.classList.toggle('active', !allSelected);
                                    
                                    // Change button text based on state
                                    if (allSelected) {
                                        this.textContent = 'Select All Questions';
                                        this.classList.remove('bg-purple-600');
                                        this.classList.add('bg-blue-500');
                                    } else {
                                        this.textContent = 'Deselect All Questions';
                                        this.classList.remove('bg-blue-500');
                                        this.classList.add('bg-purple-600');
                                    }
                                    
                                    // Update all questions
                                    questions.forEach(question => {
                                        if (allSelected) {
                                            question.classList.remove('selected');
                                        } else {
                                            question.classList.add('selected');
                                        }
                                    });
                                    
                                    // Update all checkboxes
                                    checkboxes.forEach(checkbox => {
                                        checkbox.checked = !allSelected;
                                    });
                                    
                                    // Update counter
                                    const counter = document.getElementById('selected-questions-counter');
                                    if (counter) {
                                        counter.textContent = allSelected ? '0' : questions.length;
                                    }
                                    
                                    log(`${allSelected ? 'Deselected' : 'Selected'} all questions (${allSelected ? 0 : questions.length})`, 'info');
                                });
                                
                                // Add elements to header
                                selectionHeader.appendChild(counter);
                                selectionHeader.appendChild(selectAllBtn);
                                
                                // Add header to container
                                qaContainer.parentNode.insertBefore(selectionHeader, qaContainer);
                            }
                        } else {
                            // Remove selection header if it exists
                            const selectionHeader = document.getElementById('question-selection-header');
                            if (selectionHeader) {
                                selectionHeader.parentNode.removeChild(selectionHeader);
                            }
                        }
                    }, 100);
                }
                
                // Handle clicks on question items in selection mode
                if (e.target.closest('.question-item') && !e.target.closest('.question-select-checkbox')) {
                    const qaContainer = document.getElementById('qa-container');
                    const isSelectionMode = qaContainer && qaContainer.classList.contains('selection-mode');
                    
                    if (isSelectionMode) {
                        const questionItem = e.target.closest('.question-item');
                        const checkbox = questionItem.querySelector('.question-select-checkbox');
                        
                        if (checkbox) {
                            // Toggle the checkbox
                            checkbox.checked = !checkbox.checked;
                            
                            // Toggle the selected class
                            questionItem.classList.toggle('selected', checkbox.checked);
                            
                            // Update counter
                            const counter = document.getElementById('selected-questions-counter');
                            if (counter) {
                                const selectedCount = document.querySelectorAll('.question-item.selected').length;
                                counter.textContent = selectedCount;
                            }
                            
                            // Update "Select All" button state
                            const selectAllBtn = document.getElementById('select-all-questions');
                            if (selectAllBtn) {
                                const questions = qaContainer.querySelectorAll('.question-item');
                                const allSelected = Array.from(questions).every(q => q.classList.contains('selected'));
                                
                                if (allSelected) {
                                    selectAllBtn.textContent = 'Deselect All Questions';
                                    selectAllBtn.classList.remove('bg-blue-500');
                                    selectAllBtn.classList.add('bg-purple-600');
                                    selectAllBtn.classList.add('active');
                                } else {
                                    selectAllBtn.textContent = 'Select All Questions';
                                    selectAllBtn.classList.remove('bg-purple-600');
                                    selectAllBtn.classList.add('bg-blue-500');
                                    selectAllBtn.classList.remove('active');
                                }
                            }
                            
                            log(`Question ${checkbox.checked ? 'selected' : 'deselected'}`, 'info');
                        }
                    }
                }
                
                // Handle clicks on the save offline button specifically for integration with Select All
                if (e.target.matches('#save-offline-btn, [data-action="save-offline"]')) {
                    log('Save offline button clicked via integrated handler', 'info');
                    
                    // Check if in selection mode
                    const qaContainer = document.getElementById('qa-container');
                    const isSelectionMode = qaContainer && qaContainer.classList.contains('selection-mode');
                    
                    if (isSelectionMode) {
                        // Check if Select All button is active
                        const selectAllBtn = document.getElementById('select-all-questions');
                        if (selectAllBtn && selectAllBtn.classList.contains('active')) {
                            log('Select All Questions is active, ensuring all questions are selected before save', 'info');
                            
                            // Get all questions and make sure they're selected
                            const questions = qaContainer.querySelectorAll('.question-item');
                            const checkboxes = qaContainer.querySelectorAll('.question-select-checkbox');
                            
                            // Update all questions
                            questions.forEach(question => {
                                question.classList.add('selected');
                            });
                            
                            // Update all checkboxes
                            checkboxes.forEach(checkbox => {
                                checkbox.checked = true;
                            });
                        }
                    }
                }
            });
            
            // Extra handler for the Save Selected button if it exists
            const saveSelectedBtn = document.getElementById('save-selected-btn');
            if (saveSelectedBtn) {
                saveSelectedBtn.addEventListener('click', function() {
                    log('Save Selected button clicked', 'info');
                    
                    // Ensure questions are selected
                    ensureQuestionsSelected();
                });
            }
        });
    </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased min-h-screen">
    <!-- Global Error Handling for Legacy Issues -->
    <script>
        // Suppress known legacy errors that may appear from cached code
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            
            // Suppress specific known legacy errors
            if (
                message.includes('LocalFeedbackHandler is not defined') ||
                message.includes('feedback-handler.js') ||
                (message.includes('duplicate variable') && message.includes('EnhancedFeedbackSystem')) ||
                (message.includes("Can't create duplicate variable") && message.includes('EnhancedFeedbackSystem')) ||
                (message.includes('getUserRatingAnalytics is not a function') && window.validationMonitor) ||
                message.includes("'#' is not a valid selector") ||
                message.includes('Maximum call stack size exceeded') ||
                (message.includes('getQuestionsForImprovement') && message.includes('not a function'))
            ) {
                // Log a cleaner message instead
                console.log(`📝 System initialization handled: ${message.substring(0, 80)}...`);
                return;
            }
            
            // For other errors, use original console.error
            originalConsoleError.apply(console, args);
        };

        // Suppress specific warning for Tailwind CDN
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');
            
            if (message.includes('cdn.tailwindcss.com should not be used in production')) {
                console.log('📝 Note: Using Tailwind CDN for development purposes');
                return;
            }
            
            originalConsoleWarn.apply(console, args);
        };
        
        console.log('🛡️ Error suppression system initialized');
        
        // Fix duplicate modal IDs issue
        document.addEventListener('DOMContentLoaded', function() {
            const duplicateModals = document.querySelectorAll('[id="feedback-analytics-modal"]');
            if (duplicateModals.length > 1) {
                console.log(`🔧 Found ${duplicateModals.length} duplicate feedback analytics modals, disabling extras`);
                // Keep only the last one (which is typically the Enhanced one)
                for (let i = 0; i < duplicateModals.length - 1; i++) {
                    duplicateModals[i].id = `feedback-analytics-modal-disabled-${i}`;
                    duplicateModals[i].style.display = 'none !important';
                    duplicateModals[i].remove(); // Remove from DOM entirely
                }
                console.log('✅ Duplicate feedback analytics modals cleaned up');
            }
        });
    </script>
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <header class="nerdy-pattern text-white p-5 md:p-6 rounded-lg shadow-lg mb-6 md:mb-8 relative overflow-hidden">
            <!-- Medical background design elements -->
            <div class="absolute inset-0 opacity-15 z-0">
                <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="book-pattern" patternUnits="userSpaceOnUse" width="100" height="100" patternTransform="rotate(0)">
                            <!-- Book icon -->
                            <path d="M30,20 L70,20 L70,80 L30,80 Z" stroke="currentColor" stroke-width="1" fill="none"/>
                            <path d="M30,20 L70,20 L70,80 L30,80 L30,20" stroke="currentColor" stroke-width="1" fill="none"/>
                            <path d="M50,20 L50,80" stroke="currentColor" stroke-width="0.5" fill="none"/>
                            
                            <!-- Glasses icon -->
                            <circle cx="20" cy="50" r="5" stroke="currentColor" stroke-width="1" fill="none"/>
                            <circle cx="35" cy="50" r="5" stroke="currentColor" stroke-width="1" fill="none"/>
                            <path d="M25,50 L30,50" stroke="currentColor" stroke-width="1" fill="none"/>
                            <path d="M15,50 L10,45" stroke="currentColor" stroke-width="1" fill="none"/>
                            <path d="M40,50 L45,45" stroke="currentColor" stroke-width="1" fill="none"/>
                            
                            <!-- Medical symbols -->
                            <path d="M85,40 L85,60 M75,50 L95,50" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#book-pattern)"/>
                </svg>
            </div>
            
            <!-- Animated Studying Nerdy Ophthalmologist -->
            <div class="ophthalmologist-container hidden md:block">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <!-- Studying Ophthalmologist Figure -->
                    <g class="eye-doctor-figure">
                        <!-- Body -->
                        <rect x="85" y="120" width="30" height="50" fill="#4a90e2" stroke="#2c5a80" stroke-width="1" rx="5"/>
                        
                        <!-- Lab coat -->
                        <rect x="80" y="115" width="40" height="60" fill="#ffffff" stroke="#e0e0e0" stroke-width="1.5" rx="8"/>
                        
                        <!-- Collar -->
                        <path d="M85,120 L100,115 L115,120" stroke="#e0e0e0" stroke-width="2" fill="none"/>
                        
                        <!-- Stethoscope -->
                        <path d="M90,125 C85,130 85,140 90,145" stroke="#2c5a80" stroke-width="2" fill="none"/>
                        <circle cx="92" cy="147" r="3" fill="#2c5a80"/>
                        
                        <!-- Head -->
                        <circle cx="100" cy="80" r="22" fill="#f8d8c0" stroke="#333333" stroke-width="1"/>
                        
                        <!-- Hair (neat, professional) -->
                        <path d="M78,70 C78,60 85,55 100,55 C115,55 122,60 122,70 C122,65 118,62 115,65 C112,60 108,58 105,60 C102,58 98,58 95,60 C92,58 88,60 85,65 C82,62 78,65 78,70" fill="#8B4513" stroke="#654321" stroke-width="1"/>
                        
                        <!-- Professional glasses (larger, more detailed) -->
                        <circle cx="92" cy="78" r="10" stroke="#2c5a80" stroke-width="2" fill="rgba(255,255,255,0.3)"/>
                        <circle cx="108" cy="78" r="10" stroke="#2c5a80" stroke-width="2" fill="rgba(255,255,255,0.3)"/>
                        <path d="M102,78 L98,78" stroke="#2c5a80" stroke-width="2"/>
                        <path d="M82,78 L76,74" stroke="#2c5a80" stroke-width="2"/>
                        <path d="M118,78 L124,74" stroke="#2c5a80" stroke-width="2"/>
                        
                        <!-- Eyes (focused, studying) -->
                        <ellipse cx="92" cy="78" rx="4" ry="3" fill="#333333"/>
                        <ellipse cx="108" cy="78" rx="4" ry="3" fill="#333333"/>
                        <ellipse cx="94" cy="77" rx="1" ry="1" fill="#ffffff"/>
                        <ellipse cx="110" cy="77" rx="1" ry="1" fill="#ffffff"/>
                        
                        <!-- Eyebrows (concentrated expression) -->
                        <path d="M86,72 C90,70 96,70 100,72" stroke="#654321" stroke-width="2" fill="none"/>
                        <path d="M114,72 C110,70 104,70 100,72" stroke="#654321" stroke-width="2" fill="none"/>
                        
                        <!-- Nose -->
                        <path d="M100,82 L98,88 L100,90 L102,88 Z" fill="#f0c8a0" stroke="#d0a080" stroke-width="0.5"/>
                        
                        <!-- Mouth (slight smile, focused) -->
                        <path d="M95,92 C100,95 105,92 105,92" stroke="#333333" stroke-width="1.5" fill="none"/>
                        
                        <!-- Arms -->
                        <rect x="65" y="125" width="15" height="25" fill="#f8d8c0" rx="7"/>
                        <rect x="120" y="125" width="15" height="25" fill="#f8d8c0" rx="7"/>
                        
                        <!-- Book/Study material -->
                        <g class="study-book">
                            <rect x="50" y="135" width="25" height="20" fill="#8B0000" stroke="#5a0000" stroke-width="1" rx="2"/>
                            <rect x="52" y="137" width="21" height="16" fill="#ffffff" stroke="#e0e0e0" stroke-width="0.5" rx="1"/>
                            <text x="62" y="145" font-family="Arial, sans-serif" font-size="6" fill="#8B0000" text-anchor="middle">FRCS</text>
                            <text x="62" y="151" font-family="Arial, sans-serif" font-size="4" fill="#8B0000" text-anchor="middle">OPHTHAL</text>
                        </g>
                        
                        <!-- Ophthalmoscope in right hand -->
                        <g class="ophthalmoscope">
                            <rect x="140" y="140" width="15" height="8" fill="#2c5a80" rx="2"/>
                            <circle cx="155" cy="144" r="4" fill="#4a90e2"/>
                            <circle cx="155" cy="144" r="2" fill="#ffffff"/>
                            <line x1="135" y1="144" x2="140" y2="144" stroke="#2c5a80" stroke-width="2"/>
                        </g>
                        
                        <!-- Animated study elements -->
                        <g class="study-sparkles">
                            <!-- Knowledge sparkles -->
                            <circle class="sparkle sparkle-1" cx="130" cy="60" r="1.5" fill="#FFD700" opacity="0.8"/>
                            <circle class="sparkle sparkle-2" cx="140" cy="70" r="1" fill="#4a90e2" opacity="0.6"/>
                            <circle class="sparkle sparkle-3" cx="125" cy="50" r="2" fill="#FFD700" opacity="0.7"/>
                            <circle class="sparkle sparkle-4" cx="60" cy="65" r="1" fill="#4a90e2" opacity="0.5"/>
                            <circle class="sparkle sparkle-5" cx="70" cy="55" r="1.5" fill="#FFD700" opacity="0.9"/>
                            
                            <!-- Study focus lines -->
                            <path class="focus-line focus-1" d="M75,145 L85,140" stroke="#4a90e2" stroke-width="1" opacity="0.4"/>
                            <path class="focus-line focus-2" d="M80,150 L90,145" stroke="#4a90e2" stroke-width="1" opacity="0.3"/>
                        </g>
                    </g>
                </svg>
            </div>
            
            <!-- Enhanced Animated Medical Elements -->
            <div class="absolute top-4 right-8 opacity-25 animate-bounce" style="animation-duration: 3s;">
                <!-- Retina Icon -->
                <svg width="35" height="35" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <circle cx="12" cy="12" r="6" stroke="currentColor" stroke-width="1" fill="rgba(255,255,255,0.1)"/>
                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                    <circle cx="13" cy="11" r="1" fill="white"/>
                    <!-- Optic nerve -->
                    <path d="M22,12 L18,12" stroke="currentColor" stroke-width="2"/>
                    <!-- Blood vessels -->
                    <path d="M12,6 Q15,9 12,12 Q9,15 12,18" stroke="currentColor" stroke-width="0.8" fill="none"/>
                    <path d="M6,12 Q9,9 12,12 Q15,15 18,12" stroke="currentColor" stroke-width="0.8" fill="none"/>
                </svg>
            </div>
            
            <div class="absolute bottom-8 left-16 opacity-25 animate-pulse" style="animation-duration: 4s;">
                <!-- Ophthalmoscope Icon -->
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="8" y="4" width="8" height="12" rx="2" stroke="currentColor" stroke-width="1.5" fill="rgba(255,255,255,0.1)"/>
                    <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <circle cx="12" cy="10" r="1.5" fill="currentColor"/>
                    <line x1="12" y1="16" x2="12" y2="20" stroke="currentColor" stroke-width="2"/>
                    <line x1="10" y1="18" x2="14" y2="18" stroke="currentColor" stroke-width="2"/>
                    <!-- Light beam -->
                    <path d="M12,13 L12,16" stroke="yellow" stroke-width="2" opacity="0.6"/>
                </svg>
            </div>
            
            <div class="absolute top-16 left-12 opacity-25 animate-spin" style="animation-duration: 8s;">
                <!-- Lens/Refraction Icon -->
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <ellipse cx="12" cy="12" rx="8" ry="4" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <ellipse cx="12" cy="12" rx="4" ry="8" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <circle cx="12" cy="12" r="2" fill="currentColor"/>
                </svg>
            </div>
            
            <div class="absolute bottom-16 right-20 opacity-25 animate-bounce" style="animation-duration: 2.5s; animation-delay: 1s;">
                <!-- Slit Lamp Icon -->
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="8" width="16" height="8" rx="1" stroke="currentColor" stroke-width="1.5" fill="rgba(255,255,255,0.1)"/>
                    <circle cx="8" cy="12" r="2" stroke="currentColor" stroke-width="1" fill="none"/>
                    <circle cx="16" cy="12" r="2" stroke="currentColor" stroke-width="1" fill="none"/>
                    <line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="1"/>
                    <!-- Light beam -->
                    <path d="M2,12 L4,12" stroke="yellow" stroke-width="2" opacity="0.7"/>
                    <path d="M20,12 L22,12" stroke="yellow" stroke-width="2" opacity="0.7"/>
                </svg>
            </div>
            
            <div class="absolute top-8 left-1/3 opacity-20 animate-pulse" style="animation-duration: 5s;">
                <!-- Visual Field Icon -->
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1" fill="none"/>
                    <circle cx="12" cy="12" r="1" fill="currentColor"/>
                    <!-- Visual field points -->
                    <circle cx="8" cy="8" r="0.5" fill="currentColor" opacity="0.6"/>
                    <circle cx="16" cy="8" r="0.5" fill="currentColor" opacity="0.6"/>
                    <circle cx="8" cy="16" r="0.5" fill="currentColor" opacity="0.6"/>
                    <circle cx="16" cy="16" r="0.5" fill="currentColor" opacity="0.6"/>
                    <circle cx="12" cy="6" r="0.5" fill="currentColor" opacity="0.4"/>
                    <circle cx="12" cy="18" r="0.5" fill="currentColor" opacity="0.4"/>
                    <circle cx="6" cy="12" r="0.5" fill="currentColor" opacity="0.4"/>
                    <circle cx="18" cy="12" r="0.5" fill="currentColor" opacity="0.4"/>
                </svg>
            </div>
            
            <div class="relative z-10 flex flex-col lg:flex-row justify-between items-start lg:items-center">
                <!-- Enhanced Logo & Title Section -->
                <div class="flex items-center mb-4 lg:mb-0 flex-1">
                    <!-- Enhanced Logo Container -->
                    <div class="mr-4 bg-gradient-to-br from-white to-blue-50 rounded-full p-2 shadow-lg relative overflow-hidden border-2 border-white/20">
                        <!-- Main Eye Icon -->
                        <svg class="w-10 h-10 md:w-12 md:h-12 text-primary" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" fill="currentColor"/>
                        </svg>
                        <!-- Professional Glasses Overlay -->
                        <svg class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-12 h-12 md:w-14 md:h-14 text-accent opacity-80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="8" cy="12" r="3.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <circle cx="16" cy="12" r="3.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <path d="M11.5,12 L12.5,12" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M4.5,12 L3,10" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M19.5,12 L21,10" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <!-- Sparkle Effect -->
                        <div class="absolute top-1 right-1 w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                        <div class="absolute bottom-1 left-1 w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                    </div>
                    
                    <!-- Enhanced Title Section -->
                    <div class="flex-1">
                        <div class="flex items-center flex-wrap gap-2">
                            <h1 class="text-xl md:text-3xl lg:text-4xl font-bold tracking-tight bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent">
                                OphthalmoQA
                            </h1>
                            <div class="flex gap-2">
                                <span class="bg-gradient-to-r from-white to-blue-50 text-primary text-xs px-3 py-1 rounded-full font-bold tracking-wider shadow-md border border-white/30">
                                    FRCS GURU
                                </span>
                                <span class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xs px-2 py-1 rounded-full font-semibold animate-pulse">
                                    AI-Powered
                                </span>
                            </div>
                        </div>
                        <p class="text-xs md:text-sm mt-1 text-blue-100 font-medium">
                            🎯 Advanced Ophthalmology Question Generator for FRCS Specialists
                        </p>
                        <!-- Additional credential badges -->
                        <div class="flex gap-2 mt-2 flex-wrap">
                            <span class="text-xs bg-blue-800/30 px-2 py-0.5 rounded-full border border-blue-200/20">
                                <i class="fas fa-medal mr-1"></i>Evidence-Based
                            </span>
                            <span class="text-xs bg-purple-800/30 px-2 py-0.5 rounded-full border border-purple-200/20">
                                <i class="fas fa-brain mr-1"></i>Smart Learning
                            </span>
                            <span class="text-xs bg-green-800/30 px-2 py-0.5 rounded-full border border-green-200/20">
                                <i class="fas fa-chart-line mr-1"></i>Adaptive
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Creator & User Section -->
                <div class="flex flex-col items-end space-y-3 lg:ml-6">
                    <!-- Creator Attribution -->
                    <div class="flex items-center">
                        <span class="text-xs md:text-sm bg-gradient-to-r from-amber-600 to-orange-600 text-white px-4 py-2 rounded-full flex items-center shadow-lg border border-yellow-400/30">
                            <i class="fas fa-crown mr-2 text-yellow-300"></i> 
                            <span class="font-semibold">Created by</span>
                            <span class="mx-2 font-bold text-yellow-100">genododi</span>
                            <span class="inline-flex items-center">
                                <i class="fas fa-glasses mx-1 glasses-icon text-yellow-300"></i>
                                <span class="font-medium">Ophthalmology Specialist</span>
                            </span>
                        </span>
                    </div>
                    
                    <!-- User Controls & Analytics -->
                    <div class="flex items-center gap-3">
                        <!-- User Display Container -->
                        <div class="user-display-container flex items-center">
                            <!-- User controls will be inserted here by AuthManager.js -->
                        </div>
                        
                        <!-- Feedback Analytics Button removed per user request -->
                        
                        <!-- Account Settings Dropdown -->
                        <div class="relative">
                            <button id="account-settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-3 py-2 rounded-full flex items-center transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 shadow-md">
                                <i class="fas fa-user-cog mr-2"></i>
                                <span class="hidden sm:inline">Account</span>
                                <i class="fas fa-chevron-down ml-1 text-xs"></i>
                            </button>
                            
                            <!-- Dropdown Menu -->
                            <div id="account-dropdown" class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-50 hidden">
                                <div class="py-2">
                                    <!-- User Info Section - Dynamic content managed by AuthManager -->
                                    <div class="px-4 py-3 border-b border-gray-100">
                                        <div class="flex items-center">
                                            <div id="user-avatar" class="w-10 h-10 bg-gradient-to-r from-amber-500 to-orange-600 rounded-full flex items-center justify-center">
                                                <i class="fas fa-crown text-yellow-200 text-sm"></i>
                                            </div>
                                            <div class="ml-3">
                                                <p id="dropdown-user-name" class="text-sm font-medium text-gray-900">genododi</p>
                                                <p id="dropdown-user-status" class="text-xs font-semibold text-amber-600">👑 Creator & Premium</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Settings Options -->
                                    <div class="py-1">
                                        <button class="account-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                            <i class="fas fa-palette mr-3 text-gray-400 w-4"></i>
                                            Theme Preferences
                                        </button>
                                        <button class="account-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                            <i class="fas fa-download mr-3 text-gray-400 w-4"></i>
                                            Export Settings
                                        </button>
                                        <button class="account-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                            <i class="fas fa-history mr-3 text-gray-400 w-4"></i>
                                            Usage History
                                        </button>
                                        <button class="account-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                            <i class="fas fa-key mr-3 text-gray-400 w-4"></i>
                                            API Key Management
                                        </button>
                                    </div>
                                    
                                    <!-- Divider -->
                                    <div class="border-t border-gray-100"></div>
                                    
                                    <!-- Advanced Options -->
                                    <div class="py-1">
                                        <button class="account-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                            <i class="fas fa-cog mr-3 text-gray-400 w-4"></i>
                                            Advanced Settings
                                        </button>
                                        <button class="account-option w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                            <i class="fas fa-question-circle mr-3 text-gray-400 w-4"></i>
                                            Help & Support
                                        </button>
                                        <button class="account-option w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                            <i class="fas fa-sign-out-alt mr-3 text-red-400 w-4"></i>
                                            Sign Out
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Offline Mode Indicator -->
                    <div id="offline-mode-indicator" class="hidden">
                        <span class="text-xs md:text-sm bg-purple-900 bg-opacity-30 px-3 py-1 rounded-full flex items-center">
                            <i class="fas fa-database mr-1"></i> 
                            <span id="offline-sets-count">0</span> Question Sets Available Offline
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Professional banner at bottom -->
            <div class="relative z-10 mt-4 pt-3 border-t border-white border-opacity-20 flex flex-wrap justify-between items-center text-xs">
                <div class="flex space-x-4 flex-wrap">
                    <span><i class="fas fa-certificate mr-1"></i> FRCS Exam Ready</span>
                    <span class="flex items-center"><i class="fas fa-book-medical mr-1 book-icon"></i> Evidence-Based Questions</span>
                    <span class="hidden md:inline-flex items-center"><i class="fas fa-brain mr-1 nerdy-icon"></i> Learning-Optimized Content</span>
                </div>
                <div id="account-status" class="text-right flex items-center gap-2 mt-2 lg:mt-0">
                    <span class="usage-counter hidden">Questions Saved: <span id="question-count">0</span></span>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">

            <section class="card bg-white p-5 md:p-6 rounded-lg shadow-md">
                <h2 class="text-xl md:text-2xl font-semibold text-accent mb-5 md:mb-6 pb-2 border-b border-gray-200 flex items-center">
                    <i class="fas fa-cog mr-2 text-primary"></i> 
                    Configuration
                    <div id="mode-indicators" class="ml-auto flex space-x-2 text-sm">
                        <span id="usmle-indicator" class="hidden bg-blue-600 text-white px-2 py-1 rounded-full text-xs">USMLE Mode</span>
                        <span id="kanski-indicator" class="hidden bg-green-600 text-white px-2 py-1 rounded-full text-xs">Kanski Loaded</span>
                    </div>
                </h2>

                <div class="mb-5">
                    <label for="input-type" class="block mb-2 font-medium text-gray-700">Select Input Source</label>
                    <select id="input-type" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition">
                        <option value="upload">Upload PDF/TXT Document</option>
                        <option value="text">Enter Text</option>
                        <option value="knowledge-base">Use Built-in Knowledge Base</option>
                        <option value="notebooklm">Use NotebookLM</option>
                    </select>
                </div>

                <div id="upload-container" class="mb-5">
                    <label class="block mb-2 font-medium text-gray-700">Ophthalmology Document</label>
                    <div id="file-drop-area" class="border-2 border-dashed border-gray-300 p-6 text-center rounded-md cursor-pointer hover:border-secondary transition duration-300 ease-in-out">
                        <input type="file" id="pdf-upload" accept=".pdf,.txt,.rtf,.docx,.md" class="hidden">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600">Drag & drop PDF, TXT, RTF, DOCX, or Markdown file here or <strong class="text-primary">click to browse</strong></p>
                        <p class="text-xs text-gray-500 mt-1">Max file size: 5GB</p>
                    </div>
                    <div id="file-info" class="mt-3 hidden text-sm">
                        <p id="file-name" class="font-medium text-gray-700"></p>
                        <div id="progress-bar-container" class="progress-bar-container hidden">
                            <div id="progress-bar" class="progress-bar"></div>
                        </div>
                        <div id="file-processing-status" class="text-gray-600 mt-1"></div>
                    </div>
                    
                    <!-- File Processing Options -->
                    <div id="file-processing-options" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <h4 class="font-medium text-blue-800 mb-3 flex items-center">
                            <i class="fas fa-cogs mr-2"></i>
                            File Processing Options
                        </h4>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="radio" id="process-generate" name="file-process-mode" value="generate" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300" checked>
                                <label for="process-generate" class="ml-2 block text-sm text-gray-700">
                                    <strong>Generate New Questions</strong> - Create questions based on document content
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="process-extract" name="file-process-mode" value="extract" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300">
                                <label for="process-extract" class="ml-2 block text-sm text-gray-700">
                                    <strong>Extract Existing Q&A</strong> - Find and display questions already in the document
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="process-both" name="file-process-mode" value="both" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300">
                                <label for="process-both" class="ml-2 block text-sm text-gray-700">
                                    <strong>Both</strong> - Extract existing Q&A and generate additional questions
                                </label>
                            </div>
                        </div>
                        
                        <!-- Advanced Extraction Settings -->
                        <div id="extraction-settings" class="mt-4 p-3 bg-white border border-gray-200 rounded-md hidden">
                            <h5 class="font-medium text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-search mr-1"></i>
                                Extraction Settings
                            </h5>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                                <div class="flex items-center">
                                    <input type="checkbox" id="extract-mcq" class="h-3 w-3 text-primary focus:ring-secondary border-gray-300 rounded" checked>
                                    <label for="extract-mcq" class="ml-2 text-gray-600">Multiple Choice Questions</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="extract-numbered" class="h-3 w-3 text-primary focus:ring-secondary border-gray-300 rounded" checked>
                                    <label for="extract-numbered" class="ml-2 text-gray-600">Numbered Questions</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="extract-qanda" class="h-3 w-3 text-primary focus:ring-secondary border-gray-300 rounded" checked>
                                    <label for="extract-qanda" class="ml-2 text-gray-600">Q: / A: Format</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="extract-bold" class="h-3 w-3 text-primary focus:ring-secondary border-gray-300 rounded" checked>
                                    <label for="extract-bold" class="ml-2 text-gray-600">Bold Question Patterns</label>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label for="min-question-length" class="block text-xs font-medium text-gray-600 mb-1">Minimum Question Length</label>
                                <input type="number" id="min-question-length" min="10" max="500" value="20" class="w-20 p-1 border border-gray-300 rounded text-xs">
                                <span class="text-xs text-gray-500 ml-2">characters</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="text-container" class="mb-5 hidden">
                    <label for="input-text" class="block mb-2 font-medium text-gray-700">Ophthalmology Text Content</label>
                    <textarea id="input-text" rows="8" placeholder="Enter ophthalmology content here..." class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition"></textarea>
                </div>

                <div id="notebook-container" class="mb-5 hidden">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block font-medium text-gray-700">Google NotebookLM Integration</label>
                        <button id="connect-notebooklm" class="text-sm bg-primary hover:bg-accent text-white px-3 py-1 rounded-md transition duration-300 ease-in-out flex items-center">
                            <i class="fas fa-plug mr-1"></i>
                            Connect
                        </button>
                    </div>

                    <div id="notebook-status" class="mb-3 p-3 bg-blue-50 text-primary rounded-md border border-blue-200 text-sm">
                        <p class="flex items-center"><i class="fas fa-info-circle mr-2"></i><span id="notebook-status-message">Please connect to NotebookLM to access your saved notes.</span></p>
                    </div>

                    <div id="notebook-selection" class="hidden">
                        <label for="notebook-select" class="block mb-2 text-sm font-medium text-gray-700">Select Notebook</label>
                        <select id="notebook-select" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition">
                            <option value="">-- Select a notebook --</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Choose a notebook to import content for question generation.</p>
                        
                        <div id="selected-notebook-info" class="mt-3 p-3 bg-gray-50 rounded-md border border-gray-200 hidden">
                            <h4 class="font-medium text-gray-800" id="selected-notebook-title"></h4>
                            <p class="text-sm text-gray-600 mt-1" id="selected-notebook-description"></p>
                        </div>
                    </div>
                </div>

                <div id="knowledge-base-container" class="mb-5"> 
                    <label for="knowledge-area" class="block mb-2 font-medium text-gray-700">Select Subspecialty Focus</label>
                    <select id="knowledge-area" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition">
                        <option value="general">General Ophthalmology (No Specific Focus)</option>
                        <option value="all">All Listed Subspecialties</option>
                        <option value="retinal-disorders">Retinal Disorders</option>
                        <option value="corneal-diseases">Corneal Diseases</option>
                        <option value="glaucoma">Glaucoma</option>
                        <option value="cataract">Cataract & Lens Disorders</option>
                        <option value="refractive-errors">Refractive Errors</option>
                        <option value="neuro-ophthalmology">Neuro-ophthalmology</option>
                        <option value="ocular-inflammation">Ocular Inflammation & Uveitis</option>
                        <option value="pediatric">Pediatric Ophthalmology</option>
                        <option value="oculoplastics-oncology">Oculoplastics & Oncology</option>
                    </select>
                     <p class="text-xs text-gray-500 mt-1">Guides question generation for all input types.</p>
                </div>

                <div id="ai-model-container" class="mb-5">
                    <label for="ai-model" class="block mb-2 font-medium text-gray-700">AI Model</label>
                    <select id="ai-model" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition">
                        <option value="gemini">Google Gemini (Default)</option>
                        <option value="openai">OpenAI GPT-4o</option>
                        <option value="huggingface">Hugging Face Models</option>
                        <option value="claude">Anthropic Claude</option>
                        <option value="biomistral">BioMistral</option>

                    </select>
                    <p class="text-xs text-gray-500 mt-1">Select AI model for question generation. Higher quota for Gemini.</p>
                </div>

                <!-- USMLE Mode Toggle -->
                <div class="mb-5 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <label for="usmle-mode" class="block font-medium text-gray-700 flex items-center">
                                <i class="fas fa-user-md mr-2 text-blue-600"></i>
                                USMLE Mode (All Steps 1, 2, 3)
                            </label>
                            <p class="text-sm text-gray-600 mt-1">Include all medical & surgical information, not just ophthalmology</p>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="usmle-mode" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        </div>
                    </div>
                </div>

                <!-- Kanski File Toggle -->
                <div class="mb-5 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <label for="load-kanski" class="block font-medium text-gray-700 flex items-center">
                                <i class="fas fa-book-medical mr-2 text-green-600"></i>
                                Load Kanski 1st Edition
                            </label>
                            <p class="text-sm text-gray-600 mt-1">Load content from Kanski 1st edition.apkg file</p>
                            <p class="text-xs text-gray-500 mt-1">Path: /Users/mahmoudsami/Downloads/Kanski 1st edition.apkg</p>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="load-kanski" class="h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                        </div>
                    </div>
                    <div id="kanski-status" class="mt-3 text-sm text-gray-600 hidden">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            <span id="kanski-status-text">Ready to load Kanski file</span>
                        </div>
                    </div>
                </div>

                <h2 class="text-xl md:text-2xl font-semibold text-accent mb-5 md:mb-6 pb-2 border-b border-gray-200 flex items-center">
                    <i class="fas fa-pen-fancy mr-2 text-primary"></i>
                    Generation Settings
                </h2>

                <div class="mb-5">
                    <label class="block mb-3 font-medium text-gray-700">Question Types</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                        <div class="flex items-center col-span-2 sm:col-span-3 pb-1 mb-1 border-b border-gray-200">
                            <input type="checkbox" id="type-all" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded">
                            <label for="type-all" class="ml-2 block text-sm font-medium text-gray-700">Select All</label>
                        </div>
                        <div class="flex items-center"><input type="checkbox" id="type-mcq" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded"><label for="type-mcq" class="ml-2 block text-sm text-gray-700">Multiple Choice</label></div>
                        <div class="flex items-center"><input type="checkbox" id="type-tf" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded"><label for="type-tf" class="ml-2 block text-sm text-gray-700">True/False</label></div>
                        <div class="flex items-center"><input type="checkbox" id="type-matching" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded"><label for="type-matching" class="ml-2 block text-sm text-gray-700">Matching</label></div>
                        <div class="flex items-center"><input type="checkbox" id="type-short-answer" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded" checked><label for="type-short-answer" class="ml-2 block text-sm text-gray-700">Short Answer</label></div>
                        <div class="flex items-center"><input type="checkbox" id="type-clinical-case" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded" checked><label for="type-clinical-case" class="ml-2 block text-sm text-gray-700">Clinical Case</label></div>
                        <div class="flex items-center"><input type="checkbox" id="type-differential" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded" checked><label for="type-differential" class="ml-2 block text-sm text-gray-700">Differential</label></div>
                        <div class="flex items-center"><input type="checkbox" id="type-management" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded" checked><label for="type-management" class="ml-2 block text-sm text-gray-700">Management</label></div>
                        <div class="flex items-center"><input type="checkbox" id="type-viva" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded" checked><label for="type-viva" class="ml-2 block text-sm text-gray-700">VIVA</label></div>
                        <div class="flex items-center"><input type="checkbox" id="type-osce" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded" checked><label for="type-osce" class="ml-2 block text-sm text-gray-700">OSCE Stations</label></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
                    <div>
                        <label for="difficulty" class="block mb-2 font-medium text-gray-700">Difficulty Level</label>
                        <select id="difficulty" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition">
                            <option value="resident">Resident/Training</option>
                            <option value="board">Board Preparation</option>
                            <option value="specialist">Specialist/Fellow</option>
                            <option value="advanced" selected>Advanced Practice</option>
                        </select>
                    </div>
                    <div>
                        <label for="num-questions" class="block mb-2 font-medium text-gray-700">Number of Questions</label>
                        <input type="number" id="num-questions" min="1" max="50" value="10" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition">
                    </div>
                </div>

                <div class="mb-5">
                    <label for="focus-area" class="block mb-2 font-medium text-gray-700">Additional Focus Keywords (Optional)</label>
                    <input type="text" id="focus-area" placeholder="e.g., specific drug names, techniques" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition">
                     <p class="text-xs text-gray-500 mt-1">Use for specific terms not covered by subspecialty.</p>
                </div>

                <div class="mb-5">
                    <div class="flex items-center">
                        <input type="checkbox" id="show-answers-default" class="h-4 w-4 text-primary focus:ring-secondary border-gray-300 rounded">
                        <label for="show-answers-default" class="ml-2 block text-sm font-medium text-gray-700">Show Answers by Default</label>
                    </div>
                </div>

                <div class="button-container">
                    <button id="generate-btn" type="button" class="action-btn flex-1 bg-primary hover:bg-accent text-white font-semibold py-3 px-3 rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i>
                        Generate Questions
                    </button>
                    <button id="extract-qa-btn" type="button" class="action-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-3 rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center hidden">
                        <i class="fas fa-search mr-2"></i>
                        Extract Q&A
                    </button>
                    <button id="clear-btn" type="button" class="action-btn flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-3 rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 flex items-center justify-center">
                        <i class="fas fa-eraser mr-2"></i>
                        Clear
                    </button>
                </div>
            </section>

            <section class="card bg-white p-5 md:p-6 rounded-lg shadow-md flex flex-col h-[80vh] lg:h-auto">
                <h2 class="text-xl md:text-2xl font-semibold text-accent mb-5 md:mb-6 pb-2 border-b border-gray-200 flex items-center">
                    <i class="fas fa-question-circle mr-2 text-primary"></i>
                    Generated Questions
                </h2>

                <div id="loading-indicator" class="hidden flex-col items-center justify-center text-center p-6">
                    <div class="spinner animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-primary mb-3"></div>
                    <p class="text-gray-600">Generating questions via API...</p>
                </div>

                <div id="status-message" aria-live="polite" class="hidden text-center my-4 p-3 rounded-md font-medium"></div>

                <div id="qa-container" class="flex-grow overflow-y-auto bg-gray-50 p-4 rounded-md border border-gray-200 min-h-[200px]">
                    <p class="empty-state">Generated questions will appear here. Configure your settings and click "Generate Questions" to begin.</p>
                </div>

                <div class="button-container">
                    <!-- Export Format Dropdown -->
                    <div class="export-format-container">
                        <label for="export-format" class="sr-only">Export Format</label>
                        <select id="export-format" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent transition text-sm font-medium">
                            <option value="txt">TXT</option>
                            <option value="json">JSON</option>
                            <option value="docx">DOCX</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    
                    <!-- Primary Action Buttons -->
                    <div class="primary-actions">
                        <button id="export-btn" type="button" class="action-btn bg-green-600 hover:bg-green-700 text-white font-semibold rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-download"></i>
                            <span>Export</span>
                        </button>
                        <button id="regenerate-btn" type="button" class="action-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-sync-alt"></i>
                            <span>Regenerate</span>
                        </button>
                        <button id="clear-history-btn" type="button" class="action-btn bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-eraser"></i>
                            <span>Clear History</span>
                        </button>
                    </div>
                    
                    <!-- Secondary Action Buttons -->
                    <div class="secondary-actions">
                        <button id="selection-mode-btn" type="button" class="action-btn bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-700">
                            <i class="fas fa-check-square"></i>
                            <span>Select Questions</span>
                        </button>
                        <button id="save-offline-btn" type="button" class="action-btn bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-save"></i>
                            <span>Save Offline</span>
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">Note: Your browser will ask where to save the exported file.</p>
            </section>
        </main>

        <!-- Offline Saved Questions Section -->
        <section id="offline-questions-section" class="mt-8 bg-white p-5 md:p-6 rounded-lg shadow-md">
            <h2 class="text-xl md:text-2xl font-semibold text-accent mb-5 md:mb-6 pb-2 border-b border-gray-200 flex items-center">
                <i class="fas fa-database mr-2 text-primary"></i>
                Offline Question Sets
                <span class="ml-auto text-sm font-normal text-gray-500 flex items-center">
                    <i class="fas fa-wifi-slash mr-1"></i> Available without internet
                </span>
            </h2>
            
            <!-- Enhanced Storage Status Notification -->
            <div id="storage-status-notification" class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg hidden">
                <div class="flex items-center">
                    <i class="fas fa-shield-check text-green-600 mr-2"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-green-800">Enhanced Persistent Storage Active</p>
                        <p class="text-xs text-green-600">Your question sets are protected with double-backup storage and will persist forever, even across browser restarts and offline mode.</p>
                    </div>
                    <button id="dismiss-storage-notification" class="text-green-600 hover:text-green-800 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div id="offline-sets-container" class="mb-6">
                <div id="no-offline-sets" class="text-center py-8 text-gray-500">
                    <i class="fas fa-folder-open text-4xl mb-3 opacity-50"></i>
                    <p>No saved question sets found. Generate questions and click "Save Offline" to create your first set.</p>
                </div>
                
                <div id="offline-sets-list" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Saved question sets will be dynamically inserted here -->
                </div>
            </div>
            
            <div class="flex justify-end">
                <button id="clear-all-offline-btn" class="action-btn bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 flex items-center">
                    <i class="fas fa-trash-alt mr-2"></i>
                    Clear All Saved Sets
                </button>
            </div>
        </section>

        <footer class="text-center mt-8 md:mt-12 py-4 text-gray-500 text-sm">
            <p>OphthalmoQA utilizes specialized medical NLP models for analysis and question generation.</p>
            <div class="mt-3 mb-4">
                <a href="https://www.paypal.com/paypalme/docms90/50" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full transition shadow-md">
                    <i class="fab fa-paypal mr-2"></i> Donate me a Donut to keep your Qbanks updated
                </a>
            </div>
            <p>&copy; <span id="current-year"></span> Medical Education Technologies</p>
        </footer>
    </div>

    <!-- Modal for NotebookLM Authentication -->
    <div id="notebooklm-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="notebooklm-modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl z-10 relative">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-book-open text-primary mr-2"></i>
                    Connect to Google NotebookLM
                </h3>
                <button id="close-notebooklm-modal" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-5">
                    <p class="text-gray-700 mb-3">To import notes from Google NotebookLM, please follow these steps:</p>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-3">
                        <h4 class="font-semibold text-blue-800 mb-2">Step-by-Step Instructions:</h4>
                        <ol class="text-sm space-y-3 text-blue-800">
                            <li class="flex items-start">
                                <span class="font-bold mr-2">1.</span>
                                <div>
                                    <p>Open <a href="https://notebooklm.google.com" target="_blank" class="text-blue-600 hover:underline font-medium">Google NotebookLM</a> in your browser and sign in</p>
                                </div>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2">2.</span>
                                <div>
                                    <p>Right-click anywhere on the page and select <strong class="bg-yellow-100 px-1 py-0.5 rounded">"View Page Source"</strong></p>
                                    <div class="mt-1 bg-white p-2 border border-gray-200 rounded text-xs flex items-center text-gray-600">
                                        <i class="fas fa-exclamation-triangle text-amber-500 mr-1"></i>
                                        <span>Important: Select <strong>"View Page Source"</strong> (not "Inspect" or "Inspect Element")</span>
                                        <img src="https://i.imgur.com/xKvR5gt.png" alt="View Page Source Menu" class="ml-2 h-12 rounded border border-gray-300">
                                    </div>
                                </div>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2">3.</span>
                                <div>
                                    <p>After the new tab opens with source code, press <strong>Ctrl+A</strong> (or <strong>⌘+A</strong> on Mac) to select all code</p>
                                </div>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2">4.</span>
                                <div>
                                    <p>Press <strong>Ctrl+C</strong> (or <strong>⌘+C</strong> on Mac) to copy all code</p>
                                </div>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2">5.</span>
                                <div>
                                    <p>Paste the copied code below</p>
                                </div>
                            </li>
                        </ol>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 mb-3">
                        <p class="text-xs text-yellow-800 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-yellow-600"></i>
                            <span>If you're having trouble with authentication, don't worry! A "Use Demo Notebook" option will appear after attempting to authenticate.</span>
                        </p>
                    </div>
                </div>
                <div class="mb-5">
                    <label for="notebooklm-code" class="block mb-2 text-sm font-medium text-gray-700">NotebookLM HTML Code</label>
                    <textarea id="notebooklm-code" rows="8" placeholder="Paste Google NotebookLM page source code here..." class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"></textarea>
                </div>
                <div id="notebooklm-auth-status" class="mb-4 p-3 rounded-md hidden">
                    <!-- Status messages will be shown here -->
                </div>
                <div class="flex justify-end">
                    <button id="authenticate-notebooklm" class="bg-primary hover:bg-accent text-white font-medium py-2 px-5 rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary flex items-center">
                        <i class="fas fa-key mr-2"></i>
                        Import Notes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Saving Question Set -->
    <div id="save-question-set-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="save-question-set-modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-10 relative">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-save text-purple-600 mr-2"></i>
                    Save Question Set Offline
                </h3>
                <button id="close-save-question-modal" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-5">
                    <label for="question-set-title" class="block mb-2 text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="question-set-title" placeholder="Enter a title for this question set" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                </div>
                <div class="mb-5">
                    <label for="question-set-description" class="block mb-2 text-sm font-medium text-gray-700">Description (Optional)</label>
                    <textarea id="question-set-description" rows="3" placeholder="Add notes about this question set..." class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"></textarea>
                </div>
                <div class="mb-5">
                    <div class="flex items-center">
                        <input type="checkbox" id="question-set-favorite" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                        <label for="question-set-favorite" class="ml-2 block text-sm font-medium text-gray-700">Mark as Favorite</label>
                    </div>
                </div>
                <div id="save-question-set-status" class="mb-4 p-3 rounded-md hidden">
                    <!-- Status messages will be shown here -->
                </div>
                <div class="flex justify-end">
                    <button id="confirm-save-question-set" class="action-btn bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-5 rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-600 flex items-center">
                        <i class="fas fa-save mr-2"></i>
                        Save Offline
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Offline Question Set -->
    <div id="view-question-set-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="view-question-set-modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl z-10 relative">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center" id="view-question-set-title">
                    <i class="fas fa-list-alt text-primary mr-2"></i>
                    Question Set
                </h3>
                <button id="close-view-question-modal" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <div id="view-question-set-metadata" class="mb-4 pb-3 border-b border-gray-200">
                    <p id="view-question-set-description" class="text-gray-600 text-sm mb-2"></p>
                    <div class="flex flex-wrap gap-2 text-xs">
                        <span id="view-question-set-date" class="bg-gray-100 text-gray-700 px-2 py-1 rounded-md flex items-center">
                            <i class="far fa-calendar-alt mr-1"></i>
                            <span></span>
                        </span>
                        <span id="view-question-set-count" class="bg-blue-100 text-blue-700 px-2 py-1 rounded-md flex items-center">
                            <i class="fas fa-question-circle mr-1"></i>
                            <span></span>
                        </span>
                        <span id="view-question-set-source" class="bg-green-100 text-green-700 px-2 py-1 rounded-md flex items-center">
                            <i class="fas fa-file-alt mr-1"></i>
                            <span></span>
                        </span>
                    </div>
                </div>
                <div id="view-question-set-content" class="max-h-[60vh] overflow-y-auto">
                    <!-- Questions will be loaded here -->
                </div>
                <div class="mt-5 flex justify-between">
                    <button id="delete-question-set" class="action-btn bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i>
                        Delete Set
                    </button>
                    <button id="load-question-set" class="action-btn bg-primary hover:bg-accent text-white font-medium py-2 px-5 rounded-md shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary flex items-center">
                        <i class="fas fa-arrow-right mr-2"></i>
                        Load to Main View
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comprehensive Feedback Analytics Modal -->
    <div id="feedback-analytics-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="feedback-analytics-modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden z-10 relative">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                <h3 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-chart-line mr-3"></i>
                    Feedback Analytics & Continuous Improvement Dashboard
                </h3>
                <button id="close-feedback-analytics-modal" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto max-h-[calc(90vh-4rem)]">
                <!-- Analytics Overview -->
                <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-tachometer-alt text-blue-600 mr-2"></i>
                        System Performance Overview
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Feedback</p>
                                    <p id="analytics-total-feedback" class="text-2xl font-bold text-blue-600">0</p>
                                </div>
                                <i class="fas fa-comments text-blue-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-green-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Improvements Made</p>
                                    <p id="analytics-improvements" class="text-2xl font-bold text-green-600">0</p>
                                </div>
                                <i class="fas fa-arrow-trend-up text-green-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-purple-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Learning Accuracy</p>
                                    <p id="analytics-learning-accuracy" class="text-2xl font-bold text-purple-600">0%</p>
                                </div>
                                <i class="fas fa-brain text-purple-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-orange-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Optimization Cycles</p>
                                    <p id="analytics-optimization-cycles" class="text-2xl font-bold text-orange-600">0</p>
                                </div>
                                <i class="fas fa-cogs text-orange-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-time Feedback Trends -->
                <div class="p-6 border-b border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-green-600 mr-2"></i>
                        Real-time Feedback Trends
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-medium text-green-800 mb-3">Quality Feedback</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Good</span>
                                    <span id="quality-good-count" class="font-semibold text-green-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Poor</span>
                                    <span id="quality-poor-count" class="font-semibold text-red-600">0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div id="quality-progress" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-lg border border-blue-200">
                            <h5 class="font-medium text-blue-800 mb-3">Relevance Feedback</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Relevant</span>
                                    <span id="relevance-yes-count" class="font-semibold text-blue-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Not Relevant</span>
                                    <span id="relevance-no-count" class="font-semibold text-red-600">0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div id="relevance-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200">
                            <h5 class="font-medium text-purple-800 mb-3">Difficulty Feedback</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Appropriate</span>
                                    <span id="difficulty-appropriate-count" class="font-semibold text-purple-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Too Hard</span>
                                    <span id="difficulty-hard-count" class="font-semibold text-red-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Too Easy</span>
                                    <span id="difficulty-easy-count" class="font-semibold text-orange-600">0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div id="difficulty-progress" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Preferences Learned -->
                <div class="p-6 border-b border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-user-cog text-indigo-600 mr-2"></i>
                        Learned User Preferences
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-4 rounded-lg border border-indigo-200">
                            <h5 class="font-medium text-indigo-800 mb-3">Preferred Topics</h5>
                            <div id="preferred-topics" class="space-y-2">
                                <p class="text-sm text-gray-600">Learning your preferences...</p>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-teal-50 to-cyan-50 p-4 rounded-lg border border-teal-200">
                            <h5 class="font-medium text-teal-800 mb-3">Question Type Preferences</h5>
                            <div id="preferred-types" class="space-y-2">
                                <p class="text-sm text-gray-600">Learning your preferences...</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 bg-gradient-to-r from-gray-50 to-slate-50 p-4 rounded-lg border border-gray-200">
                        <h5 class="font-medium text-gray-800 mb-3">Current Optimization Settings</h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <span class="text-xs text-gray-600">Difficulty Bias</span>
                                <div class="flex items-center mt-1">
                                    <span id="difficulty-bias-value" class="text-sm font-semibold">0.5</span>
                                    <div class="ml-2 flex-1 bg-gray-200 rounded-full h-2">
                                        <div id="difficulty-bias-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 50%"></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <span class="text-xs text-gray-600">Complexity Level</span>
                                <p id="complexity-level" class="text-sm font-semibold mt-1">Medium</p>
                            </div>
                            <div>
                                <span class="text-xs text-gray-600">Quality Focus</span>
                                <div class="flex items-center mt-1">
                                    <span id="quality-focus-value" class="text-sm font-semibold">0.5</span>
                                    <div class="ml-2 flex-1 bg-gray-200 rounded-full h-2">
                                        <div id="quality-focus-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 50%"></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <span class="text-xs text-gray-600">Last Optimization</span>
                                <p id="last-optimization-time" class="text-xs text-gray-600 mt-1">Never</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Improvements -->
                <div class="p-6 border-b border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-history text-emerald-600 mr-2"></i>
                        Recent Improvements & Optimizations
                    </h4>
                    <div id="recent-improvements" class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-center text-gray-600">
                            <i class="fas fa-robot text-2xl mb-2 opacity-50"></i>
                            <p>No recent improvements. The system will automatically optimize based on your feedback.</p>
                        </div>
                    </div>
                </div>

                <!-- System Recommendations -->
                <div class="p-6 border-b border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>
                        AI Recommendations
                    </h4>
                    <div id="system-recommendations" class="space-y-3">
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-center text-yellow-800">
                            <i class="fas fa-brain text-2xl mb-2"></i>
                            <p>Gathering feedback to generate intelligent recommendations...</p>
                        </div>
                    </div>
                </div>

                <!-- Engagement Metrics -->
                <div class="p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-pie text-pink-600 mr-2"></i>
                        Engagement Metrics
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-pink-50 to-rose-50 p-4 rounded-lg border border-pink-200">
                            <h5 class="font-medium text-pink-800 mb-3">Session Statistics</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Session Duration</span>
                                    <span id="session-duration" class="text-sm font-semibold">0m</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Questions Viewed</span>
                                    <span id="questions-viewed" class="text-sm font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Feedback Rate</span>
                                    <span id="feedback-rate" class="text-sm font-semibold">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-amber-50 to-yellow-50 p-4 rounded-lg border border-amber-200">
                            <h5 class="font-medium text-amber-800 mb-3">Learning Efficiency</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Avg. View Time</span>
                                    <span id="avg-view-time" class="text-sm font-semibold">0s</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Quick Reviews</span>
                                    <span id="quick-reviews" class="text-sm font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Deep Studies</span>
                                    <span id="deep-studies" class="text-sm font-semibold">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-emerald-50 to-teal-50 p-4 rounded-lg border border-emerald-200">
                            <h5 class="font-medium text-emerald-800 mb-3">System Response</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Auto-Suggestions</span>
                                    <span id="auto-suggestions" class="text-sm font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Applied Fixes</span>
                                    <span id="applied-fixes" class="text-sm font-semibold">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Success Rate</span>
                                    <span id="fix-success-rate" class="text-sm font-semibold">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="p-6 bg-gray-50 border-t border-gray-200">
                    <div class="flex flex-wrap gap-3 justify-between">
                        <div class="flex gap-3">
                            <button id="refresh-analytics-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200 flex items-center text-sm">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Refresh Data
                            </button>
                            <button id="export-analytics-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition duration-200 flex items-center text-sm">
                                <i class="fas fa-download mr-2"></i>
                                Export Report
                            </button>
                            <button id="optimize-parameters-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md transition duration-200 flex items-center text-sm">
                                <i class="fas fa-magic mr-2"></i>
                                Optimize Now
                            </button>
                        </div>
                        <div class="flex gap-3">
                            <button id="reset-analytics-data-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition duration-200 flex items-center text-sm">
                                <i class="fas fa-trash-alt mr-2"></i>
                                Reset Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comprehensive Feedback Analytics Modal -->
    <div id="feedback-analytics-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="feedback-analytics-modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden z-10 relative">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                <h3 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-chart-line mr-3"></i>
                    Feedback Analytics & Continuous Improvement Dashboard
                </h3>
                <button id="close-feedback-analytics-modal" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto max-h-[calc(90vh-4rem)]">
                <!-- Analytics Overview -->
                <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-tachometer-alt text-blue-600 mr-2"></i>
                        System Performance Overview
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Feedback</p>
                                    <p id="analytics-total-feedback" class="text-2xl font-bold text-blue-600">0</p>
                                </div>
                                <i class="fas fa-comments text-blue-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-green-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Improvements Made</p>
                                    <p id="analytics-improvements" class="text-2xl font-bold text-green-600">0</p>
                                </div>
                                <i class="fas fa-arrow-trend-up text-green-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-purple-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Learning Accuracy</p>
                                    <p id="analytics-learning-accuracy" class="text-2xl font-bold text-purple-600">0%</p>
                                </div>
                                <i class="fas fa-brain text-purple-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-orange-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Optimization Cycles</p>
                                    <p id="analytics-optimization-cycles" class="text-2xl font-bold text-orange-600">0</p>
                                </div>
                                <i class="fas fa-cogs text-orange-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-time Feedback Trends -->
                <div class="p-6 border-b border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-green-600 mr-2"></i>
                        Real-time Feedback Trends
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-medium text-green-800 mb-3">Quality Feedback</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Good</span>
                                    <span id="quality-good-count" class="font-semibold text-green-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Poor</span>
                                    <span id="quality-poor-count" class="font-semibold text-red-600">0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div id="quality-progress" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-lg border border-blue-200">
                            <h5 class="font-medium text-blue-800 mb-3">Relevance Feedback</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Relevant</span>
                                    <span id="relevance-yes-count" class="font-semibold text-blue-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Not Relevant</span>
                                    <span id="relevance-no-count" class="font-semibold text-red-600">0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div id="relevance-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200">
                            <h5 class="font-medium text-purple-800 mb-3">Difficulty Feedback</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Appropriate</span>
                                    <span id="difficulty-appropriate-count" class="font-semibold text-purple-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Too Hard</span>
                                    <span id="difficulty-hard-count" class="font-semibold text-red-600">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Too Easy</span>
                                    <span id="difficulty-easy-count" class="font-semibold text-orange-600">0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                    <div id="difficulty-progress" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="p-6 bg-gray-50 border-t border-gray-200">
                    <div class="flex flex-wrap gap-3 justify-between">
                        <div class="flex gap-3">
                            <button id="refresh-analytics-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200 flex items-center text-sm">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Refresh Data
                            </button>
                            <button id="export-analytics-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition duration-200 flex items-center text-sm">
                                <i class="fas fa-download mr-2"></i>
                                Export Report
                            </button>
                            <button id="optimize-parameters-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md transition duration-200 flex items-center text-sm">
                                <i class="fas fa-magic mr-2"></i>
                                Optimize Now
                            </button>
                        </div>
                        <div class="flex gap-3">
                            <button id="reset-analytics-data-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition duration-200 flex items-center text-sm">
                                <i class="fas fa-trash-alt mr-2"></i>
                                Reset Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Required library for better PDF and DOCX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    
    <!-- Script for enhanced export functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('export-btn');
            const exportFormat = document.getElementById('export-format');
            const qaContainer = document.getElementById('qa-container');
            
            if (exportBtn) {
                // Store the original click handler if it exists
                const originalExportClick = exportBtn.onclick;
                
                exportBtn.onclick = function(e) {
                    // Get selected export format
                    const format = exportFormat.value;
                    
                    log(`Export requested in ${format.toUpperCase()} format`, 'info');
                    
                    // Handle the export based on format
                    if (format === 'pdf') {
                        exportToPdf();
                        return; // Don't call original handler
                    } else if (format === 'docx') {
                        exportToDocx();
                        return; // Don't call original handler
                    }
                    
                    // For other formats, call the original handler if it exists
                    if (originalExportClick) originalExportClick.call(this, e);
                };
            }
            
            // Function to export questions as PDF
            function exportToPdf() {
                log('Starting PDF export process...', 'info');
                
                // Check if questions exist
                const questions = qaContainer.querySelectorAll('.question-item');
                if (questions.length === 0) {
                    log('No questions to export!', 'error');
                    alert('No questions to export! Please generate questions first.');
                    return;
                }
                
                // Create temporary container with cleaner styling for PDF
                const tempContainer = document.createElement('div');
                tempContainer.className = 'pdf-export-container';
                tempContainer.style.width = '100%';
                tempContainer.style.maxWidth = '800px';
                tempContainer.style.margin = '0 auto';
                tempContainer.style.padding = '20px';
                tempContainer.style.backgroundColor = 'white';
                tempContainer.style.fontFamily = 'Arial, sans-serif';
                
                // Add title
                const title = document.createElement('h1');
                title.textContent = 'OphthalmoQA Generated Questions';
                title.style.textAlign = 'center';
                title.style.color = '#2c6fa5';
                title.style.marginBottom = '20px';
                tempContainer.appendChild(title);
                
                // Add subtitle with date
                const subtitle = document.createElement('p');
                subtitle.textContent = `Generated on ${new Date().toLocaleDateString()}`;
                subtitle.style.textAlign = 'center';
                subtitle.style.color = '#666';
                subtitle.style.marginBottom = '30px';
                tempContainer.appendChild(subtitle);
                
                // Clone each question with cleaner styling
                questions.forEach((question, index) => {
                    const questionClone = document.createElement('div');
                    questionClone.style.marginBottom = '30px';
                    questionClone.style.pageBreakInside = 'avoid';
                    
                    // Question number
                    const questionNumber = document.createElement('h3');
                    questionNumber.textContent = `Question ${index + 1}`;
                    questionNumber.style.color = '#2c6fa5';
                    questionNumber.style.marginBottom = '10px';
                    questionClone.appendChild(questionNumber);
                    
                    // Question text
                    const questionText = question.querySelector('.question-text');
                    if (questionText) {
                        const questionTextClone = document.createElement('div');
                        questionTextClone.innerHTML = questionText.innerHTML;
                        questionTextClone.style.fontWeight = 'bold';
                        questionTextClone.style.marginBottom = '15px';
                        questionClone.appendChild(questionTextClone);
                    }
                    
                    // Options if it's a multiple choice question
                    const options = question.querySelectorAll('.question-option');
                    if (options.length > 0) {
                        const optionsList = document.createElement('div');
                        optionsList.style.marginLeft = '20px';
                        optionsList.style.marginBottom = '15px';
                        
                        options.forEach(option => {
                            const optionClone = document.createElement('div');
                            optionClone.innerHTML = option.innerHTML;
                            optionClone.style.marginBottom = '5px';
                            optionsList.appendChild(optionClone);
                        });
                        
                        questionClone.appendChild(optionsList);
                    }
                    
                    // Answer
                    const answer = question.querySelector('.answer-text');
                    if (answer) {
                        const answerTitle = document.createElement('div');
                        answerTitle.textContent = 'Answer:';
                        answerTitle.style.fontWeight = 'bold';
                        answerTitle.style.marginTop = '10px';
                        answerTitle.style.marginBottom = '5px';
                        questionClone.appendChild(answerTitle);
                        
                        const answerClone = document.createElement('div');
                        answerClone.innerHTML = answer.innerHTML;
                        answerClone.style.backgroundColor = '#f5f9fc';
                        answerClone.style.padding = '10px';
                        answerClone.style.borderLeft = '3px solid #2c6fa5';
                        questionClone.appendChild(answerClone);
                    }
                    
                    tempContainer.appendChild(questionClone);
                    
                    // Add a separator except after the last question
                    if (index < questions.length - 1) {
                        const separator = document.createElement('hr');
                        separator.style.margin = '30px 0';
                        separator.style.border = 'none';
                        separator.style.borderTop = '1px solid #eee';
                        tempContainer.appendChild(separator);
                    }
                });
                
                // Add watermark/footer
                const footer = document.createElement('div');
                footer.textContent = 'Generated by OphthalmoQA - FRCS Guru';
                footer.style.textAlign = 'center';
                footer.style.marginTop = '40px';
                footer.style.color = '#999';
                footer.style.fontSize = '12px';
                tempContainer.appendChild(footer);
                
                // Add to body but hide it
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                document.body.appendChild(tempContainer);
                
                log('Temporary container created, generating PDF...', 'info');
                
                // Use html2canvas and jsPDF to create the PDF
                html2canvas(tempContainer, {
                    scale: 1.5, // Higher scale for better quality
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    log('Canvas rendering complete, creating PDF document...', 'info');
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    
                    // Calculate dimensions
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    
                    // Calculate the number of pages
                    const pdfRatio = pdfHeight / pdfWidth;
                    const canvasRatio = canvasHeight / canvasWidth;
                    let totalPages;
                    
                    if (canvasRatio > pdfRatio) {
                        // Canvas is taller relative to width than PDF
                        totalPages = Math.ceil(canvasHeight * (pdfWidth / canvasWidth) / pdfHeight);
                    } else {
                        totalPages = 1;
                    }
                    
                    // Add each page
                    let position = 0;
                    for (let i = 0; i < totalPages; i++) {
                        if (i > 0) {
                            pdf.addPage();
                        }
                        
                        // Each page
                        pdf.addImage(
                            imgData, 
                            'JPEG', 
                            0, 
                            position, 
                            pdfWidth, 
                            canvasHeight * (pdfWidth / canvasWidth)
                        );
                        
                        position -= pdfHeight;
                    }
                    
                    log('PDF created successfully, initiating download...', 'success');
                    
                    // Download the PDF
                    pdf.save('ophthalmoqa-questions.pdf');
                    
                    // Remove the temporary container
                    document.body.removeChild(tempContainer);
                }).catch(error => {
                    log('Error generating PDF: ' + error.message, 'error');
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try a different format or check console for details.');
                    
                    // Remove the temporary container
                    document.body.removeChild(tempContainer);
                });
            }
            
            // Function to export questions as DOCX
            function exportToDocx() {
                log('Starting DOCX export process...', 'info');
                
                // Check if questions exist
                const questions = qaContainer.querySelectorAll('.question-item');
                if (questions.length === 0) {
                    log('No questions to export!', 'error');
                    alert('No questions to export! Please generate questions first.');
                    return;
                }
                
                // Use simpler approach - create text content and use a third-party conversion service
                let textContent = "# OphthalmoQA Generated Questions\n\n";
                textContent += `Generated on ${new Date().toLocaleDateString()}\n\n`;
                
                // Process each question
                questions.forEach((question, index) => {
                    textContent += `## Question ${index + 1}\n\n`;
                    
                    // Question text
                    const questionText = question.querySelector('.question-text');
                    if (questionText) {
                        textContent += `${questionText.textContent.trim()}\n\n`;
                    }
                    
                    // Options if it's a multiple choice question
                    const options = question.querySelectorAll('.question-option');
                    if (options.length > 0) {
                        options.forEach((option, optIndex) => {
                            textContent += `- ${option.textContent.trim()}\n`;
                        });
                        textContent += "\n";
                    }
                    
                    // Answer
                    const answer = question.querySelector('.answer-text');
                    if (answer) {
                        textContent += `**Answer:**\n\n${answer.textContent.trim()}\n\n`;
                    }
                    
                    // Add separator between questions
                    if (index < questions.length - 1) {
                        textContent += "---\n\n";
                    }
                });
                
                // Add footer
                textContent += "\n\n*Generated by OphthalmoQA - FRCS Guru*";
                
                // Create a blob from the text content
                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                // Create download link
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ophthalmoqa-questions.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log('Text document download initiated - please convert to DOCX in Word or Google Docs', 'success');
                alert('Due to browser limitations, we\'ve exported your questions as a text file. To convert to DOCX:\n\n1. Open the downloaded file in Microsoft Word or Google Docs\n2. The file contains markdown formatting that will be preserved\n3. Save or export as DOCX from your word processor');
            }
        });
    </script>

    <!-- Enhanced Feedback Analytics Modal -->
    <div id="feedback-analytics-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="feedback-analytics-modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl z-10 relative">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                    Enhanced Feedback & Validation Analytics Dashboard
                </h3>
                <div class="flex gap-2">
                    <button id="show-validation-monitor" class="bg-purple-600 hover:bg-purple-700 text-white text-sm px-3 py-1 rounded-md">
                        <i class="fas fa-microscope mr-1"></i> Validation Monitor
                    </button>
                </div>
                <button id="close-feedback-analytics-modal" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Feedback Overview -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h4 class="font-medium text-blue-800 mb-2 flex items-center">
                            <i class="fas fa-info-circle mr-1"></i> Feedback Overview
                        </h4>
                        <div class="text-sm">
                            <div class="flex justify-between mb-1">
                                <span>Total Feedback Collected:</span>
                                <span id="feedback-total-count" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Questions Improved:</span>
                                <span id="feedback-improved-count" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Positive Feedback Rate:</span>
                                <span id="feedback-positive-rate" class="font-semibold">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Feedback Trends Visualization -->
                    <div id="feedback-trends-visualization" class="bg-blue-50 p-4 rounded-lg border border-blue-100 mt-4">
                        <h4 class="font-medium text-blue-800 mb-2 flex items-center">
                            <i class="fas fa-chart-line mr-1"></i> Feedback Trends
                        </h4>
                        <p class="text-center text-gray-500 py-3">Not enough feedback data to visualize trends</p>
                    </div>
                    
                    <!-- Validation Metrics -->
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                        <h4 class="font-medium text-purple-800 mb-2 flex items-center">
                            <i class="fas fa-microscope mr-1"></i> Validation Status
                        </h4>
                        <div class="text-sm">
                            <div class="flex justify-between mb-1">
                                <span>Questions Validated:</span>
                                <span id="validation-total-count" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Average Accuracy:</span>
                                <span id="validation-avg-accuracy" class="font-semibold">0%</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>High Quality Questions:</span>
                                <span id="validation-high-quality" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Citations Found:</span>
                                <span id="validation-citations" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Improvement Metrics -->
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                        <h4 class="font-medium text-green-800 mb-2 flex items-center">
                            <i class="fas fa-chart-bar mr-1"></i> Improvement Metrics
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>Relevance:</span>
                                    <span id="metric-relevance" class="font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="metric-relevance-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>Accuracy:</span>
                                    <span id="metric-accuracy" class="font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="metric-accuracy-bar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>Difficulty Balance:</span>
                                    <span id="metric-difficulty" class="font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="metric-difficulty-bar" class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>Clarity:</span>
                                    <span id="metric-clarity" class="font-semibold">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="metric-clarity-bar" class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Question Type Performance -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-list-alt mr-1"></i> Question Type Performance
                    </h4>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div id="question-type-performance" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 text-sm">
                            <!-- Will be filled dynamically -->
                            <div class="flex justify-between items-center p-2 bg-white rounded border border-gray-100">
                                <span>Multiple Choice:</span>
                                <span class="font-semibold text-green-600">N/A</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded border border-gray-100">
                                <span>Short Answer:</span>
                                <span class="font-semibold text-green-600">N/A</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded border border-gray-100">
                                <span>Clinical Case:</span>
                                <span class="font-semibold text-green-600">N/A</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded border border-gray-100">
                                <span>Management:</span>
                                <span class="font-semibold text-green-600">N/A</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Parameter Recommendations -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-magic mr-1"></i> Parameter Recommendations
                    </h4>
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <div id="parameter-recommendations" class="text-sm">
                            <p class="mb-2"><span class="font-semibold">Difficulty:</span> <span id="recommended-difficulty">Loading...</span></p>
                            <p class="mb-2"><span class="font-semibold">Recommended Question Types:</span></p>
                            <div id="recommended-types" class="flex flex-wrap gap-2 mb-3">
                                <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs">Loading recommendations...</span>
                            </div>
                            <div id="improvement-tracking" class="mb-3 p-2 bg-white rounded border">
                                <div class="flex justify-between items-center text-xs">
                                    <span>Questions pending improvement:</span>
                                    <span id="pending-improvements-count" class="font-semibold text-orange-600">0</span>
                                </div>
                                <div class="flex justify-between items-center text-xs">
                                    <span>Questions already improved:</span>
                                    <span id="completed-improvements-count" class="font-semibold text-green-600">0</span>
                                </div>
                            </div>
                            <button id="apply-recommendations-btn" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition shadow-sm flex items-center justify-center">
                                <i class="fas fa-magic mr-2"></i> Apply These Recommendations
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Continuous Improvement Analytics -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-sync-alt mr-1"></i> Continuous Improvement Metrics
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <div class="text-xs text-blue-600 font-medium">Active Improvements</div>
                            <div class="text-lg font-bold text-blue-800" id="improvement-active-cycles">0</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                            <div class="text-xs text-green-600 font-medium">Success Rate</div>
                            <div class="text-lg font-bold text-green-800" id="improvement-success-rate">0%</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                            <div class="text-xs text-purple-600 font-medium">Average Improvement</div>
                            <div class="text-lg font-bold text-purple-800" id="improvement-average-gain">+0.0</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg border border-orange-200">
                            <div class="text-xs text-orange-600 font-medium">Queue Size</div>
                            <div class="text-lg font-bold text-orange-800" id="improvement-queue-size">0</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div class="text-xs text-gray-600 font-medium">Total Cycles</div>
                            <div class="text-lg font-bold text-gray-800" id="improvement-total-cycles">0</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200">
                            <div class="text-xs text-indigo-600 font-medium">Questions Tracked</div>
                            <div class="text-lg font-bold text-indigo-800" id="improvement-total-questions">0</div>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-500">
                        Last optimization: <span id="last-optimization">Never</span>
                    </div>
                </div>

                <!-- Parameter Optimization Insights -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-cogs mr-1"></i> Parameter Optimization Insights
                    </h4>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div id="optimization-insights" class="space-y-3">
                            <div class="text-gray-500 text-sm">Loading optimization insights...</div>
                        </div>
                        <button id="refresh-optimization-btn" class="mt-3 text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh Insights
                        </button>
                    </div>
                </div>

                <!-- Generation History -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-clipboard-list mr-1"></i> Generation History & Learning
                    </h4>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                            <div class="text-center">
                                <div class="font-semibold text-lg text-blue-600" id="total-sessions">0</div>
                                <div class="text-gray-600">Total Sessions</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-lg text-green-600" id="parameter-evolutions">0</div>
                                <div class="text-gray-600">Parameter Updates</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-lg text-purple-600" id="learning-accuracy">0%</div>
                                <div class="text-gray-600">Learning Accuracy</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-lg text-orange-600" id="improvement-rate">0%</div>
                                <div class="text-gray-600">Improvement Rate</div>
                            </div>
                        </div>
                        <div id="learning-insights" class="text-xs text-gray-600 space-y-1">
                            <p>• System is learning from your feedback to improve question generation</p>
                            <p>• Parameter refinements are automatically applied based on feedback patterns</p>
                            <p>• Click 'Validation Monitor' to see detailed performance metrics</p>
                        </div>
                    </div>
                </div>

                <!-- Feedback History -->
                <div>
                    <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-history mr-1"></i> Recent Feedback Activity
                    </h4>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 max-h-60 overflow-y-auto">
                        <div id="feedback-history" class="space-y-2 text-sm">
                            <!-- Will be filled dynamically -->
                            <p class="text-center text-gray-500">No feedback activity yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-5 border-t border-gray-200 flex justify-between items-center bg-gray-50">
                <div class="text-xs text-gray-500">
                    <p>Feedback data is stored locally on your device</p>
                </div>
                <button id="reset-feedback-data" class="text-red-600 hover:text-red-800 text-sm font-medium">
                    Reset Feedback Data
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Feedback Analytics Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced Feedback Analytics Modal Handler
            const viewFeedbackAnalyticsBtn = document.getElementById('view-feedback-analytics');
            const feedbackAnalyticsModal = document.getElementById('feedback-analytics-modal');
            const closeFeedbackAnalyticsModal = document.getElementById('close-feedback-analytics-modal');
            const feedbackAnalyticsBackdrop = document.getElementById('feedback-analytics-modal-backdrop');

            // Open analytics modal
            if (viewFeedbackAnalyticsBtn) {
                viewFeedbackAnalyticsBtn.addEventListener('click', function() {
                    openFeedbackAnalyticsModal();
                });
            }

            // Close modal handlers
            [closeFeedbackAnalyticsModal, feedbackAnalyticsBackdrop].forEach(element => {
                if (element) {
                    element.addEventListener('click', function() {
                        closeFeedbackAnalyticsModalHandler();
                    });
                }
            });

            // Open feedback analytics modal
            function openFeedbackAnalyticsModal() {
                if (feedbackAnalyticsModal) {
                    feedbackAnalyticsModal.classList.remove('hidden');
                    loadEnhancedFeedbackAnalytics();
                }
            }

            // Close feedback analytics modal
            function closeFeedbackAnalyticsModalHandler() {
                if (feedbackAnalyticsModal) {
                    feedbackAnalyticsModal.classList.add('hidden');
                }
            }

            // Load enhanced feedback analytics
            function loadEnhancedFeedbackAnalytics() {
                if (!window.getFeedbackAnalytics) {
                    log('Enhanced feedback system not available', 'warning');
                    return;
                }

                try {
                    const analytics = window.getFeedbackAnalytics();
                    const recommendations = window.getImprovementRecommendations ? window.getImprovementRecommendations() : [];
                    
                    // Update overview stats
                    updateOverviewStats(analytics);
                    
                    // Load optimization insights
                    loadOptimizationInsights();
                    
                    // Update validation metrics
                    updateValidationMetrics();
                    
                    // Update improvement metrics
                    updateImprovementMetrics(analytics);
                    
                    // Update recommendations
                    updateRecommendations(recommendations);
                    
                    // Update improvement tracking
                    updateImprovementTracking();
                    
                    // Update feedback history
                    updateFeedbackHistory();
                    
                    // Update generation history and learning metrics
                    updateGenerationHistory();
                    
                    // Update continuous improvement analytics
                    updateImprovementAnalytics();
                    
                    log('Enhanced feedback analytics loaded', 'success');
                    
                } catch (error) {
                    log(`Error loading enhanced feedback analytics: ${error.message}`, 'error');
                }
            }

            // Update overview statistics
            function updateOverviewStats(analytics) {
                try {
                    // Ensure analytics has the required structure
                    if (!analytics) {
                        analytics = { totalFeedback: 0, improved: 0, averageScores: {} };
                    }
                    if (!analytics.averageScores) {
                        analytics.averageScores = {};
                    }

                    const elements = {
                        'feedback-total-count': analytics.totalFeedback || 0,
                        'feedback-improved-count': analytics.improved || 0,
                        'feedback-positive-rate': (analytics.averageScores && analytics.averageScores.overall) ? 
                            Math.round(analytics.averageScores.overall * 100) + '%' : '0%'
                    };

                    if (elements && typeof elements === 'object') {
                        Object.entries(elements).forEach(([id, value]) => {
                            const element = document.getElementById(id);
                            if (element) element.textContent = value;
                        });
                    }
                } catch (error) {
                    console.warn('Error updating overview stats:', error);
                }
            }

            // Update enhanced validation metrics
            function updateValidationMetrics() {
                if (!window.validationSystem) {
                    log('Enhanced validation system not available', 'warning');
                    return;
                }

                try {
                    const validationAnalytics = window.validationSystem.getValidationAnalytics();
                    
                    if (validationAnalytics && validationAnalytics.metrics) {
                        const elements = {
                            'validation-total-count': validationAnalytics.metrics.totalValidations || 0,
                            'validation-avg-accuracy': Math.round(validationAnalytics.metrics.averageAccuracy) + '%',
                            'validation-high-quality': Math.round(validationAnalytics.metrics.successRate * 100) + '%',
                            'validation-citations': validationAnalytics.cacheSize || 0
                        };

                        if (elements && typeof elements === 'object') {
                            Object.entries(elements).forEach(([id, value]) => {
                                const element = document.getElementById(id);
                                if (element) element.textContent = value;
                            });
                        }
                        
                        // Update confidence indicator
                        const confidenceElement = document.getElementById('validation-confidence');
                        if (confidenceElement) {
                            confidenceElement.textContent = Math.round(validationAnalytics.metrics.averageConfidence) + '%';
                        }
                        
                        // Update user ratings count
                        const ratingsElement = document.getElementById('validation-user-ratings');
                        if (ratingsElement) {
                            ratingsElement.textContent = validationAnalytics.userRatingsCount || 0;
                        }
                        
                        log('Enhanced validation metrics updated', 'info');
                    }
                } catch (error) {
                    log(`Error updating validation metrics: ${error.message}`, 'error');
                }
            }

            // Update improvement metrics
            function updateImprovementMetrics(analytics) {
                try {
                    // Ensure analytics has the required structure
                    if (!analytics) {
                        analytics = { averageScores: {} };
                    }
                    if (!analytics.averageScores) {
                        analytics.averageScores = {};
                    }

                    const metrics = [
                        { id: 'metric-relevance', type: 'relevance' },
                        { id: 'metric-accuracy', type: 'quality' },
                        { id: 'metric-difficulty', type: 'difficulty' },
                        { id: 'metric-clarity', type: 'clarity' }
                    ];

                    metrics.forEach(metric => {
                        const value = (analytics.averageScores && analytics.averageScores[metric.type]) || 0;
                        const percentage = Math.round(value * 100); // Convert to percentage
                        
                        const element = document.getElementById(metric.id);
                        const barElement = document.getElementById(metric.id + '-bar');
                        
                        if (element) element.textContent = percentage + '%';
                        if (barElement) barElement.style.width = percentage + '%';
                    });
                } catch (error) {
                    console.warn('Error updating improvement metrics:', error);
                }
            }

            // Update recommendations
            function updateRecommendations(recommendations) {
                const difficultyElement = document.getElementById('recommended-difficulty');
                const typesElement = document.getElementById('recommended-types');
                
                if (recommendations && recommendations.length > 0) {
                    // Update difficulty recommendation
                    const difficultyRec = recommendations.find(r => r.type === 'difficulty');
                    if (difficultyElement) {
                        difficultyElement.textContent = difficultyRec ? 
                            difficultyRec.message : 'Current difficulty is optimal';
                    }
                    
                    // Update question types recommendations
                    if (typesElement) {
                        typesElement.innerHTML = '';
                        recommendations.forEach(rec => {
                            const chip = document.createElement('span');
                            chip.className = 'bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs';
                            chip.textContent = rec.message;
                            typesElement.appendChild(chip);
                        });
                    }
                } else {
                    if (difficultyElement) difficultyElement.textContent = 'No changes recommended';
                    if (typesElement) {
                        typesElement.innerHTML = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">All question types performing well</span>';
                    }
                }
            }

            // Update improvement tracking
            function updateImprovementTracking() {
                if (window.enhancedFeedbackSystem) {
                    const questionsForImprovement = window.enhancedFeedbackSystem.getQuestionsForImprovement();
                    const analytics = window.getFeedbackAnalytics();
                    
                    const pendingElement = document.getElementById('pending-improvements-count');
                    const completedElement = document.getElementById('completed-improvements-count');
                    
                    if (pendingElement) {
                        pendingElement.textContent = questionsForImprovement.length;
                    }
                    
                    if (completedElement) {
                        completedElement.textContent = analytics.improved || 0;
                    }
                }
            }

            // Update feedback history
            function updateFeedbackHistory() {
                const historyContainer = document.getElementById('feedback-history');
                if (!historyContainer || !window.enhancedFeedbackSystem) return;

                try {
                    const feedbackData = window.enhancedFeedbackSystem.feedbackData || {};
                    if (!feedbackData || typeof feedbackData !== 'object') {
                        historyContainer.innerHTML = '<p class="text-center text-gray-500">No feedback activity yet</p>';
                        return;
                    }

                    const recentFeedback = Object.values(feedbackData)
                        .filter(q => q && q.feedbacks && Array.isArray(q.feedbacks))
                        .flatMap(q => q.feedbacks.map(f => ({ ...f, questionId: q.id })))
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .slice(0, 10);
                } catch (error) {
                    console.warn('Error updating feedback history:', error);
                    if (historyContainer) {
                        historyContainer.innerHTML = '<p class="text-center text-gray-500">Error loading feedback history</p>';
                    }
                    return;
                }

                if (recentFeedback.length === 0) {
                    historyContainer.innerHTML = '<p class="text-center text-gray-500">No feedback activity yet</p>';
                    return;
                }

                historyContainer.innerHTML = recentFeedback.map(feedback => `
                    <div class="flex justify-between items-center p-2 bg-white rounded border border-gray-100">
                        <div class="flex items-center">
                            <i class="fas fa-comment text-gray-400 mr-2"></i>
                            <span class="text-sm">${feedback.type}: ${feedback.value}</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${new Date(feedback.timestamp).toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }

            // Apply recommendations button
            const applyRecommendationsBtn = document.getElementById('apply-recommendations-btn');
            if (applyRecommendationsBtn) {
                applyRecommendationsBtn.addEventListener('click', function() {
                    applyFeedbackRecommendations();
                });
            }

            // Apply feedback recommendations
            function applyFeedbackRecommendations() {
                if (!window.getImprovementRecommendations) {
                    alert('Recommendation system not available');
                    return;
                }

                const recommendations = window.getImprovementRecommendations();
                if (!recommendations || recommendations.length === 0) {
                    alert('No recommendations available at this time');
                    return;
                }

                // Apply to UI elements
                let appliedCount = 0;
                recommendations.forEach(rec => {
                    switch (rec.action) {
                        case 'adjust_difficulty':
                            const difficultySelect = document.getElementById('difficulty');
                            if (difficultySelect && rec.target) {
                                difficultySelect.value = rec.target;
                                log(`Applied difficulty recommendation: ${rec.target}`, 'info');
                                appliedCount++;
                            }
                            break;
                            
                        case 'reduce_type':
                            const typeCheckbox = document.getElementById(`type-${rec.target}`);
                            if (typeCheckbox) {
                                typeCheckbox.checked = false;
                                log(`Disabled problematic question type: ${rec.target}`, 'info');
                                appliedCount++;
                            }
                            break;
                    }
                });

                if (appliedCount > 0) {
                    alert(`${appliedCount} recommendations applied to generation settings!`);
                } else {
                    alert('No applicable recommendations found for current settings.');
                }
                closeFeedbackAnalyticsModalHandler();
            }

            // Validation monitor button
            const showValidationMonitorBtn = document.getElementById('show-validation-monitor');
            if (showValidationMonitorBtn) {
                showValidationMonitorBtn.addEventListener('click', function() {
                    if (window.showMonitoringDashboard) {
                        window.showMonitoringDashboard();
                    } else {
                        alert('Validation monitoring system not available');
                    }
                });
            }

            // Reset feedback data button
            const resetFeedbackBtn = document.getElementById('reset-feedback-data');
            if (resetFeedbackBtn) {
                resetFeedbackBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to reset all feedback data? This action cannot be undone.')) {
                        if (window.enhancedFeedbackSystem) {
                            window.enhancedFeedbackSystem.clearAllData();
                            alert('Feedback data has been reset');
                            closeFeedbackAnalyticsModalHandler();
                        }
                    }
                });
            }

            // Update generation history and learning metrics
            function updateGenerationHistory() {
                if (!window.enhancedFeedbackSystem) return;

                const system = window.enhancedFeedbackSystem;
                const analytics = window.getFeedbackAnalytics();
                
                // Update session and evolution counts
                const totalSessionsElement = document.getElementById('total-sessions');
                const parameterEvolutionsElement = document.getElementById('parameter-evolutions');
                const learningAccuracyElement = document.getElementById('learning-accuracy');
                const improvementRateElement = document.getElementById('improvement-rate');
                
                if (totalSessionsElement) {
                    totalSessionsElement.textContent = analytics.generationSessions || 0;
                }
                
                if (parameterEvolutionsElement) {
                    parameterEvolutionsElement.textContent = analytics.parameterEvolutions || 0;
                }
                
                // Calculate learning accuracy (percentage of questions with positive feedback)
                const learningAccuracy = analytics.totalQuestions > 0 ? 
                    Math.round((analytics.averageScore / 100) * 100) : 0;
                
                if (learningAccuracyElement) {
                    learningAccuracyElement.textContent = learningAccuracy + '%';
                }
                
                // Calculate improvement rate (questions improved vs total)
                const improvementRate = analytics.totalQuestions > 0 ? 
                    Math.round((analytics.improved / analytics.totalQuestions) * 100) : 0;
                
                if (improvementRateElement) {
                    improvementRateElement.textContent = improvementRate + '%';
                }
                
                // Update learning insights with dynamic content
                const learningInsightsElement = document.getElementById('learning-insights');
                if (learningInsightsElement && analytics.generationSessions > 0) {
                    const insights = [];
                    
                    if (analytics.parameterEvolutions > 0) {
                        insights.push(`• ${analytics.parameterEvolutions} parameter refinements applied based on feedback`);
                    } else {
                        insights.push('• System is collecting feedback to learn your preferences');
                    }
                    
                    if (analytics.totalFeedback > 10) {
                        insights.push(`• Learning from ${analytics.totalFeedback} feedback entries to optimize generation`);
                    } else {
                        insights.push('• Provide more feedback to enable intelligent parameter optimization');
                    }
                    
                    if (learningAccuracy > 75) {
                        insights.push('• High learning accuracy - system is well-tuned to your preferences');
                    } else if (learningAccuracy > 50) {
                        insights.push('• Moderate learning accuracy - continued feedback will improve performance');
                    } else {
                        insights.push('• Early learning phase - more feedback needed for optimization');
                    }
                    
                    learningInsightsElement.innerHTML = insights.join('<br>');
                }
            }

            // Update continuous improvement analytics
            function updateImprovementAnalytics() {
                if (!window.getImprovementAnalytics) return;

                try {
                    const analytics = window.getImprovementAnalytics();
                    
                    // Update improvement metrics
                    const improvementElements = {
                        'improvement-total-questions': analytics.totalQuestions || 0,
                        'improvement-active-cycles': analytics.activeImprovements || 0,
                        'improvement-success-rate': Math.round((analytics.successRate || 0) * 100) + '%',
                        'improvement-average-gain': '+' + (analytics.averageImprovement || 0).toFixed(2),
                        'improvement-queue-size': analytics.queuedImprovements || 0,
                        'improvement-total-cycles': analytics.totalImprovementCycles || 0
                    };

                    if (improvementElements && typeof improvementElements === 'object') {
                        Object.entries(improvementElements).forEach(([id, value]) => {
                            const element = document.getElementById(id);
                            if (element) element.textContent = value;
                        });
                    }
                    
                    // Update last optimization time
                    const lastOptElement = document.getElementById('last-optimization');
                    if (lastOptElement && analytics.lastOptimization) {
                        lastOptElement.textContent = new Date(analytics.lastOptimization).toLocaleString();
                    }
                    
                    log('Improvement analytics updated', 'info');
                } catch (error) {
                    log(`Error updating improvement analytics: ${error.message}`, 'error');
                }
            }

            log('Enhanced Feedback Analytics modal handlers initialized', 'success');
        });

        // Comprehensive Feedback Analytics Modal Handler (Alternative handler - DISABLED - duplicate)
        document.addEventListener('DOMContentLoaded', function() {
            // Using the main feedback analytics button (view-feedback-analytics) - no duplicate needed
            console.log('📊 Duplicate feedback analytics handler disabled - using main handler instead');
            return;
            /*
            // DISABLED DUPLICATE CODE
            const feedbackAnalyticsModal = document.getElementById('feedback-analytics-modal');
            const closeFeedbackAnalyticsModal = document.getElementById('close-feedback-analytics-modal');
            const feedbackAnalyticsBackdrop = document.getElementById('feedback-analytics-modal-backdrop');

            // Open modal
            if (feedbackAnalyticsBtn) {
                feedbackAnalyticsBtn.addEventListener('click', function() {
                    feedbackAnalyticsModal.classList.remove('hidden');
                    updateFeedbackAnalytics();
                });
            }

            // Close modal handlers
            function closeFeedbackAnalyticsModalHandler() {
                feedbackAnalyticsModal.classList.add('hidden');
            }

            if (closeFeedbackAnalyticsModal) {
                closeFeedbackAnalyticsModal.addEventListener('click', closeFeedbackAnalyticsModalHandler);
            }

            if (feedbackAnalyticsBackdrop) {
                feedbackAnalyticsBackdrop.addEventListener('click', closeFeedbackAnalyticsModalHandler);
            }

            // Update analytics data
            function updateFeedbackAnalytics() {
                try {
                    // Get data from both feedback systems with safe fallbacks
                    let enhancedAnalytics = {};
                    let loopAnalytics = {};
                    
                    try {
                        enhancedAnalytics = window.getEnhancedFeedbackAnalytics ? window.getEnhancedFeedbackAnalytics() : {};
                        enhancedAnalytics = enhancedAnalytics || {};
                    } catch (error) {
                        console.warn('Error getting enhanced analytics:', error);
                        enhancedAnalytics = {};
                    }
                    
                    try {
                        loopAnalytics = window.getFeedbackLoopAnalytics ? window.getFeedbackLoopAnalytics() : {};
                        loopAnalytics = loopAnalytics || {};
                    } catch (error) {
                        console.warn('Error getting loop analytics:', error);
                        loopAnalytics = {};
                    }

                // Get data from continuous improvement system if available
                const systemStats = window.continuousImprovementSystem ? window.continuousImprovementSystem.getSystemStats() : {};
                
                // Calculate metrics with fallbacks
                const totalFeedback = systemStats.feedbackCount || enhancedAnalytics.totalFeedback || 0;
                const totalOptimizations = systemStats.totalOptimizations || enhancedAnalytics.improvements || 0;
                const improvementCycles = systemStats.improvementCycles || loopAnalytics.improvementCycles || 0;
                
                // Calculate learning accuracy based on recent feedback trends
                let learningAccuracy = 0;
                if (window.continuousImprovementSystem) {
                    const feedbackLog = window.continuousImprovementSystem.getFeedbackLog();
                    const recentFeedback = feedbackLog.slice(-50); // Last 50 feedback entries
                    const positiveCount = recentFeedback.filter(f => ['good', 'yes', 'appropriate'].includes(f.value)).length;
                    learningAccuracy = recentFeedback.length > 0 ? Math.round((positiveCount / recentFeedback.length) * 100) : 0;
                } else {
                    learningAccuracy = loopAnalytics.learningAccuracy || 0;
                }
                
                // Update overview metrics
                document.getElementById('analytics-total-feedback').textContent = totalFeedback;
                document.getElementById('analytics-improvements').textContent = totalOptimizations;
                document.getElementById('analytics-learning-accuracy').textContent = learningAccuracy + '%';
                document.getElementById('analytics-optimization-cycles').textContent = improvementCycles;

                // Update feedback trends with data from improvement system if available
                let trendsData = enhancedAnalytics.trends || {};
                if (window.continuousImprovementSystem) {
                    const feedbackLog = window.continuousImprovementSystem.getFeedbackLog();
                    trendsData = {
                        quality: feedbackLog.filter(f => f.type === 'quality'),
                        relevance: feedbackLog.filter(f => f.type === 'relevance'),
                        difficulty: feedbackLog.filter(f => f.type === 'difficulty')
                    };
                }
                updateFeedbackTrends(trendsData);

                // Update session metrics
                updateSessionMetrics(enhancedAnalytics);

                console.log('📊 Feedback analytics updated');
                } catch (error) {
                    console.error('Error updating feedback analytics:', error);
                }
            }

            function updateFeedbackTrends(trends) {
                try {
                    // Ensure trends is an object
                    const safeTrends = trends && typeof trends === 'object' ? trends : {};
                    
                    // Quality feedback
                    const qualityTrend = Array.isArray(safeTrends.quality) ? safeTrends.quality : [];
                    const qualityGood = qualityTrend.filter(f => f && f.value === 'good').length;
                    const qualityPoor = qualityTrend.filter(f => f && f.value === 'poor').length;
                const qualityTotal = qualityGood + qualityPoor;

                document.getElementById('quality-good-count').textContent = qualityGood;
                document.getElementById('quality-poor-count').textContent = qualityPoor;
                
                if (qualityTotal > 0) {
                    const qualityPercent = (qualityGood / qualityTotal) * 100;
                    document.getElementById('quality-progress').style.width = qualityPercent + '%';
                }

                // Relevance feedback
                const relevanceTrend = Array.isArray(safeTrends.relevance) ? safeTrends.relevance : [];
                const relevanceYes = relevanceTrend.filter(f => f && f.value === 'yes').length;
                const relevanceNo = relevanceTrend.filter(f => f && f.value === 'no').length;
                const relevanceTotal = relevanceYes + relevanceNo;

                document.getElementById('relevance-yes-count').textContent = relevanceYes;
                document.getElementById('relevance-no-count').textContent = relevanceNo;
                
                if (relevanceTotal > 0) {
                    const relevancePercent = (relevanceYes / relevanceTotal) * 100;
                    document.getElementById('relevance-progress').style.width = relevancePercent + '%';
                }

                // Difficulty feedback
                const difficultyTrend = Array.isArray(safeTrends.difficulty) ? safeTrends.difficulty : [];
                const difficultyAppropriate = difficultyTrend.filter(f => f && f.value === 'appropriate').length;
                const difficultyHard = difficultyTrend.filter(f => f && f.value === 'too_hard').length;
                const difficultyEasy = difficultyTrend.filter(f => f && f.value === 'too_easy').length;
                const difficultyTotal = difficultyAppropriate + difficultyHard + difficultyEasy;

                document.getElementById('difficulty-appropriate-count').textContent = difficultyAppropriate;
                document.getElementById('difficulty-hard-count').textContent = difficultyHard;
                document.getElementById('difficulty-easy-count').textContent = difficultyEasy;
                
                if (difficultyTotal > 0) {
                    const difficultyPercent = (difficultyAppropriate / difficultyTotal) * 100;
                    document.getElementById('difficulty-progress').style.width = difficultyPercent + '%';
                }
                } catch (error) {
                    console.warn('Error updating feedback trends:', error);
                }
            }

            function updateSessionMetrics(analytics) {
                // Calculate session duration
                const sessionStart = window.enhancedFeedbackSystem?.sessionStartTime || Date.now();
                const sessionDuration = Math.floor((Date.now() - sessionStart) / 60000); // minutes
                document.getElementById('session-duration').textContent = sessionDuration + 'm';

                // Questions viewed
                const questionsViewed = document.querySelectorAll('.question-item').length;
                document.getElementById('questions-viewed').textContent = questionsViewed;

                // Feedback rate
                const feedbackRate = questionsViewed > 0 ? Math.round((analytics.totalFeedback / questionsViewed) * 100) : 0;
                document.getElementById('feedback-rate').textContent = feedbackRate + '%';

                // Average view time (placeholder - would need real tracking)
                document.getElementById('avg-view-time').textContent = '45s';
                document.getElementById('quick-reviews').textContent = Math.floor(questionsViewed * 0.3);
                document.getElementById('deep-studies').textContent = Math.floor(questionsViewed * 0.2);

                // System response metrics
                document.getElementById('auto-suggestions').textContent = analytics.improvements || 0;
                document.getElementById('applied-fixes').textContent = Math.floor((analytics.improvements || 0) * 0.8);
                document.getElementById('fix-success-rate').textContent = '85%';
            }

            // Action button handlers
            const refreshAnalyticsBtn = document.getElementById('refresh-analytics-btn');
            if (refreshAnalyticsBtn) {
                refreshAnalyticsBtn.addEventListener('click', function() {
                    updateFeedbackAnalytics();
                    
                    // Show refresh animation
                    const icon = this.querySelector('i');
                    icon.classList.add('fa-spin');
                    setTimeout(() => {
                        icon.classList.remove('fa-spin');
                    }, 1000);
                });
            }

            const exportAnalyticsBtn = document.getElementById('export-analytics-btn');
            if (exportAnalyticsBtn) {
                exportAnalyticsBtn.addEventListener('click', function() {
                    exportAnalyticsReport();
                });
            }

            const optimizeParametersBtn = document.getElementById('optimize-parameters-btn');
            if (optimizeParametersBtn) {
                optimizeParametersBtn.addEventListener('click', function() {
                    triggerOptimization();
                });
            }

            const resetAnalyticsDataBtn = document.getElementById('reset-analytics-data-btn');
            if (resetAnalyticsDataBtn) {
                resetAnalyticsDataBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to reset all feedback analytics data? This action cannot be undone.')) {
                        resetAnalyticsData();
                    }
                });
            }

            function exportAnalyticsReport() {
                const enhancedAnalytics = window.getEnhancedFeedbackAnalytics ? window.getEnhancedFeedbackAnalytics() : {};
                const loopAnalytics = window.getFeedbackLoopAnalytics ? window.getFeedbackLoopAnalytics() : {};

                const report = {
                    timestamp: new Date().toISOString(),
                    summary: {
                        totalFeedback: enhancedAnalytics.totalFeedback || 0,
                        improvements: enhancedAnalytics.improvements || 0,
                        learningAccuracy: loopAnalytics.learningAccuracy || 0,
                        optimizationCycles: loopAnalytics.improvementCycles || 0
                    },
                    trends: enhancedAnalytics.trends || {},
                    userPreferences: enhancedAnalytics.userPreferences || {},
                    engagement: {
                        questionsViewed: document.querySelectorAll('.question-item').length,
                        sessionDuration: Math.floor((Date.now() - (window.enhancedFeedbackSystem?.sessionStartTime || Date.now())) / 60000)
                    }
                };

                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedback-analytics-report-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log('📊 Analytics report exported');
            }

            function triggerOptimization() {
                if (window.feedbackLoopSystem) {
                    window.feedbackLoopSystem.runImprovementCycle();
                    
                    // Show optimization notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-purple-100 border-l-4 border-purple-500 p-4 rounded shadow-lg z-50';
                    notification.innerHTML = `
                        <div class="flex">
                            <i class="fas fa-magic text-purple-500 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-medium text-purple-800">Optimization Triggered</h4>
                                <p class="text-sm text-purple-700 mt-1">
                                    Running improvement cycle based on current feedback data...
                                </p>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                        updateFeedbackAnalytics(); // Refresh data after optimization
                    }, 3000);
                } else {
                    alert('Optimization system not available');
                }
            }

            function resetAnalyticsData() {
                if (window.clearEnhancedFeedbackData) {
                    window.clearEnhancedFeedbackData();
                }
                if (window.clearFeedbackLoopData) {
                    window.clearFeedbackLoopData();
                }
                
                updateFeedbackAnalytics();
                
                console.log('🗑️ Analytics data reset');
                alert('All feedback analytics data has been reset.');
            }

            console.log('📊 Feedback Analytics Dashboard initialized');
            */
        });

        // Improvement Status Helper Functions
        window.getImprovementStatusDisplay = function(questionId) {
            if (!window.enhancedFeedbackSystem) return { status: 'unknown' };
            
            const hasImprovement = window.enhancedFeedbackSystem.hasQuestionBeenImproved(questionId);
            const details = hasImprovement ? window.enhancedFeedbackSystem.getQuestionImprovementDetails(questionId) : null;
            
            if (hasImprovement && details) {
                return {
                    status: 'improved',
                    color: 'green',
                    icon: 'fa-check-circle',
                    display: 'Improved',
                    details: `Improved via ${details.improvementType} with ${Math.round(details.confidenceScore * 100)}% confidence`
                };
            }
            
            // Check if feedback loop is active for this type of question
            if (window.feedbackLoopSystem && window.feedbackLoopSystem.isQuestionTypeInQueue) {
                const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
                if (questionElement) {
                    const questionType = questionElement.getAttribute('data-type');
                    if (window.feedbackLoopSystem.isQuestionTypeInQueue(questionType)) {
                        return {
                            status: 'queued',
                            color: 'yellow',
                            icon: 'fa-hourglass-half',
                            display: 'Queued',
                            details: 'Question type is queued for improvement'
                        };
                    }
                }
            }
            
            return { status: 'unknown' };
        };

        window.getImprovementStatus = function(questionId) {
            if (!window.enhancedFeedbackSystem || !window.getQuestionImprovementDetails) {
                return { status: 'unknown' };
            }
            
            try {
                const hasImprovement = window.enhancedFeedbackSystem.hasQuestionBeenImproved(questionId);
                const details = hasImprovement ? window.getQuestionImprovementDetails(questionId) : null;
            
            if (hasImprovement && details) {
                return {
                    status: 'improved',
                    color: '#10b981',
                    icon: 'fas fa-arrow-up',
                    display: 'Improved via Feedback Loop',
                    lastImprovement: details.timestamp,
                    activeCycle: false,
                    queuePosition: -1,
                    confidence: details.confidenceScore,
                    improvementType: details.improvementType
                };
            }
            
            // Check for active improvement processes
            if (window.feedbackLoopSystem) {
                const loopStats = window.feedbackLoopSystem.getSystemStats();
                
                // Check if currently being improved
                if (loopStats && loopStats.currentlyImproving && loopStats.currentlyImproving.includes(questionId)) {
                    return {
                        status: 'improving',
                        color: '#3b82f6',
                        icon: 'fas fa-cog fa-spin',
                        display: 'Being Improved',
                        activeCycle: true,
                        queuePosition: -1
                    };
                }
                
                // Check queue position
                if (loopStats && loopStats.improvementQueue) {
                    const queuePosition = loopStats.improvementQueue.findIndex(item => 
                        item.questionId === questionId || item.type === 'question'
                    );
                    
                    if (queuePosition >= 0) {
                        return {
                            status: 'queued',
                            color: '#f59e0b',
                            icon: 'fas fa-hourglass-half',
                            display: 'Queued for Improvement',
                            activeCycle: false,
                            queuePosition: queuePosition
                        };
                    }
                }
            }
            
            return { status: 'unknown' };
            } catch (error) {
                console.warn('Error getting improvement status:', error);
                return { status: 'unknown' };
            }
        };

        // Enhanced feedback listeners for question elements
        window.addEnhancedFeedbackListeners = function(questionDiv, questionId, qa) {
            // Add question ID for tracking
            questionDiv.setAttribute('data-question-id', questionId);
            
            // Monitor for improvement status changes
            if (window.enhancedFeedbackSystem) {
                const checkForImprovements = () => {
                    const hasImprovement = window.enhancedFeedbackSystem.hasQuestionBeenImproved(questionId);
                    if (hasImprovement && !questionDiv.classList.contains('improved-question')) {
                        questionDiv.classList.add('improved-question');
                        
                        // Add improvement badge if not already present
                        const existingBadge = questionDiv.querySelector('.feedback-improvement-badge');
                        if (!existingBadge) {
                            try {
                                const improvementDetails = window.getQuestionImprovementDetails ? 
                                    window.getQuestionImprovementDetails(questionId) : null;
                                if (improvementDetails && window.enhancedFeedbackSystem.createImprovementBadge) {
                                    const badge = window.enhancedFeedbackSystem.createImprovementBadge(improvementDetails);
                                    questionDiv.insertBefore(badge, questionDiv.firstChild);
                                }
                            } catch (error) {
                                console.warn('Error creating improvement badge:', error);
                            }
                        }
                    }
                };
                
                // Check immediately and set up periodic checks
                checkForImprovements();
                setInterval(checkForImprovements, 5000); // Check every 5 seconds
            }
            
            // Add feedback button enhancement
            const feedbackButtons = questionDiv.querySelectorAll('.feedback-btn');
            feedbackButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Enhanced feedback processing is handled by the enhanced feedback system
                    console.log(`Feedback received for question ${questionId}: ${this.getAttribute('data-feedback')} = ${this.getAttribute('data-value')}`);
                    
                    // Trigger immediate improvement check for negative feedback
                    const feedbackType = this.getAttribute('data-feedback');
                    const feedbackValue = this.getAttribute('data-value');
                    
                    if ((feedbackType === 'quality' && feedbackValue === 'poor') || 
                        (feedbackType === 'relevance' && feedbackValue === 'no')) {
                        
                        setTimeout(() => {
                            checkForImprovements();
                        }, 2000); // Check for improvements after 2 seconds
                    }
                });
            });
        };

        // Update existing questions with improvement status on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const questionElements = document.querySelectorAll('.question-item[data-question-id]');
                questionElements.forEach(questionDiv => {
                    const questionId = questionDiv.getAttribute('data-question-id');
                    if (questionId && window.enhancedFeedbackSystem) {
                        window.addEnhancedFeedbackListeners(questionDiv, questionId, {});
                    }
                });
            }, 1000); // Wait for systems to initialize
        });

        // Demo function to test improvement marking (for development)
        window.demoQuestionImprovement = function() {
            const questionElements = document.querySelectorAll('.question-item[data-question-id]');
            if (questionElements.length > 0) {
                const randomQuestion = questionElements[Math.floor(Math.random() * questionElements.length)];
                const questionId = randomQuestion.getAttribute('data-question-id');
                
                // Mark as improved
                if (window.markQuestionAsImproved) {
                    window.markQuestionAsImproved(questionId, {
                        type: 'feedback_driven',
                        confidence: 0.85,
                        feedback: {
                            type: 'quality',
                            value: 'poor',
                            timestamp: Date.now() - 60000 // 1 minute ago
                        },
                        changes: [
                            'Improved question clarity',
                            'Enhanced answer explanation',
                            'Added clinical context'
                        ],
                        impact: 0.7
                    });
                    
                    console.log(`✅ Demo: Marked question ${questionId} as improved!`);
                    return questionId;
                }
            }
            return null;
        };

        // Add demo button to analytics modal for testing
        setTimeout(() => {
            const analyticsModal = document.getElementById('feedback-analytics-modal');
            if (analyticsModal) {
                const demoButton = document.createElement('button');
                demoButton.className = 'mt-2 bg-purple-500 text-white px-3 py-1 text-xs rounded hover:bg-purple-600';
                demoButton.innerHTML = '<i class="fas fa-flask mr-1"></i>Demo Improvement';
                demoButton.onclick = () => {
                    const improvedId = window.demoQuestionImprovement();
                    if (improvedId) {
                        alert(`Demo: Question ${improvedId} marked as improved! Look for the green improvement badge.`);
                    } else {
                        alert('No questions available for demo. Upload a document and extract questions first.');
                    }
                };
                
                const analyticsContent = analyticsModal.querySelector('.space-y-4');
                if (analyticsContent) {
                    analyticsContent.appendChild(demoButton);
                }
            }
        }, 2000);
    </script>

    <!-- Parameter Optimization Insights Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Optimization insights refresh button handler
            // Load optimization insights function first
            window.loadOptimizationInsights = function() {
                const insightsContainer = document.getElementById('optimization-insights');
                if (!insightsContainer) return;

                if (window.feedbackParameterOptimizer) {
                    try {
                        const insights = window.feedbackParameterOptimizer.getOptimizationInsights();
                        displayOptimizationInsights(insights, insightsContainer);
                    } catch (error) {
                        console.error('Error loading optimization insights:', error);
                        insightsContainer.innerHTML = '<div class="text-red-500 text-sm">Error loading optimization data</div>';
                    }
                } else {
                    insightsContainer.innerHTML = '<div class="text-gray-500 text-sm">Optimization system initializing...</div>';
                }

                // Also update history insights if available
                if (window.questionGenerationHistory) {
                    try {
                        const trends = window.questionGenerationHistory.getPerformanceTrends(30);
                        updateHistoryInsights(trends);
                    } catch (error) {
                        console.error('Error loading history insights:', error);
                    }
                }
            };

            function displayOptimizationInsights(insights, container) {
                if (!insights || insights.totalRules === 0) {
                    container.innerHTML = `
                        <div class="text-gray-500 text-sm">
                            <p class="mb-2">No optimization data available yet.</p>
                            <p class="text-xs">Generate questions and provide feedback to build optimization insights.</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-lg font-bold text-blue-600">${insights.totalRules}</div>
                            <div class="text-xs text-gray-600">Optimization Rules</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-600">${insights.highConfidenceRules}</div>
                            <div class="text-xs text-gray-600">High Confidence</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-purple-600">${insights.topPerformingCombinations.length}</div>
                            <div class="text-xs text-gray-600">Top Performers</div>
                        </div>
                    </div>
                `;

                if (insights.topPerformingCombinations.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h5 class="font-semibold text-gray-700 mb-2">Best Parameter Combinations:</h5>
                            <div class="space-y-2">
                    `;
                    
                    insights.topPerformingCombinations.slice(0, 3).forEach((combo, index) => {
                        const performancePercent = Math.round(combo.performance * 100);
                        const bgColor = index === 0 ? 'bg-green-100 border-green-200' : 'bg-gray-100 border-gray-200';
                        
                        html += `
                            <div class="p-2 rounded border ${bgColor} text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">${combo.parameters.difficulty} • ${combo.parameters.knowledgeArea}</span>
                                    <span class="text-green-600 font-bold">${performancePercent}%</span>
                                </div>
                                <div class="text-xs text-gray-600">
                                    ${combo.parameters.aiModel} • ${combo.samples} samples
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }

                if (insights.improvementOpportunities.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h5 class="font-semibold text-gray-700 mb-2">Improvement Opportunities:</h5>
                            <div class="space-y-2">
                    `;
                    
                    insights.improvementOpportunities.slice(0, 2).forEach(opp => {
                        html += `
                            <div class="p-2 rounded border border-orange-200 bg-orange-50 text-sm">
                                <div class="font-medium text-orange-800">${opp.parameters.difficulty} • ${opp.parameters.knowledgeArea}</div>
                                <div class="text-xs text-orange-600">
                                    ${opp.issues.join(', ')}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }

                container.innerHTML = html;
            }

            // Optimization insights refresh button handler (after function definition)
            const refreshOptimizationBtn = document.getElementById('refresh-optimization-btn');
            if (refreshOptimizationBtn) {
                refreshOptimizationBtn.addEventListener('click', loadOptimizationInsights);
            }

            // Load optimization insights initially if modal is open
            setTimeout(() => {
                if (document.getElementById('optimization-insights')) {
                    loadOptimizationInsights();
                }
            }, 2000); // Wait for systems to initialize

            function updateHistoryInsights(trends) {
                if (!trends) return;

                // Update generation history stats
                const totalSessionsEl = document.getElementById('total-sessions');
                const learningAccuracyEl = document.getElementById('learning-accuracy');
                const improvementRateEl = document.getElementById('improvement-rate');

                if (totalSessionsEl) totalSessionsEl.textContent = trends.totalSessions;
                if (learningAccuracyEl) {
                    const accuracy = Math.round(trends.feedbackSummary.likeRatio * 100);
                    learningAccuracyEl.textContent = `${accuracy}%`;
                }
                if (improvementRateEl) {
                    const improvement = trends.topPerformingParameters.length > 0 ? 
                        Math.round(trends.topPerformingParameters[0].averageScore * 100) : 0;
                    improvementRateEl.textContent = `${improvement}%`;
                }
            }
        });
    </script>

    <!-- USMLE Mode and Kanski File Toggle Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize USMLE Mode Toggle
            const usmleToggle = document.getElementById('usmle-mode');
            const kanakiToggle = document.getElementById('load-kanski');
            const kanakiStatus = document.getElementById('kanski-status');
            const kanakiStatusText = document.getElementById('kanski-status-text');

            // USMLE Mode Toggle Handler
            if (usmleToggle) {
                usmleToggle.addEventListener('change', function() {
                    const isEnabled = this.checked;
                    log(`USMLE Mode ${isEnabled ? 'enabled' : 'disabled'}`, 'info');
                    
                    if (isEnabled) {
                        // Update knowledge area to include all medical specialties
                        const knowledgeArea = document.getElementById('knowledge-area');
                        if (knowledgeArea && knowledgeArea.value === 'general') {
                            knowledgeArea.value = 'all';
                        }
                        
                        // Store USMLE mode in localStorage
                        localStorage.setItem('usmle-mode', 'true');
                        
                        // Show notification
                        showNotification('USMLE Mode enabled - Questions will include all medical & surgical information', 'success');
                    } else {
                        localStorage.setItem('usmle-mode', 'false');
                        showNotification('USMLE Mode disabled - Questions focused on ophthalmology only', 'info');
                    }
                    
                    // Update generation parameters
                    updateGenerationMode();
                });

                // Load saved USMLE mode state
                const savedUsmleMode = localStorage.getItem('usmle-mode');
                if (savedUsmleMode === 'true') {
                    usmleToggle.checked = true;
                    updateGenerationMode();
                }
            }

            // Kanski File Toggle Handler
            if (kanakiToggle) {
                kanakiToggle.addEventListener('change', function() {
                    const isEnabled = this.checked;
                    log(`Kanski file loading ${isEnabled ? 'enabled' : 'disabled'}`, 'info');
                    
                    if (isEnabled) {
                        // Show status indicator
                        kanakiStatus.classList.remove('hidden');
                        kanakiStatusText.textContent = 'Checking Kanski file...';
                        
                                                 // Check if file exists and prompt for upload if needed
                         checkKanskiFile().then(exists => {
                             if (exists) {
                                 kanakiStatusText.innerHTML = '<i class="fas fa-check-circle mr-1 text-green-500"></i>Kanski file found and ready to load';
                                 localStorage.setItem('load-kanski', 'true');
                                 showNotification('Kanski 1st edition will be included in question generation', 'success');
                             } else {
                                 kanakiStatusText.innerHTML = '<i class="fas fa-upload mr-1 text-blue-500"></i>Click to upload Kanski file';
                                 localStorage.setItem('load-kanski', 'true');
                                 showNotification('Ready to load Kanski file. Click "Show Image" on any question to upload.', 'info');
                             }
                         }).catch(error => {
                             kanakiStatusText.innerHTML = '<i class="fas fa-times-circle mr-1 text-red-500"></i>Error checking Kanski file';
                             this.checked = false;
                             log(`Error checking Kanski file: ${error.message}`, 'error');
                             showNotification('Error accessing Kanski file', 'error');
                         });
                    } else {
                        kanakiStatus.classList.add('hidden');
                        localStorage.setItem('load-kanski', 'false');
                        showNotification('Kanski file will not be included in generation', 'info');
                    }
                });

                // Load saved Kanski mode state
                const savedKanskiMode = localStorage.getItem('load-kanski');
                if (savedKanskiMode === 'true') {
                    kanakiToggle.checked = true;
                    kanakiToggle.dispatchEvent(new Event('change'));
                }
            }

                         // Function to check if Kanski file exists
             async function checkKanskiFile() {
                 const filePath = '/Users/mahmoudsami/Downloads/Kanski 1st edition.apkg';
                 
                 try {
                     log(`Checking for Kanski file at: ${filePath}`, 'info');
                     
                     // For web-based application, we can't directly access file system
                     // We'll return false to trigger the upload flow
                     await new Promise(resolve => setTimeout(resolve, 1000));
                     return false; // Always prompt for upload in web environment
                     
                 } catch (error) {
                     log(`Error checking Kanski file: ${error.message}`, 'error');
                     return false;
                 }
             }

            // Function to update generation mode based on toggles
            function updateGenerationMode() {
                const usmleMode = usmleToggle ? usmleToggle.checked : false;
                const kanskiMode = kanakiToggle ? kanakiToggle.checked : false;
                
                // Store current mode in window object for use in generation
                window.generationModes = {
                    usmleMode: usmleMode,
                    kanskiMode: kanskiMode
                };
                
                // Update visual indicators
                const usmleIndicator = document.getElementById('usmle-indicator');
                const kanskiIndicator = document.getElementById('kanski-indicator');
                
                if (usmleIndicator) {
                    if (usmleMode) {
                        usmleIndicator.classList.remove('hidden');
                    } else {
                        usmleIndicator.classList.add('hidden');
                    }
                }
                
                if (kanskiIndicator) {
                    if (kanskiMode) {
                        kanskiIndicator.classList.remove('hidden');
                    } else {
                        kanskiIndicator.classList.add('hidden');
                    }
                }
                
                log(`Generation modes updated - USMLE: ${usmleMode}, Kanski: ${kanskiMode}`, 'info');
            }

            // Function to show notifications
            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md transform transition-all duration-300 translate-x-full`;
                
                // Set notification style based on type
                switch (type) {
                    case 'success':
                        notification.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                        break;
                    case 'warning':
                        notification.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                        break;
                    case 'error':
                        notification.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                        break;
                    default:
                        notification.classList.add('bg-blue-100', 'border-blue-200', 'text-blue-800');
                }
                
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                // Add to document
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // Initialize generation modes
            updateGenerationMode();
        });
    </script>

    <!-- Kanski APKG Image Extraction and Show Image Functionality -->
    <script>
        // Global variables for Kanski image management
        let kanskiImages = new Map(); // Store extracted images
        let kanskiCards = new Map(); // Store card data
        let apkgProcessed = false;

        // Function to show image for a question
        window.showImageForQuestion = async function(questionId, questionText, buttonElement) {
            log(`Show image requested for question: ${questionId}`, 'info');
            
            // Check if Kanski mode is enabled
            const kanskiMode = window.generationModes?.kanskiMode || document.getElementById('load-kanski')?.checked;
            
            if (!kanskiMode) {
                showNotification('Kanski mode must be enabled to show images from the collection', 'warning');
                return;
            }

            // Update button to show loading state
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Finding Image...';
            buttonElement.disabled = true;

            try {
                // Process APKG file if not already done
                if (!apkgProcessed) {
                    await processKanskiApkgFile();
                }

                // Find relevant image using Gemini AI
                const imageData = await findRelevantImageWithGemini(questionText, questionId);
                
                if (imageData) {
                    // Display the image
                    displayImageInQuestion(questionId, imageData, buttonElement);
                } else {
                    showNotification('No relevant image found for this question', 'info');
                }
                
            } catch (error) {
                log(`Error showing image: ${error.message}`, 'error');
                showNotification('Error loading image. Please try again.', 'error');
            } finally {
                // Restore button
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
            }
        };

                 // Function to process Kanski APKG file
         async function processKanskiApkgFile() {
             const filePath = '/Users/mahmoudsami/Downloads/Kanski 1st edition.apkg';
             
             try {
                 log(`🎯 ENTRY POINT: processKanskiApkgFile called`, 'info');
                 log(`🎯 Current kanskiCards size: ${kanskiCards.size}`, 'info');
                 
                 // Try to read the actual APKG file if possible
                 log(`🎯 About to call tryReadActualApkgFile`, 'info');
                 const actualFileSuccess = await tryReadActualApkgFile(filePath);
                 log(`🎯 tryReadActualApkgFile result: ${actualFileSuccess}`, 'info');
                 
                 if (!actualFileSuccess) {
                     // DO NOT FALLBACK TO SIMULATION - USER EXPLICITLY REQUESTED NO SIMULATION
                     log(`❌ FAILED TO PROCESS REAL APKG FILE - NO FALLBACK TO SIMULATION`, 'error');
                     showNotification('Failed to process APKG file. Please ensure you have uploaded the correct Kanski 1st edition.apkg file.', 'error');
                     throw new Error('APKG file processing failed and simulation is disabled');
                 } else {
                     log(`🎯 REAL FILE PROCESSING SUCCEEDED`, 'success');
                 }
                 
                 apkgProcessed = true;
                 log(`🎯 FINAL RESULT: Processed ${kanskiCards.size} cards and ${kanskiImages.size} images from Kanski APKG`, 'success');
                 
             } catch (error) {
                 log(`🎯 ERROR in processKanskiApkgFile: ${error.message}`, 'error');
                 throw error;
             }
         }

         // Try to read actual APKG file (for Node.js or Electron environments)
         async function tryReadActualApkgFile(filePath) {
             try {
                 // Check if we're in an environment that supports file system access
                 if (typeof require !== 'undefined' || window.electronAPI) {
                     return await readActualApkgFile(filePath);
                 }
                 
                 // For web environment, try file input approach
                 return await requestApkgFileFromUser();
                 
             } catch (error) {
                 log(`Cannot read actual APKG file: ${error.message}`, 'warning');
                 return false;
             }
         }

         // Read actual APKG file (requires Node.js environment or Electron)
         async function readActualApkgFile(filePath) {
             try {
                 // For web environment, we can't directly access file system
                 // The user needs to upload the file
                 log('Direct file access not available in web environment, requesting file upload...', 'info');
                 return false;
             } catch (error) {
                 log(`Error reading APKG file: ${error.message}`, 'error');
                 return false;
             }
         }

         // Request APKG file from user via file input
         async function requestApkgFileFromUser() {
             log(`🔥 DIRECTLY REQUESTING APKG FILE FROM USER`, 'info');
             
             return new Promise((resolve) => {
                 // Create file input
                 const fileInput = document.createElement('input');
                 fileInput.type = 'file';
                 fileInput.accept = '.apkg';
                 fileInput.style.display = 'none';
                 
                 fileInput.onchange = async (e) => {
                     log(`🔥 FILE SELECTED BY USER`, 'info');
                     const file = e.target.files[0];
                     if (file && file.name.endsWith('.apkg')) {
                         log(`🔥 VALID APKG FILE: ${file.name}, calling processUploadedApkgFile`, 'info');
                         try {
                             log(`🔥 Starting processUploadedApkgFile for file: ${file.name} (${file.size} bytes)`, 'info');
                             await processUploadedApkgFile(file);
                             log(`🔥 processUploadedApkgFile completed successfully - ${kanskiCards.size} cards loaded`, 'success');
                             
                             // Verify we got the expected number of cards
                             if (kanskiCards.size < 100) {
                                 log(`⚠️ WARNING: Only ${kanskiCards.size} cards loaded, expected 1400+`, 'warning');
                                 showNotification(`Warning: Only ${kanskiCards.size} cards loaded from APKG file. Expected ~1417 cards.`, 'warning');
                             }
                             
                             resolve(true);
                         } catch (error) {
                             log(`🔥 CRITICAL ERROR in processUploadedApkgFile: ${error.message}`, 'error');
                             log(`🔥 Error stack: ${error.stack}`, 'error');
                             showNotification(`CRITICAL: APKG processing failed: ${error.message}`, 'error');
                             resolve(false);
                         }
                     } else {
                         log(`🔥 INVALID FILE SELECTED`, 'warning');
                         resolve(false);
                     }
                     document.body.removeChild(fileInput);
                 };
                 
                 fileInput.oncancel = () => {
                     log(`🔥 FILE SELECTION CANCELLED`, 'warning');
                     document.body.removeChild(fileInput);
                     resolve(false);
                 };
                 
                 document.body.appendChild(fileInput);
                 
                 // Show a notification asking user to select the file
                 showNotification('Please select the Kanski 1st edition.apkg file from your Downloads folder', 'info');
                 log(`🔥 FILE INPUT CREATED AND CLICKED`, 'info');
                 fileInput.click();
             });
         }

         // STEP-BY-STEP APKG PROCESSOR
         async function processUploadedApkgFile(file) {
             log(`🚀 STEP 1: Starting APKG Processing - ${file.name}`, 'info');
             log(`🧹 CLEARING MAPS: kanskiCards=${kanskiCards.size}, kanskiImages=${kanskiImages.size}`, 'info');
             
             // Clear previous data
             kanskiCards.clear();
             kanskiImages.clear();
             
             log(`✅ MAPS CLEARED: kanskiCards=${kanskiCards.size}, kanskiImages=${kanskiImages.size}`, 'info');
             
             try {
                 log(`📍 CHECKPOINT 1: About to call extractApkgFile`, 'info');
                 // STEP 1: Read and extract APKG file
                 const extractedData = await extractApkgFile(file);
                 log(`📍 CHECKPOINT 2: extractApkgFile completed, got ${extractedData.mediaFiles.size} media files`, 'info');
                 
                 // STEP 2: Parse Anki cards from database
                 log(`📍 CHECKPOINT 3: About to call parseAnkiCards`, 'info');
                 const parsedCards = await parseAnkiCards(extractedData.database);
                 log(`📍 CHECKPOINT 4: parseAnkiCards completed, got ${parsedCards.length} cards`, 'info');
                 
                 // STEP 3: Extract and process images
                 log(`📍 CHECKPOINT 5: About to call processImages`, 'info');
                 const processedImages = await processImages(extractedData.mediaFiles);
                 log(`📍 CHECKPOINT 6: processImages completed, got ${processedImages.size} images`, 'info');
                 
                 // STEP 4: Match cards with images
                 log(`📍 CHECKPOINT 7: About to call matchCardsWithImages`, 'info');
                 await matchCardsWithImages(parsedCards, processedImages);
                 log(`📍 CHECKPOINT 8: matchCardsWithImages completed`, 'info');
                 
                 // STEP 5: Finalize and report
                 log(`📍 CHECKPOINT 9: About to call finalizeProcessing`, 'info');
                 finalizeProcessing();
                 log(`📍 CHECKPOINT 10: All processing completed successfully!`, 'success');
                 
             } catch (error) {
                 log(`❌ CRITICAL ERROR in processUploadedApkgFile: ${error.message}`, 'error');
                 log(`❌ Error stack: ${error.stack}`, 'error');
                 
                 // Don't fall back to simulation - let's see the actual error
                 showNotification(`APKG processing failed: ${error.message}`, 'error');
                 throw error;
             }
         }
         
         // STEP 1: Extract APKG file contents
         async function extractApkgFile(file) {
             log(`📦 STEP 1A: Reading APKG file (${file.size} bytes)`, 'info');
             
             const arrayBuffer = await file.arrayBuffer();
             const zip = await JSZip.loadAsync(arrayBuffer);
             
             log(`📦 STEP 1B: Extracting collection.anki2 database`, 'info');
             const dbFile = zip.file('collection.anki2');
             if (!dbFile) {
                 throw new Error('collection.anki2 not found in APKG file');
             }
             
             const dbArrayBuffer = await dbFile.async('arraybuffer');
             
             log(`📦 STEP 1C: Initializing SQLite`, 'info');
             const SQL = await initSqlJs({
                 locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
             });
             
             const database = new SQL.Database(new Uint8Array(dbArrayBuffer));
             
             log(`📦 STEP 1D: Extracting media files`, 'info');
             const mediaFiles = new Map();
             
             for (const [filename, zipEntry] of Object.entries(zip.files)) {
                 if (!zipEntry.dir && filename.match(/\.(jpg|png|jpeg|gif|bmp|webp|svg|tiff)$/i)) {
                     try {
                         const imageData = await zipEntry.async('base64');
                         const extension = filename.split('.').pop().toLowerCase();
                         const mimeType = getMimeType(extension);
                         const dataUrl = `data:${mimeType};base64,${imageData}`;
                         
                         mediaFiles.set(filename, dataUrl);
                         mediaFiles.set(filename.split('/').pop(), dataUrl); // Also store basename
                         log(`📷 Extracted image: ${filename}`, 'info');
                     } catch (error) {
                         log(`⚠️ Failed to extract ${filename}: ${error.message}`, 'warning');
                     }
                 }
             }
             
             log(`✅ STEP 1 COMPLETE: Extracted ${mediaFiles.size} media files`, 'success');
             return { database, mediaFiles };
         }
         
         // STEP 2: Parse Anki cards using proper schema
         async function parseAnkiCards(database) {
             log(`🗃️ STEP 2A: Analyzing Anki database schema`, 'info');
             
             // Get table schemas
             let tables = [];
             try {
                 const tablesResult = database.exec("SELECT name FROM sqlite_master WHERE type='table'");
                 tables = tablesResult[0]?.values?.flat() || [];
                 log(`✅ Tables found: ${tables.join(', ')}`, 'info');
             } catch (error) {
                 log(`❌ Error getting tables: ${error.message}`, 'error');
                 throw error;
             }
             
             // Analyze notes table structure
             try {
                 const notesSchema = database.exec("PRAGMA table_info(notes)");
                 log(`✅ Notes table schema: ${JSON.stringify(notesSchema)}`, 'info');
             } catch (error) {
                 log(`❌ Error getting notes schema: ${error.message}`, 'error');
             }
             
             log(`🗃️ STEP 2B: Querying all notes from Anki database`, 'info');
             
             let notesQuery;
             let notes = [];
             
             // First let's verify we have the right table structure
             try {
                 const tablesDetail = database.exec("SELECT name, sql FROM sqlite_master WHERE type='table'");
                 log(`📋 Database tables detail: ${JSON.stringify(tablesDetail)}`, 'info');
                 
                 const noteCount = database.exec("SELECT COUNT(*) as count FROM notes");
                 log(`📊 Total notes count: ${JSON.stringify(noteCount)}`, 'info');
             } catch (error) {
                 log(`⚠️ Error analyzing database: ${error.message}`, 'warning');
             }
             
             // Try multiple query strategies
             try {
                 log(`🔍 Trying query: SELECT id, flds, tags, mid FROM notes`, 'info');
                 notesQuery = database.exec("SELECT id, flds, tags, mid FROM notes");
                 
                 if (!notesQuery || notesQuery.length === 0) {
                     throw new Error('Query returned no results');
                 }
                 
                 notes = notesQuery[0].values || [];
                 log(`✅ Primary query succeeded: ${notes.length} notes found`, 'success');
                 
             } catch (error) {
                 log(`❌ Primary query failed: ${error.message}`, 'error');
                 
                 // Try alternative query
                 try {
                     log(`🔍 Trying alternative query: SELECT * FROM notes`, 'info');
                     notesQuery = database.exec("SELECT * FROM notes");
                     
                     if (!notesQuery || notesQuery.length === 0) {
                         throw new Error('Alternative query returned no results');
                     }
                     
                     notes = notesQuery[0].values || [];
                     log(`✅ Alternative query succeeded: ${notes.length} notes found`, 'success');
                     
                 } catch (error2) {
                     log(`❌ All queries failed: ${error2.message}`, 'error');
                     throw new Error(`Cannot query notes table: ${error.message}, ${error2.message}`);
                 }
             }
             
             if (notes.length === 0) {
                 log(`❌ CRITICAL: No notes found in database!`, 'error');
                 throw new Error('No notes found in Anki database');
             }
             
             log(`📋 CONFIRMED: Found ${notes.length} notes in database (Expected: ~1417)`, 'success');
             
             if (notes.length < 100) {
                 log(`❌ CRITICAL: Only ${notes.length} notes found, expected 1417+`, 'error');
                 log(`❌ This indicates a serious problem with the APKG file or database parsing`, 'error');
                 throw new Error(`Insufficient notes in database: found ${notes.length}, expected 1417+`);
             }
             
             log(`🗃️ STEP 2C: Parsing each note into card format`, 'info');
             
             const parsedCards = [];
             let skippedCards = 0;
             let errorCount = 0;
             
             for (let i = 0; i < notes.length; i++) {
                 try {
                     const noteData = notes[i];
                     log(`🔍 Raw note ${i}: [${noteData.map(d => typeof d === 'string' ? `"${d.substring(0, 30)}..."` : d).join(', ')}]`, 'info');
                     
                     // Extract data based on query type
                     let noteId, fields, tags, modelId;
                     
                     if (noteData.length >= 4) {
                         [noteId, fields, tags, modelId] = noteData;
                     } else {
                         // Fallback for alternative query
                         noteId = noteData[0];
                         fields = noteData[1] || noteData[2] || '';
                         tags = noteData[3] || noteData[4] || '';
                         modelId = noteData[5] || 0;
                     }
                     
                     log(`📝 Note ${i + 1}/${notes.length}: ID=${noteId}, FieldsLen=${fields?.length || 0}, Tags="${tags}"`, 'info');
                     
                     if (!fields || typeof fields !== 'string' || fields.length === 0) {
                         log(`⚠️ Note ${noteId}: Empty/invalid fields, skipping`, 'warning');
                         skippedCards++;
                         continue;
                     }
                     
                     // Show first 200 chars of fields for debugging
                     log(`🔤 Note ${noteId} fields preview: "${fields.substring(0, 200)}..."`, 'info');
                     
                     // Anki stores fields separated by \x1f character
                     const fieldArray = fields.split('\x1f');
                     log(`📊 Note ${noteId}: Split into ${fieldArray.length} fields: [${fieldArray.map(f => `"${f.substring(0, 30)}..."`).join(', ')}]`, 'info');
                     
                     // Extract front and back (typically first two fields)
                     const rawFront = fieldArray[0] || '';
                     const rawBack = fieldArray[1] || fieldArray[0] || '';
                     
                     const front = stripHTML(rawFront).trim();
                     const back = stripHTML(rawBack).trim();
                     
                     // Extract images from the raw HTML fields
                     const imageRefs = extractImageReferences(fieldArray);
                     
                     log(`💡 Note ${noteId}: Front="${front.substring(0, 50)}...", Back="${back.substring(0, 50)}...", Images=[${imageRefs.join(', ')}]`, 'info');
                     
                     // ALWAYS CREATE A CARD - no skipping based on content length
                     const card = {
                         id: noteId,
                         front: front || `Note ${noteId}`,
                         back: back || 'No back content',
                         tags: tags ? tags.split(' ').filter(t => t.length > 0) : [],
                         imageRefs: imageRefs,
                         modelId: modelId
                     };
                     
                     parsedCards.push(card);
                     log(`✅ Note ${noteId}: Successfully parsed and added to collection`, 'success');
                     
                 } catch (error) {
                     log(`❌ Error processing note ${i}: ${error.message}`, 'error');
                     errorCount++;
                     
                     // Still create a minimal card to avoid losing data
                     const fallbackCard = {
                         id: i,
                         front: `Card ${i}`,
                         back: 'Error parsing content',
                         tags: [],
                         imageRefs: [],
                         modelId: 0
                     };
                     parsedCards.push(fallbackCard);
                 }
                 
                 // Progress every 10 cards during processing
                 if ((i + 1) % 10 === 0) {
                     log(`📊 Progress: ${i + 1}/${notes.length} notes processed, ${parsedCards.length} cards created`, 'info');
                 }
             }
             
             log(`🎯 PARSING COMPLETE:`, 'success');
             log(`   Total notes in DB: ${notes.length}`, 'success');
             log(`   Cards successfully parsed: ${parsedCards.length}`, 'success');
             log(`   Cards skipped: ${skippedCards}`, 'info');
             log(`   Errors encountered: ${errorCount}`, 'info');
             
             if (parsedCards.length === 0) {
                 throw new Error(`Failed to parse any cards from ${notes.length} database notes`);
             }
             
             if (parsedCards.length < notes.length * 0.5) {
                 log(`⚠️ WARNING: Only parsed ${parsedCards.length} out of ${notes.length} notes (less than 50%)`, 'warning');
             }
             
             log(`✅ STEP 2 COMPLETE: Successfully parsed ${parsedCards.length} valid cards`, 'success');
             return parsedCards;
         }
         
         // STEP 3: Process and catalog images
         async function processImages(mediaFiles) {
             log(`🖼️ STEP 3: Processing ${mediaFiles.size} extracted images`, 'info');
             
             const processedImages = new Map();
             
             for (const [filename, dataUrl] of mediaFiles) {
                 processedImages.set(filename, {
                     filename: filename,
                     data: dataUrl,
                     basename: filename.split('/').pop(),
                     extension: filename.split('.').pop().toLowerCase()
                 });
             }
             
             log(`✅ STEP 3 COMPLETE: Cataloged ${processedImages.size} images`, 'success');
             return processedImages;
         }
         
         // STEP 4: Match cards with their images
         async function matchCardsWithImages(parsedCards, processedImages) {
             log(`🔗 STEP 4: Matching ${parsedCards.length} cards with ${processedImages.size} images`, 'info');
             
             let cardsWithImages = 0;
             let cardsWithoutImages = 0;
             
             for (let i = 0; i < parsedCards.length; i++) {
                 const card = parsedCards[i];
                 let matchedImage = null;
                 
                 // Try to find exact image matches
                 for (const imageRef of card.imageRefs) {
                     if (processedImages.has(imageRef)) {
                         matchedImage = processedImages.get(imageRef);
                         log(`🎯 Card ${card.id}: Found exact image match: ${imageRef}`, 'success');
                         break;
                     }
                     
                     // Try basename match
                     const basename = imageRef.split('/').pop();
                     if (processedImages.has(basename)) {
                         matchedImage = processedImages.get(basename);
                         log(`🎯 Card ${card.id}: Found basename match: ${basename}`, 'success');
                         break;
                     }
                 }
                 
                 // If no exact match, assign cyclically for learning purposes
                 if (!matchedImage && processedImages.size > 0) {
                     const imageArray = Array.from(processedImages.values());
                     matchedImage = imageArray[i % imageArray.length];
                     log(`🔄 Card ${card.id}: Assigned cyclic image: ${matchedImage.filename}`, 'info');
                 }
                 
                 // Store the card
                 const finalCard = {
                     ...card,
                     media: matchedImage?.filename || null,
                     hasImage: !!matchedImage
                 };
                 
                 kanskiCards.set(card.id, finalCard);
                 
                 if (matchedImage) {
                     kanskiImages.set(matchedImage.filename, {
                         ...matchedImage,
                         cardId: card.id,
                         tags: card.tags
                     });
                     cardsWithImages++;
                 } else {
                     cardsWithoutImages++;
                 }
                 
                 if ((i + 1) % 100 === 0) {
                     log(`📊 Progress: ${i + 1}/${parsedCards.length} cards matched`, 'info');
                 }
             }
             
             log(`✅ STEP 4 COMPLETE: ${cardsWithImages} cards with images, ${cardsWithoutImages} without`, 'success');
         }
         
         // STEP 5: Finalize processing
         function finalizeProcessing() {
             log(`🎉 STEP 5: Finalizing processing`, 'info');
             
             const totalCards = kanskiCards.size;
             const totalImages = kanskiImages.size;
             
             log(`📊 FINAL RESULTS:`, 'success');
             log(`   Total cards processed: ${totalCards}`, 'success');
             log(`   Cards with images: ${totalImages}`, 'success');
             log(`   Cards without images: ${totalCards - totalImages}`, 'success');
             
             if (totalCards > 0) {
                 showNotification(`Successfully loaded ${totalCards} cards from Kanski collection (${totalImages} with images)`, 'success');
             } else {
                 showNotification('No cards could be processed from the APKG file', 'error');
             }
         }
         
         // Helper: Extract image references from Anki field data
         function extractImageReferences(fieldArray) {
             const imageRefs = [];
             
             for (const field of fieldArray) {
                 if (!field || typeof field !== 'string') continue;
                 
                 // Anki image patterns
                 const patterns = [
                     /<img[^>]+src=["']([^"']+)["'][^>]*>/gi,
                     /\[sound:([^]]+)\]/gi, // Sometimes images are in sound tags
                     /{{([^}]*\.(jpg|jpeg|png|gif|bmp|webp|svg)[^}]*)}}/gi,
                     /([a-zA-Z0-9_-]+\.(jpg|jpeg|png|gif|bmp|webp|svg))/gi
                 ];
                 
                 for (const pattern of patterns) {
                     let match;
                     while ((match = pattern.exec(field)) !== null) {
                         const imageRef = match[1] || match[0];
                         if (imageRef && imageRef.match(/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i)) {
                             imageRefs.push(imageRef.trim());
                         }
                     }
                 }
             }
             
                           return [...new Set(imageRefs)]; // Remove duplicates
          }

         // Helper function to get MIME type from extension
         function getMimeType(extension) {
             const mimeTypes = {
                 'jpg': 'image/jpeg',
                 'jpeg': 'image/jpeg',
                 'png': 'image/png',
                 'gif': 'image/gif',
                 'bmp': 'image/bmp',
                 'webp': 'image/webp',
                 'svg': 'image/svg+xml',
                 'tiff': 'image/tiff',
                 'tif': 'image/tiff'
             };
             return mimeTypes[extension.toLowerCase()] || 'image/jpeg';
         }

         // Extract image filenames from HTML content
         function extractImagesFromHTML(html) {
             const images = [];
             
             // Multiple regex patterns to catch different image formats
             const patterns = [
                 /<img[^>]+src=["']([^"']+)["'][^>]*>/gi,  // Standard img tags
                 /src=["']([^"']*\.(jpg|jpeg|png|gif|bmp|webp)[^"']*)["']/gi,  // Any src with image extension
                 /\[img\]([^[]+)\[\/img\]/gi,  // BBCode style
                 /!\[([^\]]*)\]\(([^)]+\.(jpg|jpeg|png|gif|bmp|webp))\)/gi,  // Markdown style
                 /([a-zA-Z0-9_-]+\.(jpg|jpeg|png|gif|bmp|webp))/gi,  // Just filename with extension
                 /<img[^>]*>([^<]*)<\/img>/gi  // Content between img tags
             ];
             
             for (const pattern of patterns) {
                 let match;
                 while ((match = pattern.exec(html)) !== null) {
                     // Get the image filename from different capture groups
                     let imageName = match[1] || match[2] || match[0];
                     
                     // Clean up the image name
                     imageName = imageName.replace(/^.*\//, ''); // Remove path
                     imageName = imageName.replace(/['"]/g, ''); // Remove quotes
                     imageName = imageName.trim();
                     
                     if (imageName && imageName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)) {
                         images.push(imageName);
                     }
                 }
             }
             
             // Remove duplicates
             return [...new Set(images)];
         }

         // Strip HTML tags from text
         function stripHTML(html) {
             const div = document.createElement('div');
             div.innerHTML = html;
             return div.textContent || div.innerText || '';
         }

         // Parse tags and extract medical keywords
         function parseTags(tags, front, back) {
             const allText = `${tags} ${front} ${back}`.toLowerCase();
             const medicalKeywords = extractMedicalKeywords(allText);
             
             // Add specific tags from the tags field
             const tagArray = tags.split(' ').filter(tag => tag.trim().length > 0);
             
             return [...new Set([...medicalKeywords, ...tagArray])];
         }

                 // Simulate APKG processing (in real implementation, this would read the actual file)
         async function simulateApkgProcessing() {
             // Simulate processing delay
             await new Promise(resolve => setTimeout(resolve, 2000));
             
             // Simulate extracted card data with common ophthalmology topics from Kanski
             const sampleCards = [
                 {
                     id: 1,
                     front: "Diabetic retinopathy - proliferative changes",
                     back: "Neovascularization, vitreous hemorrhage, traction retinal detachment",
                     media: "diabetic_retinopathy_prolif.jpg",
                     tags: ["diabetic retinopathy", "proliferative", "neovascularization", "vitreous hemorrhage"]
                 },
                 {
                     id: 2,
                     front: "Age-related macular degeneration - dry type",
                     back: "Drusen, RPE atrophy, geographic atrophy",
                     media: "amd_dry.jpg", 
                     tags: ["amd", "macular degeneration", "drusen", "dry", "geographic atrophy"]
                 },
                 {
                     id: 3,
                     front: "Glaucomatous optic disc changes",
                     back: "Cup-to-disc ratio >0.7, rim thinning, RNFL defects",
                     media: "glaucoma_disc.jpg",
                     tags: ["glaucoma", "optic disc", "cupping", "rim thinning", "rnfl"]
                 },
                 {
                     id: 4,
                     front: "Central retinal artery occlusion",
                     back: "Pale retina with cherry red spot at macula",
                     media: "crao.jpg",
                     tags: ["crao", "retinal artery", "occlusion", "cherry red spot", "pale retina"]
                 },
                 {
                     id: 5,
                     front: "Cataract - posterior subcapsular",
                     back: "Central opacity affecting near vision more than distance",
                     media: "psc_cataract.jpg",
                     tags: ["cataract", "posterior subcapsular", "psc", "lens opacity"]
                 },
                 {
                     id: 6,
                     front: "Retinal detachment - rhegmatogenous",
                     back: "Horseshoe tear with surrounding detachment",
                     media: "rheg_rd.jpg",
                     tags: ["retinal detachment", "rhegmatogenous", "horseshoe tear", "rd"]
                 },
                 {
                     id: 7,
                     front: "Corneal ulcer - bacterial",
                     back: "Central corneal defect with surrounding infiltrate and hypopyon",
                     media: "bacterial_ulcer.jpg",
                     tags: ["corneal ulcer", "bacterial", "keratitis", "hypopyon", "infiltrate"]
                 },
                 {
                     id: 8,
                     front: "Uveitis - anterior",
                     back: "Cells and flare in anterior chamber, keratic precipitates",
                     media: "anterior_uveitis.jpg",
                     tags: ["uveitis", "anterior", "cells", "flare", "keratic precipitates"]
                 }
             ];

             // Store the simulated data with placeholder images
             sampleCards.forEach(card => {
                 kanskiCards.set(card.id, card);
                 // Create a proper placeholder image with medical diagram
                 kanskiImages.set(card.media, {
                     filename: card.media,
                     data: createMedicalPlaceholderImage(card.front, card.back),
                     cardId: card.id,
                     tags: card.tags
                 });
             });
         }

         // Create a medical placeholder image for demo purposes
         function createMedicalPlaceholderImage(title, description) {
             // Create a canvas with medical-themed placeholder
             const canvas = document.createElement('canvas');
             canvas.width = 400;
             canvas.height = 300;
             const ctx = canvas.getContext('2d');
             
             // Background
             ctx.fillStyle = '#f8f9fa';
             ctx.fillRect(0, 0, 400, 300);
             
             // Border
             ctx.strokeStyle = '#2c6fa5';
             ctx.lineWidth = 2;
             ctx.strokeRect(5, 5, 390, 290);
             
             // Title
             ctx.fillStyle = '#2c6fa5';
             ctx.font = 'bold 16px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('Kanski Clinical Ophthalmology', 200, 30);
             
             // Medical eye symbol
             ctx.beginPath();
             ctx.ellipse(200, 120, 80, 40, 0, 0, 2 * Math.PI);
             ctx.strokeStyle = '#2c6fa5';
             ctx.lineWidth = 3;
             ctx.stroke();
             
             // Pupil
             ctx.beginPath();
             ctx.arc(200, 120, 20, 0, 2 * Math.PI);
             ctx.fillStyle = '#1a365d';
             ctx.fill();
             
             // Condition name
             ctx.fillStyle = '#495057';
             ctx.font = '14px Arial';
             ctx.textAlign = 'center';
             const words = title.split(' ');
             let y = 180;
             for (let i = 0; i < words.length; i += 3) {
                 const line = words.slice(i, i + 3).join(' ');
                 ctx.fillText(line, 200, y);
                 y += 20;
             }
             
             // Footer
             ctx.fillStyle = '#6c757d';
             ctx.font = '12px Arial';
             ctx.fillText('Click to view details', 200, 270);
             
             return canvas.toDataURL('image/png');
         }

                 // Function to find relevant image using Gemini AI
         async function findRelevantImageWithGemini(questionText, questionId) {
             try {
                 log(`Finding relevant image for question: "${questionText.substring(0, 100)}..."`, 'info');
                 log(`Available Kanski cards: ${kanskiCards.size}, Available images: ${kanskiImages.size}`, 'info');
                 
                 if (kanskiCards.size === 0 && kanskiImages.size === 0) {
                     log('No Kanski data available, using placeholder', 'warning');
                     return createPlaceholderImageData(questionText);
                 }
                 
                 // Strategy 1: Direct keyword matching with all available cards
                 const keywords = extractMedicalKeywords(questionText.toLowerCase());
                 log(`Extracted keywords: ${keywords.join(', ')}`, 'info');
                 
                 let bestMatch = null;
                 let maxScore = 0;
                 
                 // Check all cards, not just ones with images
                 for (const [cardId, card] of kanskiCards.entries()) {
                     let score = 0;
                     
                     // Score based on card content
                     const cardText = `${card.front} ${card.back}`.toLowerCase();
                     keywords.forEach(keyword => {
                         if (cardText.includes(keyword)) score += 2;
                     });
                     
                     // Score based on tags
                     if (card.tags && card.tags.length > 0) {
                         keywords.forEach(keyword => {
                             card.tags.forEach(tag => {
                                 if (tag.toLowerCase().includes(keyword) || keyword.includes(tag.toLowerCase())) {
                                     score += 1;
                                 }
                             });
                         });
                     }
                     
                     // Bonus for cards with images
                     if (card.hasImage && card.media) score += 0.5;
                     
                     if (score > maxScore) {
                         maxScore = score;
                         bestMatch = card;
                     }
                 }
                 
                 // If we found a good match
                 if (bestMatch && maxScore > 0) {
                     log(`Best matching card: ID=${bestMatch.id}, Score=${maxScore}, HasImage=${bestMatch.hasImage}`, 'success');
                     
                     if (bestMatch.hasImage && bestMatch.media && kanskiImages.has(bestMatch.media)) {
                         const imageData = kanskiImages.get(bestMatch.media);
                         return {
                             ...imageData,
                             card: bestMatch,
                             relevanceScore: maxScore,
                             description: bestMatch.back || bestMatch.front
                         };
                     } else {
                         // Card matches but no image - create a relevant placeholder
                         return createRelevantPlaceholder(bestMatch, questionText);
                     }
                 }
                 
                 // Strategy 2: Use any available image from Kanski collection
                 if (kanskiImages.size > 0) {
                     const imageArray = Array.from(kanskiImages.values());
                     const questionHash = questionText.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                     const selectedImage = imageArray[questionHash % imageArray.length];
                     const associatedCard = kanskiCards.get(selectedImage.cardId);
                     
                     log(`Using available image: ${selectedImage.filename}`, 'info');
                     return {
                         ...selectedImage,
                         card: associatedCard,
                         relevanceScore: 0.3,
                         description: associatedCard ? associatedCard.back : 'Kanski reference image'
                     };
                 }
                 
                 // Strategy 3: Create educational placeholder
                 log('No images available, creating educational placeholder', 'info');
                 return createPlaceholderImageData(questionText);
                 
             } catch (error) {
                 log(`Error in image search: ${error.message}`, 'error');
                 return createPlaceholderImageData(questionText);
             }
         }
         
         // Create a relevant placeholder for a matching card without image
         function createRelevantPlaceholder(card, questionText) {
             const canvas = document.createElement('canvas');
             canvas.width = 400;
             canvas.height = 300;
             const ctx = canvas.getContext('2d');
             
             // Draw background
             ctx.fillStyle = '#f8f9fa';
             ctx.fillRect(0, 0, 400, 300);
             
             // Draw border
             ctx.strokeStyle = '#dee2e6';
             ctx.lineWidth = 2;
             ctx.strokeRect(10, 10, 380, 280);
             
             // Draw title
             ctx.fillStyle = '#495057';
             ctx.font = 'bold 16px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('Kanski Reference Card', 200, 40);
             
             // Draw card content
             ctx.font = '14px Arial';
             ctx.fillStyle = '#6c757d';
             
             const frontText = card.front.substring(0, 150);
             const backText = card.back.substring(0, 150);
             
             // Word wrap function
             function wrapText(text, x, y, maxWidth, lineHeight) {
                 const words = text.split(' ');
                 let line = '';
                 let currentY = y;
                 
                 for (let n = 0; n < words.length; n++) {
                     const testLine = line + words[n] + ' ';
                     const metrics = ctx.measureText(testLine);
                     const testWidth = metrics.width;
                     
                     if (testWidth > maxWidth && n > 0) {
                         ctx.fillText(line, x, currentY);
                         line = words[n] + ' ';
                         currentY += lineHeight;
                     } else {
                         line = testLine;
                     }
                 }
                 ctx.fillText(line, x, currentY);
             }
             
             wrapText(frontText, 200, 80, 360, 20);
             wrapText(backText, 200, 160, 360, 20);
             
             // Draw footer
             ctx.font = '12px Arial';
             ctx.fillStyle = '#adb5bd';
             ctx.fillText('Medical illustration placeholder', 200, 270);
             
             return {
                 filename: `card_${card.id}_placeholder.png`,
                 data: canvas.toDataURL('image/png'),
                 cardId: card.id,
                 card: card,
                 relevanceScore: 0.8,
                 description: card.back || card.front,
                 isPlaceholder: true
             };
         }
         
         // Create a general placeholder image
         function createPlaceholderImageData(questionText) {
             const canvas = document.createElement('canvas');
             canvas.width = 400;
             canvas.height = 300;
             const ctx = canvas.getContext('2d');
             
             // Medical theme background
             const gradient = ctx.createLinearGradient(0, 0, 0, 300);
             gradient.addColorStop(0, '#e3f2fd');
             gradient.addColorStop(1, '#bbdefb');
             ctx.fillStyle = gradient;
             ctx.fillRect(0, 0, 400, 300);
             
             // Eye symbol
             ctx.fillStyle = '#1976d2';
             ctx.beginPath();
             ctx.ellipse(200, 150, 80, 40, 0, 0, 2 * Math.PI);
             ctx.fill();
             
             ctx.fillStyle = '#ffffff';
             ctx.beginPath();
             ctx.arc(200, 150, 25, 0, 2 * Math.PI);
             ctx.fill();
             
             ctx.fillStyle = '#000000';
             ctx.beginPath();
             ctx.arc(200, 150, 15, 0, 2 * Math.PI);
             ctx.fill();
             
             // Text
             ctx.fillStyle = '#1976d2';
             ctx.font = 'bold 18px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('Ophthalmology Reference', 200, 50);
             
             ctx.font = '14px Arial';
             ctx.fillStyle = '#424242';
             ctx.fillText('Educational placeholder', 200, 250);
             
             return {
                 filename: 'educational_placeholder.png',
                 data: canvas.toDataURL('image/png'),
                 cardId: null,
                 relevanceScore: 0.1,
                 description: 'Educational reference image',
                 isPlaceholder: true
             };
         }

         // Enhanced AI-powered image matching using Gemini
         async function findImageWithAI(questionText) {
             try {
                 // Check if we can use the existing Gemini API integration
                 const aiModel = document.getElementById('ai-model')?.value || 'gemini';
                 
                 if (aiModel === 'gemini' && window.callGeminiAPI) {
                     // Create a prompt for Gemini to analyze the question and suggest relevant images
                     const prompt = `
                         Analyze this ophthalmology question and determine the most relevant visual condition from Kanski's Clinical Ophthalmology:
                         
                         Question: "${questionText}"
                         
                         Available image categories in Kanski collection:
                         - Diabetic retinopathy (proliferative changes, neovascularization)
                         - Age-related macular degeneration (dry type, drusen)
                         - Glaucomatous optic disc changes (cupping, rim thinning)
                         - Central retinal artery occlusion (cherry red spot)
                         - Cataract (posterior subcapsular)
                         - Retinal detachment (rhegmatogenous, horseshoe tear)
                         - Corneal ulcer (bacterial, with hypopyon)
                         - Uveitis (anterior, with cells and flare)
                         
                         Respond with only the most relevant category name from the list above, or "none" if no match.
                     `;
                     
                     const response = await window.callGeminiAPI(prompt);
                     const category = response.toLowerCase();
                     
                     // Map AI response to our image database
                     const aiMatch = findImageByCategory(category);
                     if (aiMatch) {
                         log(`AI selected category: ${category}`, 'success');
                         return {
                             ...aiMatch,
                             relevanceScore: 0.85, // High confidence for AI match
                             aiSelected: true
                         };
                     }
                 }
                 
                 return null;
                 
             } catch (error) {
                 log(`AI image matching failed, falling back to keyword matching: ${error.message}`, 'warning');
                 return null;
             }
         }

         // Find image by AI-suggested category
         function findImageByCategory(category) {
             const categoryMappings = {
                 'diabetic retinopathy': 1,
                 'age-related macular degeneration': 2,
                 'glaucomatous optic disc changes': 3,
                 'central retinal artery occlusion': 4,
                 'cataract': 5,
                 'retinal detachment': 6,
                 'corneal ulcer': 7,
                 'uveitis': 8
             };
             
             for (const [key, cardId] of Object.entries(categoryMappings)) {
                 if (category.includes(key)) {
                     const card = kanskiCards.get(cardId);
                     const imageData = kanskiImages.get(card.media);
                     
                     return {
                         ...imageData,
                         card: card,
                         description: card.back
                     };
                 }
             }
             
             return null;
         }

        // Extract medical keywords from question text
        function extractMedicalKeywords(text) {
            const medicalTerms = [
                // Retinal conditions
                'diabetic retinopathy', 'proliferative', 'neovascularization', 'vitreous hemorrhage',
                'macular degeneration', 'amd', 'drusen', 'geographic atrophy',
                'retinal detachment', 'rhegmatogenous', 'horseshoe tear',
                'central retinal artery', 'crao', 'cherry red spot',
                
                // Glaucoma
                'glaucoma', 'optic disc', 'cupping', 'rim thinning', 'rnfl',
                
                // Cataracts
                'cataract', 'posterior subcapsular', 'psc', 'lens opacity',
                
                // Corneal conditions  
                'corneal ulcer', 'keratitis', 'bacterial', 'hypopyon', 'infiltrate',
                
                // Uveitis
                'uveitis', 'anterior', 'cells', 'flare', 'keratic precipitates',
                
                // General terms
                'retina', 'cornea', 'lens', 'optic nerve', 'macula', 'vitreous'
            ];
            
            const found = [];
            medicalTerms.forEach(term => {
                if (text.includes(term)) {
                    found.push(term);
                }
            });
            
            return found;
        }

        // Calculate relevance score between keywords and card tags
        function calculateRelevanceScore(keywords, cardTags) {
            if (keywords.length === 0 || cardTags.length === 0) return 0;
            
            let matches = 0;
            keywords.forEach(keyword => {
                cardTags.forEach(tag => {
                    if (keyword.includes(tag) || tag.includes(keyword)) {
                        matches++;
                    }
                });
            });
            
            return matches / (keywords.length + cardTags.length - matches); // Jaccard similarity
        }

        // Display image in the question
        function displayImageInQuestion(questionId, imageData, buttonElement) {
            // Find the question element
            const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
            if (!questionElement) {
                log('Question element not found', 'error');
                return;
            }

            // Remove any existing image
            const existingImage = questionElement.querySelector('.kanski-image-container');
            if (existingImage) {
                existingImage.remove();
            }

            // Create image container
            const imageContainer = document.createElement('div');
            imageContainer.className = 'kanski-image-container mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg';
            
            imageContainer.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-blue-800 flex items-center">
                        <i class="fas fa-image mr-2"></i>
                        Kanski 1st Edition - Related Image
                    </h4>
                    <div class="flex items-center gap-2">
                        <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full">
                            Relevance: ${Math.round(imageData.relevanceScore * 100)}%
                        </span>
                        <button onclick="this.closest('.kanski-image-container').remove()" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="image-display-area">
                    <div class="bg-white p-3 rounded border border-blue-200 mb-3">
                        <img src="${imageData.data.startsWith('data:') ? imageData.data : 'data:image/jpeg;base64,' + imageData.data}" 
                             alt="${imageData.card ? imageData.card.front : 'Medical image'}" 
                             class="max-w-full h-auto rounded cursor-pointer"
                             onclick="openImageModal(this.src, '${imageData.card ? imageData.card.front : 'Medical Image'}', '${imageData.description || 'Medical reference image'}')"
                             style="max-height: 300px; margin: 0 auto; display: block;"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NzM4RSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1lZGljYWwgSW1hZ2U8L3RleHQ+PC9zdmc+'">
                    </div>
                    
                    <div class="image-info text-sm">
                        <div class="font-medium text-gray-800 mb-1">${imageData.card ? imageData.card.front : 'Medical Image'}</div>
                        <div class="text-gray-600 mb-2">${imageData.description || 'Medical reference image'}</div>
                        <div class="flex flex-wrap gap-1">
                            ${imageData.card && imageData.card.tags ? imageData.card.tags.map(tag => 
                                `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded">${tag}</span>`
                            ).join('') : '<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded">medical</span>'}
                        </div>
                    </div>
                </div>
            `;

            // Insert after the question text
            const questionText = questionElement.querySelector('.question-text');
            questionText.insertAdjacentElement('afterend', imageContainer);

            // Update button text
            buttonElement.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Hide Image';
            buttonElement.onclick = () => {
                imageContainer.remove();
                buttonElement.innerHTML = '<i class="fas fa-image mr-1"></i>Show Image';
                buttonElement.onclick = () => window.showImageForQuestion(questionId, questionElement.querySelector('.question-text').textContent, buttonElement);
            };

            showNotification('Related image loaded from Kanski collection', 'success');
        }

        // Function to open image in modal for better viewing
        window.openImageModal = function(imageSrc, title, description) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl max-h-full overflow-auto">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">${title}</h3>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <img src="${imageSrc}" alt="${title}" class="max-w-full h-auto mb-4 rounded">
                        <p class="text-gray-700">${description}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        };

        // Initialize APKG processing when Kanski mode is enabled
        document.addEventListener('DOMContentLoaded', function() {
            // Monitor Kanski toggle changes
            const kanskiToggle = document.getElementById('load-kanski');
            if (kanskiToggle) {
                kanskiToggle.addEventListener('change', function() {
                    if (this.checked && !apkgProcessed) {
                        // Preprocess APKG file in background
                        processKanskiApkgFile().catch(error => {
                            log(`Background APKG processing failed: ${error.message}`, 'warning');
                        });
                    }
                });
            }
        });
    </script>

    <!-- Enhanced Feedback System Initialization & Error Prevention -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced system initialization with retry mechanism
            let initializationAttempts = 0;
            const maxAttempts = 30; // 6 seconds total
            
            function ensureSystemsReady() {
                initializationAttempts++;
                
                const systemsStatus = {
                    enhancedFeedback: !!window.enhancedFeedbackSystem,
                    getQuestionImprovementDetails: !!window.getQuestionImprovementDetails,
                    parameterOptimizer: !!window.feedbackParameterOptimizer,
                    generationHistory: !!window.questionGenerationHistory,
                    globalFunctions: !!(window.getImprovementStats && window.hasQuestionBeenImproved)
                };
                
                const readySystems = Object.values(systemsStatus).filter(Boolean).length;
                const totalSystems = Object.keys(systemsStatus).length;
                
                console.log(`🔄 System initialization check ${initializationAttempts}/${maxAttempts}: ${readySystems}/${totalSystems} systems ready`);
                
                if (readySystems === totalSystems) {
                    console.log('✅ All enhanced systems successfully initialized!');
                    return true;
                } else if (initializationAttempts < maxAttempts) {
                    setTimeout(ensureSystemsReady, 200);
                    return false;
                } else {
                    console.warn('⚠️ Some systems failed to initialize within timeout period');
                    console.warn('Systems status:', systemsStatus);
                    
                    // Set up fallback functions for missing systems
                    setupFallbackFunctions();
                    return false;
                }
            }
            
            function setupFallbackFunctions() {
                console.log('🛡️ Setting up fallback functions for missing systems...');
                
                // Enhanced feedback system fallbacks - only initialize once with multiple safeguards
                if (!window.enhancedFeedbackSystemInitialized && !window.enhancedFeedbackSystemInstance) {
                    window.enhancedFeedbackSystemInitialized = true;
                    
                    // Wait a bit for the class to load, then create instance or fallback
                    setTimeout(() => {
                        if (!window.enhancedFeedbackSystem && !window.enhancedFeedbackSystemInstance) {
                            // Check if class is available and not already instantiated
                            if (window.EnhancedFeedbackSystem && typeof window.EnhancedFeedbackSystem === 'function') {
                                try {
                                    // Prevent duplicate class declaration issues with multiple checks
                                    if (!window.enhancedFeedbackSystemInstance && !window.enhancedFeedbackSystem) {
                                        window.enhancedFeedbackSystemInstance = true;
                                        // Use try-catch to prevent duplicate variable errors
                                        try {
                                            window.enhancedFeedbackSystem = new window.EnhancedFeedbackSystem();
                                            console.log('✅ EnhancedFeedbackSystem instance created');
                                        } catch (duplicateError) {
                                            console.log('📝 EnhancedFeedbackSystem already exists, using existing instance');
                                            if (!window.enhancedFeedbackSystem) {
                                                createFallbackEnhancedFeedbackSystem();
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.warn('Failed to create EnhancedFeedbackSystem instance:', error);
                                    createFallbackEnhancedFeedbackSystem();
                                }
                            } else {
                                console.log('EnhancedFeedbackSystem class not found, using fallback');
                                createFallbackEnhancedFeedbackSystem();
                            }
                        }
                    }, 1000);
                }
                
                function createFallbackEnhancedFeedbackSystem() {
                    if (!window.enhancedFeedbackSystem && !window.enhancedFeedbackSystemInstance) {
                        window.enhancedFeedbackSystemInstance = true;
                        window.enhancedFeedbackSystem = {
                            hasQuestionBeenImproved: () => false,
                            getQuestionImprovementDetails: () => null,
                            createImprovementBadge: () => null,
                            getQuestionsForImprovement: () => [],
                            recordGenerationSession: () => {},
                            recordFeedback: () => {},
                            getImprovementStats: () => ({
                                totalImproved: 0,
                                improvementsByType: {},
                                recentImprovements: [],
                                averageConfidence: 0,
                                impactScore: 0
                            }),
                            getAnalytics: () => ({
                                totalFeedback: 0,
                                improved: 0,
                                averageScores: {
                                    overall: 0,
                                    quality: 0,
                                    relevance: 0,
                                    difficulty: 0,
                                    clarity: 0
                                },
                                trends: {
                                    quality: [],
                                    relevance: [],
                                    difficulty: []
                                },
                                userPreferences: {},
                                feedback: []
                            }),
                            clearAllData: () => {},
                            markQuestionAsImproved: () => {},
                            sessionStartTime: Date.now(),
                            feedbackData: {}
                        };
                        console.log('✅ Fallback EnhancedFeedbackSystem created');
                    }
                }
                
                // Global function fallbacks
                if (!window.getQuestionImprovementDetails) {
                    window.getQuestionImprovementDetails = () => null;
                }
                
                if (!window.hasQuestionBeenImproved) {
                    window.hasQuestionBeenImproved = () => false;
                }
                
                if (!window.getImprovementStats) {
                    window.getImprovementStats = () => ({
                        totalImproved: 0,
                        improvementsByType: {},
                        recentImprovements: [],
                        averageConfidence: 0,
                        impactScore: 0
                    });
                }
                
                if (!window.getFeedbackAnalytics) {
                    window.getFeedbackAnalytics = () => ({});
                }
                
                if (!window.getImprovementRecommendations) {
                    window.getImprovementRecommendations = () => [];
                }
                
                if (!window.markQuestionAsImproved) {
                    window.markQuestionAsImproved = () => {};
                }
                
                // Parameter optimizer fallbacks
                if (!window.feedbackParameterOptimizer) {
                    window.feedbackParameterOptimizer = {
                        getOptimizationInsights: () => ({
                            totalRules: 0,
                            highConfidenceRules: 0,
                            topPerformingCombinations: [],
                            improvementOpportunities: []
                        }),
                        validateAndCorrectQuestionTypes: (questions, types) => ({
                            questions: questions,
                            corrections: new Map()
                        }),
                        clearOptimizationData: () => {}
                    };
                }
                
                // Generation history fallbacks
                if (!window.questionGenerationHistory) {
                    window.questionGenerationHistory = {
                        getPerformanceTrends: () => null,
                        findSessionByQuestionId: () => null,
                        clearHistory: () => {}
                    };
                }
                
                console.log('✅ Fallback functions set up successfully');
            }
            
            // Test function to verify system functionality
            window.testEnhancedSystems = function() {
                console.log('🧪 Testing enhanced systems...');
                
                const tests = [
                    {
                        name: 'Enhanced Feedback System',
                        test: () => window.enhancedFeedbackSystem && typeof window.enhancedFeedbackSystem.hasQuestionBeenImproved === 'function'
                    },
                    {
                        name: 'Global Functions',
                        test: () => typeof window.getQuestionImprovementDetails === 'function'
                    },
                    {
                        name: 'Parameter Optimizer',
                        test: () => window.feedbackParameterOptimizer && typeof window.feedbackParameterOptimizer.getOptimizationInsights === 'function'
                    },
                    {
                        name: 'Generation History',
                        test: () => window.questionGenerationHistory && typeof window.questionGenerationHistory.getPerformanceTrends === 'function'
                    }
                ];
                
                tests.forEach(test => {
                    const result = test.test();
                    console.log(`${result ? '✅' : '❌'} ${test.name}: ${result ? 'PASS' : 'FAIL'}`);
                });
                
                return tests.every(test => test.test());
            };
            
            // Debug function to check current system state
            window.debugEnhancedSystems = function() {
                console.log('🔍 Enhanced Systems Debug Information:');
                console.log('enhancedFeedbackSystem:', window.enhancedFeedbackSystem);
                console.log('getQuestionImprovementDetails:', window.getQuestionImprovementDetails);
                console.log('feedbackParameterOptimizer:', window.feedbackParameterOptimizer);
                console.log('questionGenerationHistory:', window.questionGenerationHistory);
                
                if (window.enhancedFeedbackSystem) {
                    console.log('Enhanced Feedback System methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.enhancedFeedbackSystem)));
                }
            };
            
            // Start initialization
            console.log('🚀 Starting enhanced systems initialization...');
            ensureSystemsReady();
        });
        
        // Error monitoring and reporting
        window.addEventListener('error', function(event) {
            if (event.message && event.message.includes('enhancedFeedbackSystem')) {
                console.error('🚨 Enhanced Feedback System Error:', event.message);
                console.error('Stack:', event.error?.stack);
                
                // Try to recover by setting up fallbacks
                setTimeout(() => {
                    if (!window.getQuestionImprovementDetails) {
                        console.log('🛠️ Attempting error recovery...');
                        setupFallbackFunctions();
                    }
                }, 100);
            }
        });
        
        console.log('🎯 Enhanced feedback system error prevention loaded');
    </script>

    <!-- Account Settings Modal -->
    <div id="account-settings-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" id="account-settings-modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden z-10 relative mx-4">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                <h3 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-user-cog mr-3"></i>
                    Account Settings & Preferences
                </h3>
                <button id="close-account-settings-modal" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto max-h-[calc(90vh-4rem)]">
                <!-- Account Overview -->
                <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-user-circle text-blue-600 mr-2"></i>
                        Account Information
                    </h4>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-blue-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h5 class="font-medium text-gray-800 mb-3">Profile</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="Guest User" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Account Type</label>
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-800">
                                            <i class="fas fa-gift mr-1"></i> Free Account
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-800 mb-3">Usage Statistics</h5>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Questions Generated</span>
                                        <span class="font-semibold text-blue-600" id="stats-questions-generated">0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Sets Saved Offline</span>
                                        <span class="font-semibold text-purple-600" id="stats-sets-saved">0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Files Processed</span>
                                        <span class="font-semibold text-green-600" id="stats-files-processed">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Theme & Display Preferences -->
                <div class="p-6 border-b border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-palette text-purple-600 mr-2"></i>
                        Theme & Display
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200">
                            <h5 class="font-medium text-purple-800 mb-3">Theme Selection</h5>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="theme" value="light" class="mr-2" checked>
                                    <span class="text-sm">Light Theme</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="theme" value="dark" class="mr-2">
                                    <span class="text-sm">Dark Theme (Coming Soon)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="theme" value="auto" class="mr-2">
                                    <span class="text-sm">Auto (System)</span>
                                </label>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-lg border border-blue-200">
                            <h5 class="font-medium text-blue-800 mb-3">Display Options</h5>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="show-question-numbers" class="mr-2" checked>
                                    <span class="text-sm">Show question numbers</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="enable-animations" class="mr-2" checked>
                                    <span class="text-sm">Enable animations</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="compact-view" class="mr-2">
                                    <span class="text-sm">Compact view</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API & Export Settings -->
                <div class="p-6 border-b border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-key text-green-600 mr-2"></i>
                        API & Export Settings
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                            <h5 class="font-medium text-green-800 mb-3">Default Export Format</h5>
                            <select id="default-export-format" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="txt">Text (.txt)</option>
                                <option value="json">JSON (.json)</option>
                                <option value="docx">Word Document (.docx)</option>
                                <option value="pdf">PDF (.pdf)</option>
                            </select>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-4 rounded-lg border border-yellow-200">
                            <h5 class="font-medium text-yellow-800 mb-3">API Preferences</h5>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Default AI Model</label>
                                    <select id="default-ai-model" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                        <option value="gemini">Google Gemini</option>
                                        <option value="openai">OpenAI GPT-4o</option>
                                        <option value="claude">Anthropic Claude</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="p-6 border-b border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cogs text-indigo-600 mr-2"></i>
                        Advanced Settings
                    </h4>
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-gray-50 to-slate-50 p-4 rounded-lg border border-gray-200">
                            <h5 class="font-medium text-gray-800 mb-3">Performance & Storage</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="enable-local-storage" class="mr-2" checked>
                                    <span class="text-sm">Enable local storage</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cache-questions" class="mr-2" checked>
                                    <span class="text-sm">Cache generated questions</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="debug-mode" class="mr-2">
                                    <span class="text-sm">Enable debug mode</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="auto-save-preferences" class="mr-2" checked>
                                    <span class="text-sm">Auto-save preferences</span>
                                </label>
                            </div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <h5 class="font-medium text-red-800 mb-3">Data Management</h5>
                            <div class="space-y-2">
                                <button id="clear-cached-data" class="text-sm text-red-600 hover:text-red-800 underline">Clear all cached data</button>
                                <button id="reset-preferences" class="text-sm text-red-600 hover:text-red-800 underline">Reset all preferences</button>
                                <button id="export-user-data" class="text-sm text-red-600 hover:text-red-800 underline">Export my data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="p-6 bg-gray-50 flex justify-end space-x-3">
                    <button id="reset-account-settings" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md transition duration-200">
                        Reset to Defaults
                    </button>
                    <button id="save-account-settings" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition duration-200">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Settings Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Account Settings Dropdown Functionality
            const accountSettingsBtn = document.getElementById('account-settings-btn');
            const accountDropdown = document.getElementById('account-dropdown');
            const accountModal = document.getElementById('account-settings-modal');
            const closeAccountModal = document.getElementById('close-account-settings-modal');
            const accountModalBackdrop = document.getElementById('account-settings-modal-backdrop');

            // Toggle dropdown
            if (accountSettingsBtn && accountDropdown) {
                accountSettingsBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    accountDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!accountSettingsBtn.contains(e.target) && !accountDropdown.contains(e.target)) {
                        accountDropdown.classList.add('hidden');
                    }
                });

                // Handle dropdown option clicks
                accountDropdown.addEventListener('click', function(e) {
                    const option = e.target.closest('.account-option');
                    if (option) {
                        e.preventDefault();
                        accountDropdown.classList.add('hidden');
                        
                        const optionText = option.textContent.trim();
                        
                        // Handle different options
                        switch(optionText) {
                            case 'Theme Preferences':
                            case 'Export Settings':
                            case 'Usage History':
                            case 'API Key Management':
                            case 'Advanced Settings':
                            case 'Help & Support':
                                // Open account settings modal
                                if (accountModal) {
                                    accountModal.classList.remove('hidden');
                                    // Update modal title or focus on specific section
                                    console.log(`Opening account settings for: ${optionText}`);
                                }
                                break;
                            case 'Sign Out':
                                // Handle sign out
                                if (confirm('Are you sure you want to sign out?')) {
                                    // Reset user data and reload
                                    localStorage.clear();
                                    location.reload();
                                }
                                break;
                        }
                    }
                });
            }

            // Modal close functionality
            if (closeAccountModal && accountModal) {
                closeAccountModal.addEventListener('click', function() {
                    accountModal.classList.add('hidden');
                });
            }

            if (accountModalBackdrop && accountModal) {
                accountModalBackdrop.addEventListener('click', function() {
                    accountModal.classList.add('hidden');
                });
            }

            // Account Settings Form Handlers
            const saveSettingsBtn = document.getElementById('save-account-settings');
            const resetSettingsBtn = document.getElementById('reset-account-settings');

            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', function() {
                    // Save preferences to localStorage
                    const preferences = {
                        theme: document.querySelector('input[name="theme"]:checked')?.value || 'light',
                        showQuestionNumbers: document.getElementById('show-question-numbers')?.checked || true,
                        enableAnimations: document.getElementById('enable-animations')?.checked || true,
                        compactView: document.getElementById('compact-view')?.checked || false,
                        defaultExportFormat: document.getElementById('default-export-format')?.value || 'txt',
                        defaultAiModel: document.getElementById('default-ai-model')?.value || 'gemini',
                        enableLocalStorage: document.getElementById('enable-local-storage')?.checked || true,
                        cacheQuestions: document.getElementById('cache-questions')?.checked || true,
                        debugMode: document.getElementById('debug-mode')?.checked || false,
                        autoSavePreferences: document.getElementById('auto-save-preferences')?.checked || true
                    };
                    
                    localStorage.setItem('accountPreferences', JSON.stringify(preferences));
                    
                    // Apply theme if changed
                    applyTheme(preferences.theme);
                    
                    // Show success message
                    showNotification('Settings saved successfully!', 'success');
                    
                    // Close modal
                    accountModal.classList.add('hidden');
                });
            }

            if (resetSettingsBtn) {
                resetSettingsBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to reset all settings to defaults?')) {
                        localStorage.removeItem('accountPreferences');
                        loadAccountPreferences(); // Reload default preferences
                        showNotification('Settings reset to defaults', 'info');
                    }
                });
            }

            // Data management buttons
            document.getElementById('clear-cached-data')?.addEventListener('click', function() {
                if (confirm('This will clear all cached questions and data. Continue?')) {
                    // Clear specific cached data but keep preferences
                    const preferences = localStorage.getItem('accountPreferences');
                    localStorage.clear();
                    if (preferences) {
                        localStorage.setItem('accountPreferences', preferences);
                    }
                    showNotification('Cached data cleared', 'info');
                }
            });

            document.getElementById('reset-preferences')?.addEventListener('click', function() {
                if (confirm('This will reset all preferences to defaults. Continue?')) {
                    localStorage.removeItem('accountPreferences');
                    loadAccountPreferences();
                    showNotification('Preferences reset', 'info');
                }
            });

            document.getElementById('export-user-data')?.addEventListener('click', function() {
                exportUserData();
            });

            // Load saved preferences on page load
            loadAccountPreferences();
            updateUsageStats();
        });

        // Load account preferences
        function loadAccountPreferences() {
            const saved = localStorage.getItem('accountPreferences');
            if (saved) {
                try {
                    const preferences = JSON.parse(saved);
                    
                    // Apply theme
                    const themeRadio = document.querySelector(`input[name="theme"][value="${preferences.theme}"]`);
                    if (themeRadio) themeRadio.checked = true;
                    
                    // Apply other preferences
                    if (document.getElementById('show-question-numbers')) {
                        document.getElementById('show-question-numbers').checked = preferences.showQuestionNumbers !== false;
                    }
                    if (document.getElementById('enable-animations')) {
                        document.getElementById('enable-animations').checked = preferences.enableAnimations !== false;
                    }
                    if (document.getElementById('compact-view')) {
                        document.getElementById('compact-view').checked = preferences.compactView || false;
                    }
                    if (document.getElementById('default-export-format')) {
                        document.getElementById('default-export-format').value = preferences.defaultExportFormat || 'txt';
                    }
                    if (document.getElementById('default-ai-model')) {
                        document.getElementById('default-ai-model').value = preferences.defaultAiModel || 'gemini';
                    }
                    
                    // Apply theme
                    applyTheme(preferences.theme || 'light');
                    
                } catch (e) {
                    console.error('Error loading account preferences:', e);
                }
            }
        }

        // Apply theme
        function applyTheme(theme) {
            // Theme functionality to be implemented
            console.log(`Applying theme: ${theme}`);
        }

        // Update usage statistics
        function updateUsageStats() {
            // Get usage stats from localStorage or other sources
            const questionsGenerated = localStorage.getItem('questionsGeneratedCount') || '0';
            const setsSaved = Object.keys(localStorage).filter(key => key.startsWith('questionSet_')).length;
            const filesProcessed = localStorage.getItem('filesProcessedCount') || '0';
            
            if (document.getElementById('stats-questions-generated')) {
                document.getElementById('stats-questions-generated').textContent = questionsGenerated;
            }
            if (document.getElementById('stats-sets-saved')) {
                document.getElementById('stats-sets-saved').textContent = setsSaved;
            }
            if (document.getElementById('stats-files-processed')) {
                document.getElementById('stats-files-processed').textContent = filesProcessed;
            }
        }

        // Export user data
        function exportUserData() {
            const userData = {
                preferences: JSON.parse(localStorage.getItem('accountPreferences') || '{}'),
                questionSets: Object.keys(localStorage)
                    .filter(key => key.startsWith('questionSet_'))
                    .map(key => ({
                        key: key,
                        data: JSON.parse(localStorage.getItem(key) || '{}')
                    })),
                stats: {
                    questionsGenerated: localStorage.getItem('questionsGeneratedCount') || '0',
                    filesProcessed: localStorage.getItem('filesProcessedCount') || '0'
                },
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `frcs-simulator-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('User data exported successfully!', 'success');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>


</body>
</html>

