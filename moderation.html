<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderation Panel - Ophthalmic Infographic Creator</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëÅÔ∏è</text></svg>">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            overflow: auto;
            background: var(--bg-color);
        }

        .moderation-page {
            min-height: 100vh;
            padding: 2rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 1.5rem;
            transition: all 0.2s;
        }

        .back-link:hover {
            color: var(--primary-dark);
            transform: translateX(-4px);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .approve-all-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .approve-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .approve-all-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .approve-all-btn .material-symbols-rounded {
            font-size: 1.2rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .empty-moderation {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        .empty-moderation .material-symbols-rounded {
            font-size: 4rem;
            color: var(--text-tertiary);
            opacity: 0.5;
            margin-bottom: 1rem;
        }

        .empty-moderation p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
    </style>
</head>

<body>
    <div class="moderation-page">
        <a href="index.html" class="back-link">
            <span class="material-symbols-rounded">arrow_back</span>
            Back to Infographic Creator
        </a>

        <div class="moderation-container">
            <div id="config-panel" class="community-info-banner"
                style="display: none; background: #fff7ed; border: 1px solid #ffedd5; margin-bottom: 1.5rem; padding: 1.5rem; border-radius: 12px;">
                <div style="display: flex; gap: 1rem; align-items: start; margin-bottom: 1rem;">
                    <span class="material-symbols-rounded"
                        style="color: #f97316; font-size: 2rem;">settings_remote</span>
                    <div>
                        <h3 style="margin: 0 0 0.5rem 0; color: #9a3412;">Setup Remote Storage (GitHub Gist)</h3>
                        <p style="margin: 0; color: #7c2d12;">To synchronise submissions across devices, you need to
                            connect a GitHub Gist.</p>
                    </div>
                </div>

                <div style="display: grid; gap: 1rem; max-width: 600px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #7c2d12;">GitHub
                            Personal Access Token (PAT):</label>
                        <input type="password" id="gist-token-input" placeholder="github_pat_..."
                            style="width: 100%; padding: 0.75rem; border: 1px solid #fed7aa; border-radius: 8px;">
                        <small style="display: block; margin-top: 0.25rem; color: #9a3412;">Required permissions:
                            <code>gist</code> scope.</small>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #7c2d12;">Gist ID
                            (Optional - will create new if empty):</label>
                        <input type="text" id="gist-id-input" placeholder="e.g. 8f7d..."
                            style="width: 100%; padding: 0.75rem; border: 1px solid #fed7aa; border-radius: 8px;">
                    </div>
                    <button id="save-config-btn" onclick="saveGistConfig()"
                        style="background: #ea580c; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; justify-self: start;">
                        Save Configuration
                    </button>
                </div>
            </div>

            <div class="moderation-header">
                <h1>
                    <span class="material-symbols-rounded">admin_panel_settings</span>
                    Moderation Panel
                    <button id="refresh-btn" onclick="refreshSubmissions()"
                        style="margin-left: 1rem; padding: 0.5rem; border: none; background: transparent; cursor: pointer; vertical-align: middle;">
                        <span class="material-symbols-rounded" style="color: var(--primary-color);">refresh</span>
                    </button>
                </h1>
                <div class="admin-login">
                    <input type="password" id="admin-pin" placeholder="Admin PIN" maxlength="10">
                    <button id="verify-btn" class="btn-primary" style="padding: 0.6rem 1.25rem;">
                        <span class="material-symbols-rounded">lock_open</span>
                        Unlock
                    </button>
                    <div id="admin-status" class="admin-status locked">
                        <span class="material-symbols-rounded">lock</span>
                        Locked
                    </div>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="moderation-stats">
                <div class="stat-card pending">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">pending</span>
                    </div>
                    <div class="stat-info">
                        <h3>Pending Review</h3>
                        <span class="stat-number" id="pending-stat">0</span>
                    </div>
                </div>
                <div class="stat-card approved">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">verified</span>
                    </div>
                    <div class="stat-info">
                        <h3>Approved</h3>
                        <span class="stat-number" id="approved-stat">0</span>
                    </div>
                </div>
                <div class="stat-card total">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">analytics</span>
                    </div>
                    <div class="stat-info">
                        <h3>Total Submissions</h3>
                        <span class="stat-number" id="total-stat">0</span>
                    </div>
                </div>
            </div>

            <!-- Pending Submissions Section -->
            <div class="moderation-section">
                <div class="section-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">
                        <span class="material-symbols-rounded">pending_actions</span>
                        Pending Submissions
                    </h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="add-all-to-library-btn" class="approve-all-btn"
                            style="display: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);"
                            onclick="handleAddAllToLibrary()">
                            <span class="material-symbols-rounded">library_add</span>
                            Add All to Library
                        </button>
                        <button id="approve-all-btn" class="approve-all-btn" style="display: none;"
                            onclick="handleApproveAll()">
                            <span class="material-symbols-rounded">done_all</span>
                            Approve All
                        </button>
                        <button id="reject-all-btn" class="approve-all-btn" style="display: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);"
                            onclick="handleRejectAll()">
                            <span class="material-symbols-rounded">delete_sweep</span>
                            Reject All
                        </button>
                    </div>
                </div>
                <div id="pending-list">
                    <!-- Pending submissions will be rendered here -->
                </div>
                <div id="pending-empty" class="empty-moderation" style="display: none;">
                    <span class="material-symbols-rounded">inbox</span>
                    <p>No pending submissions to review.</p>
                </div>
            </div>

            <!-- Approved Submissions Section -->
            <div class="moderation-section">
                <h2>
                    <span class="material-symbols-rounded">verified</span>
                    Approved Submissions
                </h2>
                <div id="approved-list">
                    <!-- Approved submissions will be rendered here -->
                </div>
                <div id="approved-empty" class="empty-moderation" style="display: none;">
                    <span class="material-symbols-rounded">folder_off</span>
                    <p>No approved submissions yet.</p>
                </div>
            </div>

            <!-- GitHub URL Access Control Section -->
            <div class="moderation-section" id="github-access-section" style="display: none;">
                <h2>
                    <span class="material-symbols-rounded">manage_accounts</span>
                    GitHub URL Access Control
                </h2>
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                    <p style="margin: 0 0 1rem 0; color: #475569;">Manage usernames (UPN) allowed to access the GitHub repository URL. Add or block usernames below.</p>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="text" id="github-username-input" placeholder="Enter GitHub username / UPN..." 
                            style="flex: 1; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem;">
                        <button id="allow-user-btn" onclick="handleGitHubAccess('allow')"
                            style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;">
                            <span class="material-symbols-rounded" style="font-size: 1.1rem;">person_add</span>
                            Allow
                        </button>
                        <button id="block-user-btn" onclick="handleGitHubAccess('block')"
                            style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;">
                            <span class="material-symbols-rounded" style="font-size: 1.1rem;">person_remove</span>
                            Block
                        </button>
                    </div>

                    <div id="github-users-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Users will be rendered here -->
                    </div>
                    <div id="github-users-empty" style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <span class="material-symbols-rounded" style="font-size: 2rem;">group</span>
                        <p>No users configured yet. Add usernames above.</p>
                    </div>
                </div>
            </div>

            <!-- Scientific Accuracy Checker Section -->
            <div class="moderation-section" id="science-checker-section" style="display: none;">
                <h2>
                    <span class="material-symbols-rounded">science</span>
                    Scientific Accuracy Checker
                </h2>
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
                    <p style="margin: 0 0 1rem 0; color: #475569;">Check submitted infographics for scientific accuracy. Select a pending submission to analyse.</p>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <select id="science-check-select" style="flex: 1; min-width: 200px; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem;">
                            <option value="">Select submission to check...</option>
                        </select>
                        <button id="run-science-check-btn" onclick="runScienceCheck()"
                            style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem;">
                            <span class="material-symbols-rounded" style="font-size: 1.1rem;">biotech</span>
                            Run Accuracy Check
                        </button>
                    </div>

                    <div id="science-check-results" style="display: none; background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.25rem;">
                        <!-- Results will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span class="material-symbols-rounded" id="toast-icon">check_circle</span>
        <span id="toast-message">Action completed</span>
    </div>

    <script src="community-submissions.js"></script>
    <script>
        // DOM Elements
        const adminPinInput = document.getElementById('admin-pin');
        const verifyBtn = document.getElementById('verify-btn');
        const adminStatus = document.getElementById('admin-status');
        const pendingList = document.getElementById('pending-list');
        const approvedList = document.getElementById('approved-list');
        const pendingEmpty = document.getElementById('pending-empty');
        const approvedEmpty = document.getElementById('approved-empty');
        const pendingStat = document.getElementById('pending-stat');
        const approvedStat = document.getElementById('approved-stat');
        const totalStat = document.getElementById('total-stat');
        const loadingOverlay = document.getElementById('loading-overlay');
        const configWarning = document.getElementById('config-warning');
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');

        let isAdminVerified = false;
        let adminPIN = ''; // Store the verified PIN
        let currentSubmissions = { submissions: [], approved: [] };

        // Show loading overlay
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;

            if (type === 'success') {
                toastIcon.textContent = 'check_circle';
            } else if (type === 'error') {
                toastIcon.textContent = 'error';
            } else {
                toastIcon.textContent = 'info';
            }

            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Format date
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Verify admin PIN
        verifyBtn.addEventListener('click', () => {
            const pin = adminPinInput.value;
            if (CommunitySubmissions.verifyAdmin(pin)) {
                isAdminVerified = true;
                adminPIN = pin; // Store the verified PIN for later use
                adminStatus.innerHTML = '<span class="material-symbols-rounded">lock_open</span> Unlocked';
                adminStatus.className = 'admin-status unlocked';
                verifyBtn.style.display = 'none';
                adminPinInput.style.display = 'none';
                showToast('Admin access granted!', 'success');
                renderSubmissions();
            } else {
                showToast('Invalid PIN. Access denied.', 'error');
                adminPinInput.value = '';
            }
        });

        // Handle enter key on PIN input
        adminPinInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                verifyBtn.click();
            }
        });

        // Render submission card
        function renderSubmissionCard(submission, isApprovedSection = false) {
            const dateStr = formatDate(submission.submittedAt);
            const approvedStr = submission.approvedAt ? formatDate(submission.approvedAt) : '';

            return `
                <div class="admin-card" data-id="${submission.id}">
                    <div class="admin-card-content">
                        <h3 class="admin-card-title">${submission.title}</h3>
                        <p class="admin-card-summary">${submission.summary || 'No summary provided.'}</p>
                        <div class="admin-card-meta">
                            <span>
                                <span class="meta-label">Author:</span> ${submission.userName}
                            </span>
                            <span>
                                <span class="meta-label">Submitted:</span> ${dateStr}
                            </span>
                            <span>
                                <span class="meta-label">IP:</span> 
                                <code style="background: #f1f5f9; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.8rem;">
                                    ${submission.userIP || 'Unknown'}
                                </code>
                            </span>
                            <span>
                                <span class="meta-label">Likes:</span> ${submission.likes || 0}
                            </span>
                            ${approvedStr ? `
                            <span>
                                <span class="meta-label">Approved:</span> ${approvedStr}
                            </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="admin-card-actions">
                        ${!isApprovedSection && isAdminVerified ? `
                        <button class="community-btn approve-btn" onclick="handleApprove('${submission.id}')">
                            <span class="material-symbols-rounded">check_circle</span>
                            Approve
                        </button>
                        <button class="community-btn reject-btn" onclick="handleReject('${submission.id}')">
                            <span class="material-symbols-rounded">cancel</span>
                            Reject
                        </button>
                        ` : ''}
                        <button class="community-btn preview-btn" onclick="handlePreview('${submission.id}')">
                            <span class="material-symbols-rounded">visibility</span>
                            Preview
                        </button>
                    </div>
                </div>
            `;
        }

        // Render all submissions
        async function renderSubmissions() {
            showLoading();

            try {
                currentSubmissions = await CommunitySubmissions.getAll();

                const pending = currentSubmissions.submissions || [];
                const approved = currentSubmissions.approved || [];

                // Update stats
                pendingStat.textContent = pending.length;
                approvedStat.textContent = approved.length;
                totalStat.textContent = pending.length + approved.length;

                // Show/hide Approve All button (works for 1+ pending items)
                const approveAllBtn = document.getElementById('approve-all-btn');
                if (approveAllBtn) {
                    approveAllBtn.style.display = (isAdminVerified && pending.length >= 1) ? 'flex' : 'none';
                }

                // Show/hide Reject All button
                const rejectAllBtn = document.getElementById('reject-all-btn');
                if (rejectAllBtn) {
                    rejectAllBtn.style.display = (isAdminVerified && pending.length >= 1) ? 'flex' : 'none';
                }

                // Show/hide Add All to Library button
                const addAllToLibraryBtn = document.getElementById('add-all-to-library-btn');
                if (addAllToLibraryBtn) {
                    addAllToLibraryBtn.style.display = (pending.length > 0) ? 'flex' : 'none';
                }

                // Render pending
                if (pending.length > 0) {
                    pendingList.innerHTML = pending.map(s => renderSubmissionCard(s, false)).join('');
                    pendingEmpty.style.display = 'none';
                } else {
                    pendingList.innerHTML = '';
                    pendingEmpty.style.display = 'block';
                }

                // Render approved
                if (approved.length > 0) {
                    approvedList.innerHTML = approved.map(s => renderSubmissionCard(s, true)).join('');
                    approvedEmpty.style.display = 'none';
                } else {
                    approvedList.innerHTML = '';
                    approvedEmpty.style.display = 'block';
                }
                // Update science checker dropdown if admin
                if (isAdminVerified && typeof populateScienceCheckSelect === 'function') {
                    populateScienceCheckSelect();
                }
            } catch (err) {
                console.error('Error loading submissions:', err);
                showToast('Error loading submissions. Please refresh.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Handle approve
        window.handleApprove = async function (submissionId) {
            if (!isAdminVerified) {
                showToast('Please verify admin access first.', 'error');
                return;
            }

            if (!confirm('Approve this submission? It will become publicly visible in the gallery.')) {
                return;
            }

            showLoading();

            const result = await CommunitySubmissions.approve(submissionId, adminPIN);

            if (result.success) {
                showToast('Submission approved successfully!', 'success');
                await renderSubmissions();
            } else {
                showToast(result.message || 'Failed to approve.', 'error');
            }

            hideLoading();
        };

        // Handle reject - with enhanced protection for pending items
        window.handleReject = async function (submissionId) {
            if (!isAdminVerified) {
                showToast('‚ö†Ô∏è Admin verification required to delete pending items.', 'error');
                return;
            }

            // First confirmation
            if (!confirm('‚ö†Ô∏è PROTECTED ITEM ‚ö†Ô∏è\n\nThis is a pending review infographic that is protected from deletion.\n\nAre you SURE you want to permanently delete it?')) {
                return;
            }

            // Second confirmation for extra protection
            const confirmText = prompt('Type "DELETE" to confirm permanent removal:');
            if (confirmText !== 'DELETE') {
                showToast('Deletion cancelled. Item remains protected.', 'info');
                return;
            }

            showLoading();

            const result = await CommunitySubmissions.reject(submissionId, adminPIN);

            if (result.success) {
                showToast('Pending submission permanently deleted.', 'success');
                await renderSubmissions();
            } else {
                showToast(result.message || 'Failed to delete.', 'error');
            }

            hideLoading();
        };

        // Handle approve all pending submissions
        window.handleApproveAll = async function () {
            if (!isAdminVerified) {
                showToast('Please verify admin access first.', 'error');
                return;
            }

            const pending = currentSubmissions.submissions || [];
            if (pending.length === 0) {
                showToast('No pending submissions to approve.', 'info');
                return;
            }

            if (!confirm(`Approve all ${pending.length} pending submissions? They will become publicly visible.`)) {
                return;
            }

            showLoading();

            let successCount = 0;
            let failCount = 0;

            // Approve each submission
            for (const submission of pending) {
                try {
                    const result = await CommunitySubmissions.approve(submission.id, adminPIN);
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error('Failed to approve:', submission.id, result.message);
                    }
                } catch (err) {
                    failCount++;
                    console.error('Error approving:', submission.id, err);
                }
            }

            hideLoading();

            if (successCount > 0) {
                const msg = failCount > 0
                    ? `‚úÖ ${successCount} approved, ‚ùå ${failCount} failed.`
                    : `‚úÖ All ${successCount} submissions approved successfully!`;
                showToast(msg, successCount > 0 ? 'success' : 'error');
            } else {
                showToast('Failed to approve submissions.', 'error');
            }

            await renderSubmissions();
        };

        // Handle add all pending to local library (with replace option)
        window.handleAddAllToLibrary = async function () {
            const pending = currentSubmissions.submissions || [];
            if (pending.length === 0) {
                showToast('No pending submissions to add.', 'info');
                return;
            }

            const replaceExisting = confirm(
                `Add all ${pending.length} pending submissions to your local library?\n\n` +
                `Click OK to REPLACE any existing duplicates.\nClick Cancel to skip duplicates.`
            );

            if (!replaceExisting) {
                if (!confirm(`Add all ${pending.length} submissions, SKIPPING duplicates?`)) return;
            }

            showLoading();

            let addedCount = 0;
            let replacedCount = 0;
            let failCount = 0;

            for (const submission of pending) {
                try {
                    let result = await CommunitySubmissions.downloadToLibrary(submission.id, false);
                    if (result.success) {
                        addedCount++;
                    } else if (result.status === 'duplicate' && replaceExisting) {
                        result = await CommunitySubmissions.downloadToLibrary(submission.id, true);
                        if (result.success) {
                            replacedCount++;
                        } else {
                            failCount++;
                        }
                    } else {
                        failCount++;
                    }
                } catch (err) {
                    failCount++;
                    console.error('Error adding to library:', submission.id, err);
                }
            }

            hideLoading();

            const total = addedCount + replacedCount;
            if (total > 0) {
                let msg = `üìö ${addedCount} added`;
                if (replacedCount > 0) msg += `, ‚Üª ${replacedCount} replaced`;
                if (failCount > 0) msg += `, ‚ö†Ô∏è ${failCount} skipped`;
                showToast(msg, 'success');
            } else {
                showToast('No new items added. They may already be in your library.', 'info');
            }
        };

        // Handle reject all pending submissions
        window.handleRejectAll = async function () {
            if (!isAdminVerified) {
                showToast('Please verify admin access first.', 'error');
                return;
            }

            const pending = currentSubmissions.submissions || [];
            if (pending.length === 0) {
                showToast('No pending submissions to reject.', 'info');
                return;
            }

            if (!confirm(`‚ö†Ô∏è REJECT ALL ‚ö†Ô∏è\n\nAre you sure you want to permanently delete ALL ${pending.length} pending submissions?\n\nThis action cannot be undone.`)) {
                return;
            }

            const confirmText = prompt(`Type "REJECT ALL" to confirm permanent removal of all ${pending.length} pending submissions:`);
            if (confirmText !== 'REJECT ALL') {
                showToast('Rejection cancelled. All items remain protected.', 'info');
                return;
            }

            showLoading();

            let successCount = 0;
            let failCount = 0;

            // Reject each submission
            for (const submission of [...pending]) {
                try {
                    const result = await CommunitySubmissions.reject(submission.id, adminPIN);
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error('Failed to reject:', submission.id, result.message);
                    }
                } catch (err) {
                    failCount++;
                    console.error('Error rejecting:', submission.id, err);
                }
            }

            hideLoading();

            if (successCount > 0) {
                const msg = failCount > 0
                    ? `üóëÔ∏è ${successCount} rejected, ‚ùå ${failCount} failed.`
                    : `üóëÔ∏è All ${successCount} pending submissions rejected and removed!`;
                showToast(msg, successCount > 0 ? 'success' : 'error');
            } else {
                showToast('Failed to reject submissions.', 'error');
            }

            await renderSubmissions();
        };

        // Handle preview - renders full graphical infographic
        window.handlePreview = function (submissionId) {
            // Find the submission
            let submission = (currentSubmissions.submissions || []).find(s => s.id === submissionId);
            if (!submission) {
                submission = (currentSubmissions.approved || []).find(s => s.id === submissionId);
            }

            if (!submission || !submission.data) {
                showToast('Could not load preview data.', 'error');
                return;
            }

            const data = submission.data;

            // Build full graphical preview
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Preview: ${submission.title}</title>
                    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëÅÔ∏è</text></svg>">
                    <link rel="preconnect" href="https://fonts.googleapis.com">
                    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
                    <link rel="stylesheet" href="style.css">
                    <style>
                        html {
                            height: 100%;
                            overflow-y: scroll;
                        }
                        body {
                            padding: 2rem;
                            padding-top: 100px;
                            padding-bottom: 4rem;
                            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
                            min-height: 100%;
                            display: flex;
                            justify-content: center;
                            align-items: flex-start;
                            overflow-y: auto;
                        }
                        .preview-info {
                            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                            color: white;
                            padding: 1rem 2rem;
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            z-index: 100;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        }
                        .preview-info h2 {
                            margin: 0;
                            font-size: 1.1rem;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        }
                        .preview-info span {
                            font-size: 0.9rem;
                            opacity: 0.8;
                        }
                        #output-container {
                            width: 100%;
                            max-width: 900px;
                        }
                        .poster-sheet {
                            max-width: 900px;
                            width: 100%;
                        }
                        .preview-badge {
                            background: #f59e0b;
                            color: #1e293b;
                            padding: 0.25rem 0.75rem;
                            border-radius: 20px;
                            font-size: 0.75rem;
                            font-weight: 600;
                            text-transform: uppercase;
                        }
                        /* Scroll indicator */
                        .scroll-hint {
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            background: rgba(30, 41, 59, 0.9);
                            color: white;
                            padding: 0.5rem 1rem;
                            border-radius: 30px;
                            font-size: 0.85rem;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            animation: bounce 2s infinite;
                            cursor: pointer;
                            z-index: 99;
                        }
                        .scroll-hint:hover {
                            background: rgba(30, 41, 59, 1);
                        }
                        @keyframes bounce {
                            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                            40% { transform: translateY(-5px); }
                            60% { transform: translateY(-3px); }
                        }
                    </style>
                </head>
                <body>
                    <div class="preview-info">
                        <h2>
                            <span class="material-symbols-rounded">preview</span>
                            ${submission.title}
                            <span class="preview-badge">Preview</span>
                        </h2>
                        <span>By ${submission.userName} | ${formatDate(submission.submittedAt)}</span>
                    </div>
                    <div id="output-container" class="output-wrapper"></div>
                    <div class="scroll-hint" onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'}); this.style.display='none';">
                        <span class="material-symbols-rounded">keyboard_double_arrow_down</span>
                        Scroll to see more
                    </div>
                    <script>
                        const data = ${JSON.stringify(data)};
                        
                        function renderInfographic(data) {
                            const outputContainer = document.getElementById('output-container');
                            outputContainer.innerHTML = '';

                            const posterSheet = document.createElement('div');
                            posterSheet.className = 'poster-sheet';

                            // Header
                            const header = document.createElement('header');
                            header.className = 'poster-header';
                            
                            let illustrationHtml = '';
                            if (data.summary_illustration) {
                                illustrationHtml = '<div class="poster-illustration">' + data.summary_illustration + '</div>';
                            }

                            header.innerHTML = 
                                '<div class="header-decoration"></div>' +
                                '<h1 class="poster-title">' + data.title + '</h1>' +
                                '<div class="header-content-wrapper" style="display: flex; gap: 2rem; align-items: start;">' +
                                    '<p class="poster-summary" style="flex: 1;">' + data.summary + '</p>' +
                                    illustrationHtml +
                                '</div>';
                            posterSheet.appendChild(header);

                            // Grid
                            const grid = document.createElement('div');
                            grid.className = 'poster-grid';

                            if (data.sections && Array.isArray(data.sections)) {
                                data.sections.forEach((section, index) => {
                                    const card = document.createElement('div');
                                    const layoutClass = section.layout === 'full_width' ? 'col-span-2' : '';
                                    const colorClass = 'theme-' + (section.color_theme || 'blue');
                                    card.className = 'poster-card card-' + section.type + ' ' + layoutClass + ' ' + colorClass;
                                    card.style.animationDelay = (index * 100) + 'ms';

                                    const iconName = section.icon || 'circle';
                                    let contentHtml = '';

                                    switch (section.type) {
                                        case 'red_flag':
                                            const flags = Array.isArray(section.content) ? section.content : [section.content];
                                            contentHtml = '<ul class="warning-list">' +
                                                flags.map(item => '<li><span class="material-symbols-rounded warning-icon">warning</span>' + item + '</li>').join('') +
                                                '</ul>';
                                            break;

                                        case 'chart':
                                            const chartContent = section.content || {};
                                            const chartData = chartContent.data || [];
                                            contentHtml = '<div class="bar-chart">' +
                                                chartData.map(d => 
                                                    '<div class="chart-row">' +
                                                        '<div class="chart-label">' + d.label + '</div>' +
                                                        '<div class="chart-bar-container">' +
                                                            '<div class="chart-bar" style="width: ' + d.value + '%"></div>' +
                                                            '<span class="chart-val">' + d.value + '%</span>' +
                                                        '</div>' +
                                                    '</div>'
                                                ).join('') +
                                                '</div>';
                                            break;

                                        case 'remember':
                                            const mem = section.content || {};
                                            contentHtml = '<div class="mnemonic-box">' +
                                                '<div class="mnemonic-title">' + (mem.mnemonic || 'REMEMBER') + '</div>' +
                                                '<div class="mnemonic-text">' + mem.explanation + '</div>' +
                                                '</div>';
                                            break;

                                        case 'mindmap':
                                            const map = section.content || {};
                                            const branches = map.branches || [];
                                            contentHtml = '<div class="mindmap-container">' +
                                                '<div class="mindmap-center">' + map.center + '</div>' +
                                                '<div class="mindmap-branches">' +
                                                    branches.map(b => '<div class="mindmap-branch">' + b + '</div>').join('') +
                                                '</div>' +
                                                '</div>';
                                            break;

                                        case 'key_point':
                                        case 'process':
                                            const points = Array.isArray(section.content) ? section.content : [section.content];
                                            contentHtml = '<ul class="card-list">' +
                                                points.map(item => '<li>' + item + '</li>').join('') +
                                                '</ul>';
                                            break;

                                        case 'table':
                                            if (section.content && section.content.headers && section.content.rows) {
                                                const headers = section.content.headers || [];
                                                const rows = section.content.rows || [];
                                                contentHtml = '<div class="table-wrapper"><table class="data-table">' +
                                                    '<thead><tr>' + headers.map(h => '<th>' + h + '</th>').join('') + '</tr></thead>' +
                                                    '<tbody>' + rows.map(row => '<tr>' + row.map(cell => '<td>' + cell + '</td>').join('') + '</tr>').join('') + '</tbody>' +
                                                    '</table></div>';
                                            } else {
                                                contentHtml = '<p class="plain-text">Invalid table data.</p>';
                                            }
                                            break;

                                        default:
                                            contentHtml = '<p class="plain-text">' + section.content + '</p>';
                                    }

                                    card.innerHTML = 
                                        '<h3 class="card-title">' +
                                            '<div class="icon-box"><span class="material-symbols-rounded">' + iconName + '</span></div>' +
                                            section.title +
                                        '</h3>' +
                                        '<div class="card-content">' + contentHtml + '</div>' +
                                        '<div class="card-deco"></div>';
                                    
                                    grid.appendChild(card);
                                });
                            }

                            posterSheet.appendChild(grid);
                            outputContainer.appendChild(posterSheet);
                        }
                        
                        renderInfographic(data);
                        
                        // Hide scroll hint when user scrolls or if content is short
                        const scrollHint = document.querySelector('.scroll-hint');
                        window.addEventListener('scroll', function() {
                            if (scrollHint) scrollHint.style.display = 'none';
                        });
                        // Hide if content fits in viewport
                        setTimeout(function() {
                            if (document.body.scrollHeight <= window.innerHeight + 100) {
                                if (scrollHint) scrollHint.style.display = 'none';
                            }
                        }, 500);
                    <\/script>
                </body>
                </html>
            `);
            previewWindow.document.close();
        };

        // Refresh function - clears cache and reloads
        window.refreshSubmissions = async function () {
            // Clear cache to force fresh data
            localStorage.removeItem('ophthalmic_community_cache');
            showToast('Refreshing submissions...', 'info');
            await renderSubmissions();
        };

        // Initial load - clear cache to ensure fresh data
        localStorage.removeItem('ophthalmic_community_cache');

        // Check configuration status
        const configPanel = document.getElementById('config-panel');
        const tokenInput = document.getElementById('gist-token-input');
        const idInput = document.getElementById('gist-id-input');

        // Pre-fill if exists
        if (localStorage.getItem('gist_token')) tokenInput.value = localStorage.getItem('gist_token');
        if (localStorage.getItem('gist_id')) idInput.value = localStorage.getItem('gist_id');

        if (!CommunitySubmissions.isConfigured()) {
            configPanel.style.display = 'block';
        } else {
            // Show a small "Configured" indicator or hide panel
            configPanel.style.display = 'none';
            // Maybe add a "Reconfigure" button somewhere, but for now just hide it if working
        }

        window.saveGistConfig = async function () {
            const token = tokenInput.value.trim();
            const id = idInput.value.trim();

            if (!token) {
                showToast('Token is required.', 'error');
                return;
            }

            showLoading();

            try {
                // If ID is missing, try to create one?
                // For now, simple save.
                if (window.CommunitySubmissions.configure) {
                    window.CommunitySubmissions.configure(id || 'YOUR_GIST_ID_HERE', token);
                } else {
                    // Manual fallback
                    localStorage.setItem('gist_token', token);
                    if (id) localStorage.setItem('gist_id', id);
                }

                showToast('Configuration saved! Reloading...', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } catch (err) {
                showToast('Error saving config.', 'error');
            } finally {
                hideLoading();
            }
        };

        // =============== GitHub URL Access Control ===============
        const GITHUB_ACCESS_KEY = 'ophthalmic_github_access_users';

        function getGitHubAccessUsers() {
            try {
                return JSON.parse(localStorage.getItem(GITHUB_ACCESS_KEY) || '[]');
            } catch { return []; }
        }

        function saveGitHubAccessUsers(users) {
            localStorage.setItem(GITHUB_ACCESS_KEY, JSON.stringify(users));
        }

        function renderGitHubUsers() {
            const users = getGitHubAccessUsers();
            const listEl = document.getElementById('github-users-list');
            const emptyEl = document.getElementById('github-users-empty');

            if (!listEl) return;

            if (users.length === 0) {
                listEl.innerHTML = '';
                if (emptyEl) emptyEl.style.display = 'block';
                return;
            }

            if (emptyEl) emptyEl.style.display = 'none';

            listEl.innerHTML = users.map((user, idx) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #f1f5f9; ${user.status === 'blocked' ? 'background: #fef2f2;' : 'background: #f0fdf4;'}">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span class="material-symbols-rounded" style="color: ${user.status === 'blocked' ? '#ef4444' : '#22c55e'};">
                            ${user.status === 'blocked' ? 'block' : 'check_circle'}
                        </span>
                        <div>
                            <strong style="color: #1e293b;">${user.username}</strong>
                            <span style="font-size: 0.8rem; color: #64748b; margin-left: 0.5rem;">${user.status === 'blocked' ? 'Blocked' : 'Allowed'}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="toggleGitHubUserStatus(${idx})" style="padding: 0.4rem 0.75rem; border: 1px solid #cbd5e1; border-radius: 6px; background: white; cursor: pointer; font-size: 0.8rem; font-weight: 500;">
                            ${user.status === 'blocked' ? 'Allow' : 'Block'}
                        </button>
                        <button onclick="removeGitHubUser(${idx})" style="padding: 0.4rem 0.75rem; border: 1px solid #fca5a5; border-radius: 6px; background: #fee2e2; color: #ef4444; cursor: pointer; font-size: 0.8rem; font-weight: 500;">
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.handleGitHubAccess = function (action) {
            const input = document.getElementById('github-username-input');
            const username = input.value.trim();

            if (!username) {
                showToast('Please enter a username.', 'error');
                return;
            }

            const users = getGitHubAccessUsers();
            const existingIdx = users.findIndex(u => u.username.toLowerCase() === username.toLowerCase());

            if (existingIdx !== -1) {
                users[existingIdx].status = action === 'allow' ? 'allowed' : 'blocked';
                users[existingIdx].updatedAt = new Date().toISOString();
            } else {
                users.push({
                    username: username,
                    status: action === 'allow' ? 'allowed' : 'blocked',
                    addedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }

            saveGitHubAccessUsers(users);
            input.value = '';
            renderGitHubUsers();
            showToast(`User "${username}" ${action === 'allow' ? 'allowed' : 'blocked'} successfully.`, 'success');
        };

        window.toggleGitHubUserStatus = function (idx) {
            const users = getGitHubAccessUsers();
            if (users[idx]) {
                users[idx].status = users[idx].status === 'blocked' ? 'allowed' : 'blocked';
                users[idx].updatedAt = new Date().toISOString();
                saveGitHubAccessUsers(users);
                renderGitHubUsers();
            }
        };

        window.removeGitHubUser = function (idx) {
            const users = getGitHubAccessUsers();
            if (users[idx] && confirm(`Remove user "${users[idx].username}" from the access list?`)) {
                users.splice(idx, 1);
                saveGitHubAccessUsers(users);
                renderGitHubUsers();
                showToast('User removed.', 'info');
            }
        };

        // =============== Scientific Accuracy Checker ===============
        function populateScienceCheckSelect() {
            const select = document.getElementById('science-check-select');
            if (!select) return;

            const allItems = [
                ...(currentSubmissions.submissions || []),
                ...(currentSubmissions.approved || [])
            ];

            select.innerHTML = '<option value="">Select submission to check...</option>';
            allItems.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = `${item.title} (${item.status || 'pending'})`;
                select.appendChild(opt);
            });
        }

        window.runScienceCheck = function () {
            const select = document.getElementById('science-check-select');
            const resultsEl = document.getElementById('science-check-results');
            if (!select || !resultsEl) return;

            const submissionId = select.value;
            if (!submissionId) {
                showToast('Please select a submission to check.', 'error');
                return;
            }

            // Find the submission
            const allItems = [
                ...(currentSubmissions.submissions || []),
                ...(currentSubmissions.approved || [])
            ];
            const submission = allItems.find(s => s.id === submissionId);
            if (!submission || !submission.data) {
                showToast('Submission data not found.', 'error');
                return;
            }

            resultsEl.style.display = 'block';
            resultsEl.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; color: #7c3aed; margin-bottom: 1rem;">
                    <span class="material-symbols-rounded rotating">sync</span>
                    <span>Analysing scientific content...</span>
                </div>
            `;

            // Perform local heuristic-based accuracy check
            setTimeout(() => {
                const data = submission.data;
                const checks = [];
                let totalScore = 0;
                let totalChecks = 0;

                // Check 1: Title presence and quality
                if (data.title && data.title.length > 5) {
                    checks.push({ label: 'Title Quality', score: 100, detail: 'Title is present and descriptive.' });
                    totalScore += 100;
                } else {
                    checks.push({ label: 'Title Quality', score: 30, detail: 'Title is missing or too short.' });
                    totalScore += 30;
                }
                totalChecks++;

                // Check 2: Summary presence
                if (data.summary && data.summary.length > 20) {
                    checks.push({ label: 'Summary Quality', score: 100, detail: 'Summary is present and adequate.' });
                    totalScore += 100;
                } else {
                    checks.push({ label: 'Summary Quality', score: 40, detail: 'Summary is missing or inadequate.' });
                    totalScore += 40;
                }
                totalChecks++;

                // Check 3: Section count
                const sectionCount = (data.sections || []).length;
                if (sectionCount >= 5) {
                    checks.push({ label: 'Content Depth', score: 100, detail: `${sectionCount} sections provide good depth.` });
                    totalScore += 100;
                } else if (sectionCount >= 3) {
                    checks.push({ label: 'Content Depth', score: 70, detail: `${sectionCount} sections - adequate but could be deeper.` });
                    totalScore += 70;
                } else {
                    checks.push({ label: 'Content Depth', score: 30, detail: `Only ${sectionCount} sections - may lack depth.` });
                    totalScore += 30;
                }
                totalChecks++;

                // Check 4: Red flags / warnings present (good for medical content)
                const hasRedFlags = (data.sections || []).some(s => s.type === 'red_flag');
                if (hasRedFlags) {
                    checks.push({ label: 'Safety Warnings', score: 100, detail: 'Contains important red flag/safety warnings.' });
                    totalScore += 100;
                } else {
                    checks.push({ label: 'Safety Warnings', score: 50, detail: 'No red flag sections found - consider adding safety warnings.' });
                    totalScore += 50;
                }
                totalChecks++;

                // Check 5: Charts / data present
                const hasCharts = (data.sections || []).some(s => s.type === 'chart');
                if (hasCharts) {
                    checks.push({ label: 'Data Visualisation', score: 100, detail: 'Includes chart/data visualisation.' });
                    totalScore += 100;
                } else {
                    checks.push({ label: 'Data Visualisation', score: 60, detail: 'No charts found - data visualisation could strengthen content.' });
                    totalScore += 60;
                }
                totalChecks++;

                // Check 6: Medical terminology usage
                const allText = JSON.stringify(data).toLowerCase();
                const medicalTerms = ['diagnosis', 'treatment', 'prognosis', 'clinical', 'pathology', 'management', 'investigation', 'signs', 'symptoms', 'differential'];
                const foundTerms = medicalTerms.filter(t => allText.includes(t));
                const termScore = Math.min(100, (foundTerms.length / 4) * 100);
                checks.push({ label: 'Medical Terminology', score: Math.round(termScore), detail: `Found ${foundTerms.length}/${medicalTerms.length} key medical terms.` });
                totalScore += termScore;
                totalChecks++;

                // Check 7: References / evidence mention
                const hasReferences = allText.includes('reference') || allText.includes('study') || allText.includes('evidence') || allText.includes('trial') || allText.includes('guideline');
                if (hasReferences) {
                    checks.push({ label: 'Evidence Base', score: 90, detail: 'References to studies/evidence found.' });
                    totalScore += 90;
                } else {
                    checks.push({ label: 'Evidence Base', score: 40, detail: 'No references to evidence or studies detected.' });
                    totalScore += 40;
                }
                totalChecks++;

                const overallScore = Math.round(totalScore / totalChecks);
                const scoreColor = overallScore >= 80 ? '#22c55e' : overallScore >= 60 ? '#f59e0b' : '#ef4444';
                const scoreLabel = overallScore >= 80 ? 'High Accuracy' : overallScore >= 60 ? 'Moderate' : 'Needs Review';

                resultsEl.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem;">
                        <h3 style="margin: 0; color: #1e293b; font-size: 1.1rem;">
                            <span class="material-symbols-rounded" style="vertical-align: middle;">biotech</span>
                            ${submission.title}
                        </h3>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="background: ${scoreColor}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; font-size: 1.1rem;">
                                ${overallScore}%
                            </div>
                            <span style="font-weight: 600; color: ${scoreColor};">${scoreLabel}</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${checks.map(c => {
                            const barColor = c.score >= 80 ? '#22c55e' : c.score >= 60 ? '#f59e0b' : '#ef4444';
                            return `
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="min-width: 140px; font-weight: 500; color: #475569; font-size: 0.85rem;">${c.label}</span>
                                    <div style="flex: 1; background: #f1f5f9; border-radius: 4px; height: 8px; overflow: hidden;">
                                        <div style="width: ${c.score}%; background: ${barColor}; height: 100%; border-radius: 4px; transition: width 0.5s ease;"></div>
                                    </div>
                                    <span style="min-width: 40px; text-align: right; font-weight: 600; color: ${barColor}; font-size: 0.85rem;">${c.score}%</span>
                                </div>
                                <p style="margin: 0 0 0.25rem 0; padding-left: 140px; font-size: 0.8rem; color: #64748b;">${c.detail}</p>
                            `;
                        }).join('')}
                    </div>
                `;
            }, 1500);
        };

        // Show admin-only sections when verified
        function showAdminSections() {
            const githubSection = document.getElementById('github-access-section');
            const scienceSection = document.getElementById('science-checker-section');
            if (githubSection) githubSection.style.display = 'block';
            if (scienceSection) scienceSection.style.display = 'block';
            renderGitHubUsers();
            populateScienceCheckSelect();
        }

        // Override the verify button to also show admin sections
        const originalVerifyHandler = verifyBtn.onclick;
        verifyBtn.addEventListener('click', () => {
            if (isAdminVerified) {
                showAdminSections();
            }
        });

        renderSubmissions();
    </script>
</body>

</html>